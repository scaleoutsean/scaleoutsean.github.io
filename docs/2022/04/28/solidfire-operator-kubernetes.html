<!doctype html>
<html lang="en">
  <head>
        <meta charset="UTF-8">
    <meta http-equiv="content-language" content="en">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="googlebot" content="noarchive">
    <meta name="googlebot" content="max-snippet:60">
    <meta name="googlebot" content="max-image-preview:small">
    <meta name="bingbot" content="noarchive">
    <meta name="bingbot" content="max-snippet:60">
    <meta name="bingbot" content="max-image-preview:small">
    <meta name="robots" content="noarchive">
    <meta name="robots" content="max-snippet:60">
    <meta name="google-site-verification" content="F6q7vIwQ2G0j8tk-KL9rAXOMLXMDMMUkEz4fRs1Nnnc" />
    <title>
        
            SolidFire Operator for Kubernetes | Acting Technologist
      
    </title>
    <meta name="description" content="
     Build and use SolidFire Operator for Kubernetes to take full advantage of SolidFire features
     ">

    <!-- LINK TO ATOM FEED FOR SEO -->
    <link rel="alternate" type="application/atom+xml" href="https://scaleoutsean.github.io/feed.xml" />

    <!-- FAVICON -->
    <link rel="icon" href="/assets/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="/assets/favicon.ico" type="image/x-icon">

    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/syntax.css">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css">

    <link href="/_pagefind/pagefind-ui.css" rel="stylesheet">
    <script src="/_pagefind/pagefind-ui.js" type="text/javascript"></script>
    <div id="search"></div>
    <script src="https://cdn.counter.dev/script.js" data-id="83dc700a-b821-4e57-9425-02b8336a9456" data-utcoffset="0"></script>
    <script>
        window.addEventListener('DOMContentLoaded', (event) => {
            new PagefindUI({ element: "#search" });
        });
    </script>

    <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>SolidFire Operator for Kubernetes | Acting Technologist</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="SolidFire Operator for Kubernetes" />
<meta name="author" content="scaleoutSean" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Build and use SolidFire Operator for Kubernetes to take full advantage of SolidFire features" />
<meta property="og:description" content="Build and use SolidFire Operator for Kubernetes to take full advantage of SolidFire features" />
<link rel="canonical" href="https://scaleoutsean.github.io/2022/04/28/solidfire-operator-kubernetes.html" />
<meta property="og:url" content="https://scaleoutsean.github.io/2022/04/28/solidfire-operator-kubernetes.html" />
<meta property="og:site_name" content="Acting Technologist" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-04-28T00:00:00+08:00" />
<script type="application/ld+json">
{"headline":"SolidFire Operator for Kubernetes","dateModified":"2022-04-28T00:00:00+08:00","datePublished":"2022-04-28T00:00:00+08:00","author":{"@type":"Person","name":"scaleoutSean"},"@type":"BlogPosting","url":"https://scaleoutsean.github.io/2022/04/28/solidfire-operator-kubernetes.html","mainEntityOfPage":{"@type":"WebPage","@id":"https://scaleoutsean.github.io/2022/04/28/solidfire-operator-kubernetes.html"},"description":"Build and use SolidFire Operator for Kubernetes to take full advantage of SolidFire features","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  </head>

<body>

  <div class="container">
    <header id="header">
	<div id = site_title>
		<a href="https://scaleoutsean.github.io/">
			<h2 style="font-size:1.8em;">Acting Technologist</h2>
		</a>
		
		<h3>
			civilizations are created by individuals
		</h3>
		
	</div>

	<div id="subheader">
		
		<nav class="pages">
<a href="/about.html">About</a>

<a href="/archive.html">Archive</a>

<a href="/categories/">Categories</a>

<a href="/projects.html">Projects</a>
</nav>
		
		
		<nav class="social">
			
  
    <a href="https://www.github.com/scaleoutsean" target="_blank" id="github"><i class="fab fa-github" aria-hidden="true"></i></a>
  
   

  
    <a href="https://twitter.com/scaleoutsean" target="_blank" id="twitter"><i class="fab fa-twitter" aria-hidden="true"></i></a>
  
   

  
  
    <a href="/feed.xml" target="_blank" id="rss"><i class="fas fa-rss" aria-hidden="true"></i></a>
   

		</nav>
		
	</div>
</header>


    <div class="post-container">
      <article id = "post">
        <h1 id = "post-title">SolidFire Operator for Kubernetes</h1>

  
  <div class = "post-info">
    <span>
        <i class="far fa-calendar" aria-hidden="true"></i> <span>28 Apr 2022</span> - <i class="far fa-clock"></i> 


  
  
    7 minute read
  

    </span>
  </div>
  
        <p><a href="https://github.com/scaleoutsean/solidfire-operator">solidfire-operator</a> is a Proof-of-Concept operator for Kubernetes built using Operator Framework.</p>

<p>At the time of publishing this post, it doesn’t do anything useful. It can make changes to SolidFire QoS policies, which in all likelihood is completely useless for your Kubernetes environment.</p>

<p>If I find the concept useful I may add additional functionality, but the code is permissively licensed so anyone can fork the repo and expand its functionality to work with addditional SolidFire resources that are or aren’t supported by SolidFire modules for Ansible. Or build your own (the README has some detail around that).</p>

<p>What does solidfire-operator actually do?</p>

<p>It lets you use <code class="language-plaintext highlighter-rouge">kubectl</code> to make changes to SolidFire resources.</p>

<p>How does it work?</p>

<p>Kubernetes uses developer-provided code and custom resource definitions to make changes to resources. In this particular case and version, changes are made with Ansible and SolidFire Galaxy collection, and resources aren’t many (just the SolidFire QoS Policy object, in fact).</p>

<p>To create a new policy, we edit the sample config file and create a custom resource. Seconds later, a new QoS policy pops up in the SolidFire Web UI.</p>

<p><img src="/assets/images/solidfire-operator-01.png" alt="SolidFire Operator 0.0.4" /></p>

<p>Check the repo for additional details.</p>

<p>Why not do some volume-related stuff?</p>

<p>Trident CSI operates under the assumption it is the only program that manages Trident CSI<em>-managed</em> volumes. So it’s best to stay away from that.</p>

<p>There are plenty of other opportunities, though. Trident CSI v22.01 <em>only</em> manages manged SolidFire volumes and snapshots and nothing else.</p>

<p>There are Trident unmanaged volumes (SolidFire volumes we can import to Trident as unmanaged), as well as other CSI integrations such as <a href="/2022/03/02/openstack-solidfire-part-2.html">Cinder CSI</a> and Host Path volumes.</p>

<p>Some ideas for solidfire-operator:</p>

<ul>
  <li>Clone Trident volumes from Trident-made snapshots</li>
  <li>Snapshot and clone non-Trident volumes</li>
  <li>Snapshot &amp; <a href="/2022/01/19/solidfire-backup-restore-wasabi-s3.html">backup</a> SolidFire volumes to S3</li>
  <li>Apply QoS policies on Trident unmanaged volumes, or (this may interfere with Trident) apply and revert custom QoS policies on Trident-managed volumes</li>
  <li>Set up replication relationships</li>
  <li>Perform SolidFire cluster failover</li>
  <li>Configure SolidFire for better integrations with various Kubernetes applications</li>
</ul>

<p>One of the nice things about this approach - compared to running this from <a href="/2021/05/08/revisiting-solidbackup.html">scripts located in VMs or Docker</a> - is that this operator code can be deployed to Kubernetes in seconds and doesn’t require monitoring and maintenance of compute infrastructure outside of Kubernetes. As long as you backup (with Velero or whatever you use) your operator configuration or can deploy it from Git - there’s less to think about and less to manage.</p>

<h2 id="update-20220506">Update (2022/05/06)</h2>

<p>I spent almost two days in an attempt to replicate what I already did before and what took me a faction of the time in PowerShell - namely, apply a <a href="/2020/11/28/powershell-set-sfqosexception.html">temporary QoS policy on a SolidFire volume</a> and restore original QoS values and other attributes after that.</p>

<p>This reminds me that my earlier idea to explore non-Ansible operators was the right one. I’ve experimented with Shell Oprerator since writing this post, - it works, but it’s difficult to troubleshoot. But now I know - compared to Ansible, it’s very nice.</p>

<p>Here’s my reward for getting that Ansible playbook for QoS policy to work: unwanted KV pairs in volume attributes.</p>

<p><img src="/assets/images/solidfire-operator-02-ansible.png" alt="SolidFire Operator for QoS Exception Policy" /></p>

<p>The way that PowerShell module works is it restores whatever attributes the volume had before. Simple. In this case, it’s a Trident volume so it had some Trident attributes. But after spending almost two days on restoring them from Ansible, two junk KV pairs get injected into volume attributes by na_elementsw_volume module.</p>

<p>Now to get around that I’ll probably just use JSON RPC (<a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/uri_module.html">ansible.builtin.uri</a>) to get around that (assuming that module doesn’t inject own KV pairs, too).</p>

<p>Summary:</p>

<ul>
  <li>Using an operator like this (hopefully not Ansible-based), we can easily set a temporary (presumably, higher) QoS value on a volume, run a backup to S3 job, and then restore the original QoS value and attributes even if the volume in question is Trident-managed (usually volume attributes are empty)</li>
  <li>Trident &lt;= v22.04 can’t retype SolidFire volumes (OpenStack users can use Cinder CSI which can do that), so it’s unlikely that Trident’s volume attributes would change while Ansible playbook is running, but obviously if we used this approach we’d have to monitor changes in Trident releases to spot any risks and adjust the script or playbook if necessary</li>
  <li>In order to avoid failing to restore original volume attributes if Ansible script doesn’t complete, we’d have to persist original volume attributes to storage. What happens if a Trident-managed volume loses Trident-set volume attributes? I haven’t tried, but I’d say probably nothing. We could backup these attributes on a regular basis with a script (I recommend PowerShell or Python; both work well on Linux and Windows) if we were afraid of that, but I also believe - although I haven’t tried - that simply exporting and importing a Trident volume would result in latest Trident attributes being applied to it. So the risk of something going wrong is very small</li>
  <li>Another way to accomplish the same (set higher QoS, backup, set original QoS) would be to store original QoS in something like Sqlite or JSON file and not use volume attributes. But that’s not as elegant and adds complexity</li>
</ul>

<p>In order to build a complete backup workflow, I just need one more major task in this playbook - run async Backup to S3 job in between QoS set and QoS restore steps - but after this huge waste of time with Ansible, I don’t think I’ll try unless I have to. I’ll probably use some other approach - probably Shell Operator with PowerShell or Python.</p>

<p>Those who’d like to write their own, find the API example <a href="/2021/04/21/solidfire-backup-to-s3.html#backup-using-the-api-powershell-or-python">here</a> and rewrite it for Ansible to something like this (using static variables in vars).</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">vars</span><span class="pi">:</span>
    <span class="na">sf_url</span><span class="pi">:</span> <span class="s2">"</span><span class="s">https://192.168.1.30/json-rpc/12.0"</span>
    <span class="na">sf_elementsw_username</span><span class="pi">:</span> <span class="s2">"</span><span class="s">backup-operator"</span> <span class="c1"># Dedicated Cluster Admin account</span>
    <span class="na">sf_elementsw_password</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
    <span class="na">vol_name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">pvc-1something-2something"</span>
    <span class="na">vol_id</span><span class="pi">:</span> <span class="m">604</span>             <span class="c1"># Don't hard-code this obviously, you probablyl want to loop through a list</span>
    <span class="na">vol_sz_blocks</span><span class="pi">:</span> <span class="m">1220864</span>  <span class="c1"># =TotalVolumeSizeBytes/4096; get volume attributs and do the math on the fly</span>
    <span class="na">s3_access_key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">BBB"</span>    <span class="c1"># Store access and secret key in K8s secrets</span>
    <span class="na">s3_secret_key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">CCC"</span>
    <span class="na">s3_bucket</span><span class="pi">:</span> <span class="s2">"</span><span class="s">solidfire-native-backup"</span> <span class="c1"># Your S3 bucket</span>
    <span class="na">s3_prefix</span><span class="pi">:</span> <span class="s2">"</span><span class="s">PROD-mn4y/pvc-1something-2something-604"</span> <span class="c1"># How to get this? See the post linked just above</span>
    <span class="na">s3_endpoint</span><span class="pi">:</span> <span class="s2">"</span><span class="s">s3.com.org"</span>

<span class="na">tasks</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Backup volume to S3</span>
      <span class="s">ansible.builtin.uri</span><span class="pi">:</span>
        <span class="na">url</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
        <span class="na">method</span><span class="pi">:</span> <span class="s">POST</span>
        <span class="na">validate_certs</span><span class="pi">:</span> <span class="s">False</span>
        <span class="na">force_basic_auth</span><span class="pi">:</span> <span class="s">True</span>
        <span class="na">user</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
        <span class="na">body</span><span class="pi">:</span> <span class="s1">'</span><span class="s">body:</span><span class="nv"> </span><span class="s">{"method":</span><span class="nv"> </span><span class="s">"StartBulkVolumeRead","params":</span><span class="nv"> </span><span class="s">{"volumeID":</span><span class="nv"> </span><span class="s">"","format":</span><span class="nv"> </span><span class="s">"native","script":</span><span class="nv"> </span><span class="s">"bv_internal.py","scriptParameters":</span><span class="nv"> </span><span class="s">{"range":</span><span class="nv"> </span><span class="s">{"lba":0,"blocks":""},"write":</span><span class="nv"> </span><span class="s">{"awsAccessKeyID":"","awsSecretAccessKey":"","bucket":</span><span class="nv"> </span><span class="s">"","prefix":</span><span class="nv"> </span><span class="s">"","endpoint":</span><span class="nv"> </span><span class="s">"s3","hostname":""}}}}'</span>
        <span class="na">status_code</span><span class="pi">:</span> <span class="m">200</span>
        <span class="na">body_format</span><span class="pi">:</span> <span class="s">json</span>
        <span class="na">return_content</span><span class="pi">:</span> <span class="s">yes</span>
      <span class="na">register</span><span class="pi">:</span> <span class="s">result</span>
</code></pre></div></div>

<p>Yes, it’s not pretty. Use Jinja2 templates to make this nicer, if you care.</p>

<p>The above tasks returned this:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
  </span><span class="nl">"result"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"asyncHandle"</span><span class="p">:</span><span class="w"> </span><span class="mi">1012</span><span class="p">,</span><span class="w">
    </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"d977d846f98d61730bb4495455d0ea71"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://192.168.103.29:8443/"</span><span class="w">
  </span><span class="p">}</span><span class="w">  
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>This means backup job has started (and may or may not succeed). Next we could poll this async handle and get an estimate of how long we should wait before reverting QoS and volume attributes to original values. For details, see the <a href="/2021/04/21/solidfire-backup-to-s3.html#backup-using-the-api-powershell-or-python">mega post on SolidFire’s Backup to S3 feature</a>.</p>

<p>If we want to make this simpler, we could simply create a sleep task. Or - slightly smarter - divide the volume size by average backup speed you get, so that this task sleeps longer for larger volumes. Or create a while loop to check if backup manifest was written to S3 i.e. if backup was successful, and time out if nothing gets detected after two-three hours.</p>

<p>The example task above worked:</p>

<p><img src="/assets/images/solidfire-operator-03-ansible-backup-to-s3.png" alt="SolidFire Operator - Ansible-driven backup task" /></p>

<p>Destination bucket:</p>

<p><img src="/assets/images/solidfire-operator-04-s3-bucket.png" alt="SolidFire Operator - volume backup" /></p>

<p>If you’re hell-bent on doing this in Ansible I’d recommend doing everything in <code class="language-plaintext highlighter-rouge">ansible.builtin.uri</code> module, or using <code class="language-plaintext highlighter-rouge">ansible.builtin.shell</code>, where we can write proper Python.</p>

<p>As mentioned in task comments above, you’d probably want something like a list of volumes and most values could be obtained on the fly, via another URI task (method: ListVolumes). Note that ListVolumes has two options: volumeIDs (listOfIDs) and volumeName (string). Because volumeName isn’t necessarily unique, this may be another reason to use URI (or own script) with volumeIDs rather than rely on uniqueness of volume names.</p>

<p>Volume names can be mapped to IDs many ways. Some examples:</p>

<ul>
  <li>get it from Kubernetes CLI (by filtering PVCs for SolidFire Storage Classes)</li>
  <li>get volume IDs the (tenant) account ID used by particular Trident instance (method: ListVolumesForAccount)</li>
  <li>get it from backup application (let’s say you use Velero as your main backup tool that automatically picks Trident/SoliFire PVCs that need to be backed up, and Backup to S3 is a separate weekly job to Object Store with <a href="/2022/05/06/solidire-backup-to-s3-with-object-lock.html">Object Lock enabled</a>)</li>
</ul>

      </article>
    </div>
    
      <div class="categories">
    <span><p>Categories:</p>
    
    
      <a href="
      /categories/#automation">automation</a>
      &nbsp; 
    
      <a href="
      /categories/#storage">storage</a>
      &nbsp; 
    
      <a href="
      /categories/#containers">containers</a>
       
    
  </span>
</div>
    

  
    <div>
      <h3>Related Posts</h3>
      <ul>
      
        <li><a href="/2022/02/14/middle-class-rbac-solidfire-ansible.html">SolidFire RBAC workflow with Ansible</a></li>
      
        <li><a href="/2022/01/01/getting-solidfire-volume-details-python-powershell-api-cli.html">Getting SolidFire volume details with Powershell and Python</a></li>
      
        <li><a href="/2020/12/19/solidfire-powershell-python-cli-sdk-1.7.html">SolidFire PowerShell Tools, Python CLI and SDK pip packages v1.7</a></li>
      
        <li><a href="/2022/01/31/configure-snmpv2-on-solidfire-ansible.html">Configure SNMP on SolidFire cluster using Ansible</a></li>
      
        <li><a href="/2024/05/04/netapp-solidfire-with-async-http.html">Access NetApp SolidFire API with Async IO</a></li>
      
      </ul>
    </div>
  

    
  </div><footer class= "footer">
    <p>2024-06-16 14:41 </p>
    <p>Copyright © 2024 scaleoutSean. Content is released under the CC BY license. Design: Alessio Franceschi</p>
</footer>

</body>
</html>
