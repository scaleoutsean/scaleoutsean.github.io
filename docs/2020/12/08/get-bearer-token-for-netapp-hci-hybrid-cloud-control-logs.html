<!doctype html>
<html lang="en">
  <head>
        <meta charset="UTF-8">
    <meta http-equiv="content-language" content="en">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="googlebot" content="noarchive">
    <meta name="googlebot" content="max-snippet:60">
    <meta name="googlebot" content="max-image-preview:small">
    <meta name="bingbot" content="noarchive">
    <meta name="bingbot" content="max-snippet:60">
    <meta name="bingbot" content="max-image-preview:small">
    <meta name="robots" content="noarchive">
    <meta name="robots" content="max-snippet:60">
    <meta name="google-site-verification" content="F6q7vIwQ2G0j8tk-KL9rAXOMLXMDMMUkEz4fRs1Nnnc" />
    <title>
        
            Get NetApp Hybrid Cloud Control logs via the HCC API | Acting Technologist
      
    </title>
    <meta name="description" content="
     Use NetApp mNode API to get HCC Docker logs
     ">

    <!-- LINK TO ATOM FEED FOR SEO -->
    <link rel="alternate" type="application/atom+xml" href="https://scaleoutsean.github.io/feed.xml" />

    <!-- FAVICON -->
    <link rel="icon" href="/assets/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="/assets/favicon.ico" type="image/x-icon">

    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/syntax.css">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css">

    <link href="/_pagefind/pagefind-ui.css" rel="stylesheet">
    <script src="/_pagefind/pagefind-ui.js" type="text/javascript"></script>
    <div id="search"></div>
    <script src="https://cdn.counter.dev/script.js" data-id="83dc700a-b821-4e57-9425-02b8336a9456" data-utcoffset="0"></script>
    <script>
        window.addEventListener('DOMContentLoaded', (event) => {
            new PagefindUI({ element: "#search" });
        });
    </script>

    <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Get NetApp Hybrid Cloud Control logs via the HCC API | Acting Technologist</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Get NetApp Hybrid Cloud Control logs via the HCC API" />
<meta name="author" content="scaleoutSean" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Use NetApp mNode API to get HCC Docker logs" />
<meta property="og:description" content="Use NetApp mNode API to get HCC Docker logs" />
<link rel="canonical" href="https://scaleoutsean.github.io/2020/12/08/get-bearer-token-for-netapp-hci-hybrid-cloud-control-logs.html" />
<meta property="og:url" content="https://scaleoutsean.github.io/2020/12/08/get-bearer-token-for-netapp-hci-hybrid-cloud-control-logs.html" />
<meta property="og:site_name" content="Acting Technologist" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-12-08T00:00:00+08:00" />
<script type="application/ld+json">
{"headline":"Get NetApp Hybrid Cloud Control logs via the HCC API","dateModified":"2020-12-08T00:00:00+08:00","datePublished":"2020-12-08T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://scaleoutsean.github.io/2020/12/08/get-bearer-token-for-netapp-hci-hybrid-cloud-control-logs.html"},"author":{"@type":"Person","name":"scaleoutSean"},"@type":"BlogPosting","url":"https://scaleoutsean.github.io/2020/12/08/get-bearer-token-for-netapp-hci-hybrid-cloud-control-logs.html","description":"Use NetApp mNode API to get HCC Docker logs","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  </head>

<body>

  <div class="container">
    <header id="header">
	<div id = site_title>
		<a href="https://scaleoutsean.github.io/">
			<h2 style="font-size:1.8em;">Acting Technologist</h2>
		</a>
		
		<h3>
			civilizations are created by individuals
		</h3>
		
	</div>

	<div id="subheader">
		
		<nav class="pages">
<a href="/about.html">About</a>

<a href="/archive.html">Archive</a>

<a href="/categories/">Categories</a>

<a href="/projects.html">Projects</a>
</nav>
		
		
		<nav class="social">
			
  
    <a href="https://www.github.com/scaleoutsean" target="_blank" id="github"><i class="fab fa-github" aria-hidden="true"></i></a>
  
   

  
    <a href="https://twitter.com/scaleoutsean" target="_blank" id="twitter"><i class="fab fa-twitter" aria-hidden="true"></i></a>
  
   

  
  
    <a href="/feed.xml" target="_blank" id="rss"><i class="fas fa-rss" aria-hidden="true"></i></a>
   

		</nav>
		
	</div>
</header>


    <div class="post-container">
      <article id = "post">
        <h1 id = "post-title">Get NetApp Hybrid Cloud Control logs via the HCC API</h1>

  
  <div class = "post-info">
    <span>
        <i class="far fa-calendar" aria-hidden="true"></i> <span>08 Dec 2020</span> - <i class="far fa-clock"></i> 


  
  
    10 minute read
  

    </span>
  </div>
  
        <p>Hybrid Cloud Control (HCC) is a group of services - management plane, if you will - for out-of-band management of NetApp HCI, SolidFire and eSDS. Currently it’s a bunch of containers that runs in a VM commonly called mNode (short for Management Node).</p>

<p><strong>NOTICE</strong>: all credentials and tokens on this page are samples, not leaked.</p>

<p>As noted in last week’s <a href="https://scaleoutsean.github.io/2020/11/27/solidfire-mnode-hcc-log-forwarding.html">post on HCC and mNode log forwarding</a> (you may want to read it if you want additional context), right now we can’t forward Docker container logs to external destination (not in a supported way). We need to use the HCC API to get container logs of interest.</p>

<h3 id="get-logs"><code class="language-plaintext highlighter-rouge">GET /logs</code></h3>

<p>After everything else has failed, we have to read the manual. Relevant section of the HCC API, in the case you haven’t looked:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">    </span><span class="nl">"/logs"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"get"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"The logs endpoint is used to get logs from the services."</span><span class="p">,</span><span class="w">
        </span><span class="nl">"operationId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"routes.v1.log_api.get_logs"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Number of lines to retrieve from the logs."</span><span class="p">,</span><span class="w">
            </span><span class="nl">"in"</span><span class="p">:</span><span class="w"> </span><span class="s2">"query"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"lines"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"schema"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w">
              </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"integer"</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Name of the service"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"in"</span><span class="p">:</span><span class="w"> </span><span class="s2">"query"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"service-name"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"schema"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
              </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Type of logs to retrieve"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"in"</span><span class="p">:</span><span class="w"> </span><span class="s2">"query"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"type"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"schema"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="s2">"service"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"enum"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="s2">"syslog"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"service"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"all"</span><span class="w">
              </span><span class="p">],</span><span class="w">
              </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ISO-8601 timestamp for the service logs starting point. Example: '2019-04-01T18:34:36Z'."</span><span class="p">,</span><span class="w">
            </span><span class="nl">"in"</span><span class="p">:</span><span class="w"> </span><span class="s2">"query"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"since"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"schema"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"format"</span><span class="p">:</span><span class="w"> </span><span class="s2">"date-time"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Get archived logs"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"in"</span><span class="p">:</span><span class="w"> </span><span class="s2">"query"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"archived"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"schema"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"boolean"</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ISO-8601 timestamp for the service logs ending point. Example: '2019-04-01T18:34:36Z'."</span><span class="p">,</span><span class="w">
            </span><span class="nl">"in"</span><span class="p">:</span><span class="w"> </span><span class="s2">"query"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"until"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"schema"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"format"</span><span class="p">:</span><span class="w"> </span><span class="s2">"date-time"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="nl">"responses"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"200"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"OK"</span><span class="w">
          </span><span class="p">},</span><span class="w">
          </span><span class="nl">"400"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Bad Request"</span><span class="w">
          </span><span class="p">},</span><span class="w">
          </span><span class="nl">"401"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Unauthorized"</span><span class="w">
          </span><span class="p">},</span><span class="w">
          </span><span class="nl">"404"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Not Found"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"security"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">"elementOAuth"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
              </span><span class="s2">"mnode_api:r"</span><span class="w">
            </span><span class="p">]</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="nl">"summary"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Get logs from the MNODE service(s)"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="s2">"logs"</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="nl">"x-operationAlias"</span><span class="p">:</span><span class="w"> </span><span class="s2">"getLogs"</span><span class="w">
      </span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Considering a shortage of useful examples and so on, let’s try to figure out some key elements required to <code class="language-plaintext highlighter-rouge">GET \logs</code>.</p>

<h4 id="service-name-parameter"><code class="language-plaintext highlighter-rouge">service-name</code> parameter</h4>

<p>This isn’t really a service name (<code class="language-plaintext highlighter-rouge">api-gateway</code>, for example) but a <em>container</em> name. You can find a list of service names and what they do in <a href="https://kb.netapp.com/Advice_and_Troubleshooting/Data_Storage_Software/Management_services_for_Element_Software_and_NetApp_HCI/NetApp_Hybrid_Cloud_Control_and_Management_Services_2.16.66_Release_Notes">this KB</a> (NetApp support login required).</p>

<p>So this works: <code class="language-plaintext highlighter-rouge">https://192.168.1.31/mnode/1/logs?lines=1000&amp;service-name=mnode_package-svc&amp;type=service</code> (assuming you provide a valid bearer token.)</p>

<p>How to get the current service names? You can get a list of running container ID’s and names like this:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>docker ps <span class="nt">-a</span> <span class="nt">--filter</span> <span class="s2">"name=mnode_"</span> <span class="nt">--format</span> <span class="s2">"{{.ID}}: {{.Names}}"</span>
5e69af253a54: mnode_api-gateway.1.gking7pxr280mpd97d1ho2z85
c03dd36c2f12: mnode_hcc-ui.1.xsjwurknk41fvz4mwuec9844b
f14f10d6aefc: mnode_credential-svc.1.mb6hurx981ux2uetw2kb6wpn8
594e68dd176a: mnode_vcp-sioc.1.nlfew38hf0mutxireo0j6krpy
40b265534b5b: mnode_mongo.1.b6n0ip292qecd5idbcrwtwecp
b477504551ab: mnode_simple-data.1.19kjp226v2g3mp9y9410kyylj
42d366150c41: mnode_logs-svc.1.nxk8szxmjuuiyo30frxdltcel
f3ae48980a8e: mnode_hci-monitor.1.q42vviwgeqqaj23t3y3dh8ooi
8370e40d5ce0: mnode_mnode.1.rkmcgus7u8jzck3z6n69okabc
a9779bacaed1: mnode_mnode-svc-mon-grafana.1.p73z9grq4tbz84t4d8rdr2x96
51aaf81afce8: mnode_package-svc.1.n7e5ndta6akh1t9hqfllvfnok
92389db81077: mnode_hardware-svc.1.yzyw30yvsba4ywd7p2xeucq4x
bd4c6c272e6c: mnode_vcenter-v2-svc.1.wje41fmyhqtl6f25buwtfg6u3
f2a797aec34b: mnode_telemetry-service.1.tilwniy8w8nkhjhvgl7g6nz39
3bc90001c4de: mnode_api-gateway.1.xi5u8115tgw5y7j0pit3x2tn6
a6be445b120f: mnode_storage.1.v8017p8fsaofak8qn55g4thzq
e6b29160dd47: mnode_authz.1.9osgex2wakazo45t2bn9ccehv
35fccce185ab: mnode_inventory-service.1.1ykva88x9ygxk17ps8osvj3sc
f51e30b65600: mnode_mnode-svc-mon-prometheus.1.3uepjf4y6phfqbddvqzqn48pt
47662ca5154c: mnode_docker-proxy.1.rojuy25wqsixi1por12bvbg4d
517988746c82: mnode_mnode-svc-task-monitor.1.spjfcfo9p7cw20xdon8ddctd1
279299b1b47c: mnode_k8sdeployer.1.u6ley1mwon00082gv043epvmp
4b3463ade720: mnode_mnode-svc-aiq-collector.1.phxf6mixikog3n8shdofs9rvu
5e867cd32344: mnode_api-gateway.1.vve7oqygsxxdyz9t2jzo3xkm8
44f1d9e0510e: mnode_package-svc.1.4bg9t4ixe9qcczhkj3gdyb1ns
3a131d10f24a: mnode_mnode-svc-task-monitor.1.t7eaenozg7f85ycf6p7q34hrs
0a774564d471: mnode_inventory-service.1.rxsoxf1ymab2joqzcswe4po84
47aa11911914: mnode_mnode.1.ntp7ygkt9jyd1wwb0w9tuo2sw
31871c6bf038: mnode_hardware-svc.1.2wzgnufu44qqinoy7qd9skcbj
</code></pre></div></div>

<p>I was surprised to discover that filtering for <code class="language-plaintext highlighter-rouge">exited=0</code> didn’t filter out exited containers (<code class="language-plaintext highlighter-rouge">docker ps --filter 'status=running'</code> shows only running containers, so there’s that.)</p>

<p>If your mNode is called <code class="language-plaintext highlighter-rouge">mnode</code> then “service” names would be <code class="language-plaintext highlighter-rouge">mNode_$SERVICE_NAME</code> where $SERVICE_NAME is a list of (actual) service names you care about. Once you have mNode name and that list, you can get loop through it and get Container IDs which can be use to get the logs.</p>

<p>You want to loop through the list because otherwise you get all the container logs at the same time, which seems like a bad idea to me.</p>

<p>What to do about the logs of exited containers? We could get those as well, or we could watch Docker service and write a handler for those situations (for example, fetch and forward their log, and then remove the exited container so that we don’t have to deal with exited containers.)</p>

<h4 id="type-parameter"><code class="language-plaintext highlighter-rouge">type</code> parameter</h4>

<p>If you plan to use rsyslog to forward system logs, then here you’d only specify <code class="language-plaintext highlighter-rouge">service</code> logs.</p>

<h4 id="since-parameter"><code class="language-plaintext highlighter-rouge">since</code> parameter</h4>

<p>The good news is this works the same as <code class="language-plaintext highlighter-rouge">--since</code> in Docker, so everyone gets it.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>docker logs <span class="nt">--since</span> 10m 5e69af253a54
10.0.0.23 - - <span class="o">[</span>08/Dec/2020:04:29:59 +0000] <span class="s2">"GET /metrics HTTP/1.1"</span> 200 2412 <span class="s2">"-"</span> <span class="s2">"Prometheus/2.17.1"</span>
10.0.0.23 - - <span class="o">[</span>08/Dec/2020:04:30:09 +0000] <span class="s2">"GET /metrics HTTP/1.1"</span> 200 2412 <span class="s2">"-"</span> <span class="s2">"Prometheus/2.17.1"</span>
10.0.0.23 - - <span class="o">[</span>08/Dec/2020:04:31:59 +0000] <span class="s2">"GET /metrics HTTP/1.1"</span> 200 2412 <span class="s2">"-"</span> <span class="s2">"Prometheus/2.17.1"</span>
<span class="o">[</span>pid: 563|app: 0|req: 2028/5510] 127.0.0.1 <span class="o">()</span> <span class="o">{</span>34 vars <span class="k">in </span>1272 bytes<span class="o">}</span> <span class="o">[</span>Tue Dec  8 04:32:01 2020] GET /access <span class="o">=&gt;</span> generated 0 bytes <span class="k">in </span>9 msecs <span class="o">(</span>HTTP/1.1 204<span class="o">)</span> 1 headers <span class="k">in </span>59 bytes <span class="o">(</span>0 switches on core 0<span class="o">)</span>
GW-PROXY: 10.0.0.23 - - <span class="o">[</span>08/Dec/2020:04:32:01 +0000] <span class="s2">"GET /about HTTP/1.1"</span> 200 72 <span class="s2">"-"</span> <span class="s2">"python-requests/2.23.0"</span> <span class="s2">"-"</span> <span class="nv">rid</span><span class="o">=</span><span class="s2">"6d86b2d6e18c69ae442e0c6b91568310"</span> <span class="nv">urt</span><span class="o">=</span><span class="s2">"-"</span>
</code></pre></div></div>

<p>We can run our collector every 5 minutes and collect logs for the previous 6 minutes.</p>

<p>The bad news is the API won’t do this for us: we have to get the current UTC time in the ISO-8601 format, deduct our <code class="language-plaintext highlighter-rouge">--since</code> value (10 minutes) and use that cut-off value in our API call. You could get all the available logs every time, but if you poll periodically for monitoring or compliance, you probably don’t want to do that.</p>

<h4 id="archived-parameter"><code class="language-plaintext highlighter-rouge">archived</code> parameter</h4>

<p>If mNode or vSphere suffers unplanned (i.e. there are logs that we may have missed to fetch) downtime, we can manually write a script with <code class="language-plaintext highlighter-rouge">archived=true</code> and with a <code class="language-plaintext highlighter-rouge">since</code> value that reflects time since last downtime minus our gathering interval (for example, 5 minutes).</p>

<h3 id="next-steps">Next steps</h3>

<p>Now that we know what we’re after, we could first write a log-polling script and later take a look at how to handle edge cases such as unplanned downtime.</p>

<p>The annoying part is dealing with <a href="https://docs.netapp.com/us-en/hci/docs/task_mnode_api_get_authorizationtouse.html">authorization</a> and refreshing the bearer token, so I’m still looking at other ways (in addition to what was discussed in the HCC and mNode log forwarding post.)</p>

<p>Alternatives to using the API:</p>

<ul>
  <li>Run Docker logs commands remotely (from a dedicated VM with Filebeat, for example)</li>
  <li>Run Docker shell commands locally (in mNode VM, mentioned last week) and send the logs to external destination</li>
</ul>

<p>Both of these approaches eliminate the need to work with the HCC API as you can simply use Docker commands and pipe output to an external destination, and they can be more reliable given the same amount spent on coding a script to gather them. But I’m not sure if running own programs on mNode would be supported (I suspect yes because these approaches don’t install any containers and don’t use significant resources.)</p>

<h4 id="example-with-docker-logs-command-executed-remotely">Example with Docker logs command executed remotely</h4>

<p>mNode’s Docker doesn’t listen on network. But with <code class="language-plaintext highlighter-rouge">docker context create</code> (on our client) we can get to the container logs remotely. First we set up password-less SSH to mNode (192.168.1.31) and then create a Docker context. Then on mNode we add the administrator user to Docker group (<code class="language-plaintext highlighter-rouge">sudo usermod -aG docker admin</code>). With that we can run the same command that we used locally, on our client, to get the last 10 minutes of a container’s logs.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="c"># mNode = 192.168.1.31</span>
<span class="nv">$ </span><span class="c"># ssh admin@192.168.1.31 -i ~/.ssh/id_rsa.pub # passwordless SSH to mNode from external client should work</span>
<span class="nv">$ </span>docker context create mnode <span class="nt">--docker</span> <span class="s2">"host=ssh://admin@192.168.1.31:22"</span>
<span class="nv">$ </span>docker <span class="nt">-H</span> ssh://admin@192.168.1.31 logs <span class="nt">--since</span> 10m 5e69af253a54
</code></pre></div></div>

<h4 id="obtaining-mnode-bearer-token-with-curl-python-and-powershell">Obtaining mNode Bearer Token with curl, Python and PowerShell</h4>

<p>As we access Swagger we have to authenticate to obtain authorization in this modal:</p>

<p><img src="/assets/images/hcc-api-bearer-authorization.png" alt="NetApp HCC mNode Swager Authentication and Authorization" /></p>

<p>It’s confusing what exactly needs to be entered here, but for what it’s worth it’s documented <a href="https://docs.netapp.com/us-en/hci/docs/task_mnode_api_get_authorizationtouse.html">here</a>.</p>

<pre><code class="language-raw">Token URL: /token
Flow: password
username: admin                    # SolidFire cluster admin account
password: ******                   # Password for SF cluster admin account
Client credentials location: basic # meaning: Authorization header
client_id: ******                  # currently fixed to: mnode-client
client_secret: ******              # leave empty
</code></pre>

<p>The URL isn’t clearly documented as well (but there’s that <code class="language-plaintext highlighter-rouge">/token</code> in the modal above) so we can at least make educated guesses.</p>

<p>Request to get bearer token from mNode 2.16 (latest as of now) located at 192.168.1.31, with SolidFire cluster administrator credentials “admin:admin”.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">--location</span> <span class="nt">--request</span> POST <span class="s1">'https://192.168.1.31/token'</span> <span class="se">\</span>
<span class="nt">--form</span> <span class="s1">'client_id="mnode-client"'</span> <span class="se">\</span>
<span class="nt">--form</span> <span class="s1">'username="admin"'</span> <span class="se">\</span>
<span class="nt">--form</span> <span class="s1">'password="admin"'</span> <span class="se">\</span>
<span class="nt">--form</span> <span class="s1">'grant_type="password"'</span>
</code></pre></div></div>

<p>Response:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"access_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJuYmYiOjE2MDc0MTAwMTEsImV4cCI6MTYwNzQxMDYxMSwiaXNzIjoiaHR0cHM6Ly8xOTIuMTY4LjEuMzEvYXV0aCIsImF1ZCI6WyJtbm9kZV9hcGkiLCJtbm9kZV91cGdyYWRlX29yY2hlc3RyYXRvciIsInRhc2tfbW9uaXRvciJdLCJjbGllbnRfaWQiOiJtbm9kZS1jbGllbnQiLCJzdWIiOiJhZG1pbiIsImF1dGhfdGltZSI6MTYwNzQxMDAxMSwiaWRwIjoibG9jYWwiLCJwcmVmZXJyZWRfdXNlcm5hbWUiOiJhZG1pbiIsImlhdCI6MTYwNzQxMDAxMSwianRpIjoiNlRwYlZwWDR1VmxtQWRyRW9TUXUtUSIsInNjb3BlIjpbIm1ub2RlX2FwaTpyIiwibW5vZGVfYXBpOnciLCJtbm9kZV91cGdyYWRlX29yY2hlc3RyYXRvcjpyIiwibW5vZGVfdXBncmFkZV9vcmNoZXN0cmF0b3I6dyIsInRtOmQiLCJ0bTpyIiwidG06dyJdLCJhbXIiOlsiQ2x1c3RlciJdLCJuZXRhcHBfYWNjZXNzIjpbImFkbWluaXN0cmF0b3IiXX0.6CeUa7-xjwW3RET0-Zt1uzgFNuEYQA5b5fH23YZhQpDY7yz3ADkMtdN_GM9HX17C0UNCGueIrDcv_zF3Hp0EkoTRwAvnROeD7_ejkH-EILEAithEC52d8v0QVJm59mxAvYCW3XCsf7q-jADqrDt-y6X4av0CDk8xwM_LUTuo9Eq_yUMPXjMJRKVECxuggCxFm8RM4dWmq1Hh1tpwt-oiytg-I1jTUbTDfwnmXhCtjoxxK7eWmfJfWoxXHyoR7zFw8lvdOkfTblcQiOuFacrgUabLkVhwimVTju2Dx8lcn0sNDdMS1SMKs9hP_MudXBIAweFbrwoj3hNgQsg05egw8A"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"expires_in"</span><span class="p">:</span><span class="w"> </span><span class="mi">600</span><span class="p">,</span><span class="w">
    </span><span class="nl">"token_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Bearer"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"scope"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mnode_api:r mnode_api:w mnode_upgrade_orchestrator:r mnode_upgrade_orchestrator:w tm:d tm:r tm:w"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>We can likely get away with only <code class="language-plaintext highlighter-rouge">mnode_api:r</code> and <code class="language-plaintext highlighter-rouge">mnode_api:w</code> (we won’t be upgrading HCI firmware or anything like that), but the online (Swagger) API docs aren’t very clear on that so let’s just ignore this.</p>

<p>curl translated into Python 3:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">requests</span>

<span class="n">url</span> <span class="o">=</span> <span class="s">"https://192.168.1.31/token"</span>

<span class="n">payload</span><span class="o">=</span><span class="p">{</span><span class="s">'client_id'</span><span class="p">:</span> <span class="s">'mnode-client'</span><span class="p">,</span>
<span class="s">'username'</span><span class="p">:</span> <span class="s">'admin'</span><span class="p">,</span>
<span class="s">'password'</span><span class="p">:</span> <span class="s">'admin'</span><span class="p">,</span>
<span class="s">'grant_type'</span><span class="p">:</span> <span class="s">'password'</span><span class="p">}</span>
<span class="n">files</span><span class="o">=</span><span class="p">[</span>

<span class="p">]</span>
<span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">request</span><span class="p">(</span><span class="s">"POST"</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
</code></pre></div></div>

<p>And into PowerShell:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$multipartContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Net.Http.MultipartFormDataContent</span><span class="p">]::</span><span class="n">new</span><span class="p">()</span><span class="w">
</span><span class="nv">$stringHeader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Net.Http.Headers.ContentDispositionHeaderValue</span><span class="p">]::</span><span class="n">new</span><span class="p">(</span><span class="s2">"form-data"</span><span class="p">)</span><span class="w">
</span><span class="nv">$stringHeader</span><span class="o">.</span><span class="nf">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"client_id"</span><span class="w">
</span><span class="nv">$StringContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Net.Http.StringContent</span><span class="p">]::</span><span class="n">new</span><span class="p">(</span><span class="s2">"mnode-client"</span><span class="p">)</span><span class="w">
</span><span class="nv">$StringContent</span><span class="o">.</span><span class="nf">Headers</span><span class="o">.</span><span class="nf">ContentDisposition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$stringHeader</span><span class="w">
</span><span class="nv">$multipartContent</span><span class="o">.</span><span class="nf">Add</span><span class="p">(</span><span class="nv">$stringContent</span><span class="p">)</span><span class="w">

</span><span class="nv">$stringHeader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Net.Http.Headers.ContentDispositionHeaderValue</span><span class="p">]::</span><span class="n">new</span><span class="p">(</span><span class="s2">"form-data"</span><span class="p">)</span><span class="w">
</span><span class="nv">$stringHeader</span><span class="o">.</span><span class="nf">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"username"</span><span class="w">
</span><span class="nv">$StringContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Net.Http.StringContent</span><span class="p">]::</span><span class="n">new</span><span class="p">(</span><span class="s2">"admin"</span><span class="p">)</span><span class="w">
</span><span class="nv">$StringContent</span><span class="o">.</span><span class="nf">Headers</span><span class="o">.</span><span class="nf">ContentDisposition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$stringHeader</span><span class="w">
</span><span class="nv">$multipartContent</span><span class="o">.</span><span class="nf">Add</span><span class="p">(</span><span class="nv">$stringContent</span><span class="p">)</span><span class="w">

</span><span class="nv">$stringHeader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Net.Http.Headers.ContentDispositionHeaderValue</span><span class="p">]::</span><span class="n">new</span><span class="p">(</span><span class="s2">"form-data"</span><span class="p">)</span><span class="w">
</span><span class="nv">$stringHeader</span><span class="o">.</span><span class="nf">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"password"</span><span class="w">
</span><span class="nv">$StringContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Net.Http.StringContent</span><span class="p">]::</span><span class="n">new</span><span class="p">(</span><span class="s2">"admin"</span><span class="p">)</span><span class="w">
</span><span class="nv">$StringContent</span><span class="o">.</span><span class="nf">Headers</span><span class="o">.</span><span class="nf">ContentDisposition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$stringHeader</span><span class="w">
</span><span class="nv">$multipartContent</span><span class="o">.</span><span class="nf">Add</span><span class="p">(</span><span class="nv">$stringContent</span><span class="p">)</span><span class="w">

</span><span class="nv">$stringHeader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Net.Http.Headers.ContentDispositionHeaderValue</span><span class="p">]::</span><span class="n">new</span><span class="p">(</span><span class="s2">"form-data"</span><span class="p">)</span><span class="w">
</span><span class="nv">$stringHeader</span><span class="o">.</span><span class="nf">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"grant_type"</span><span class="w">
</span><span class="nv">$StringContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Net.Http.StringContent</span><span class="p">]::</span><span class="n">new</span><span class="p">(</span><span class="s2">"password"</span><span class="p">)</span><span class="w">
</span><span class="nv">$StringContent</span><span class="o">.</span><span class="nf">Headers</span><span class="o">.</span><span class="nf">ContentDisposition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$stringHeader</span><span class="w">
</span><span class="nv">$multipartContent</span><span class="o">.</span><span class="nf">Add</span><span class="p">(</span><span class="nv">$stringContent</span><span class="p">)</span><span class="w">

</span><span class="nv">$body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$multipartContent</span><span class="w">

</span><span class="nv">$response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Invoke-RestMethod</span><span class="w"> </span><span class="s1">'https://192.168.1.31/token'</span><span class="w"> </span><span class="nt">-Method</span><span class="w"> </span><span class="s1">'POST'</span><span class="w"> </span><span class="nt">-Headers</span><span class="w"> </span><span class="nv">$headers</span><span class="w"> </span><span class="nt">-Body</span><span class="w"> </span><span class="nv">$body</span><span class="w"> </span><span class="nt">-SkipCertificateCheck</span><span class="p">:</span><span class="nv">$True</span><span class="w">
</span><span class="nv">$response</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ConvertTo-Json</span><span class="w">
</span></code></pre></div></div>

<p>This is a longish script for what it does, but if that bothers you it should be easy to make it shorter based on <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/invoke-restmethod?view=powershell-7.1">online help pages</a> and some searching. And it does work (PowerShell 7.1.0).</p>

<p>You need to refresh the token within <code class="language-plaintext highlighter-rouge">expires_in</code> seconds. Or not, if you fetch logs once every 30 minutes or longer, because you can get a new token every time.</p>

<p>With all parts and parameters clear and a valid bearer token, the rest is generic: we can create REST API requests to get the log for each service. An example for “service” (container) <code class="language-plaintext highlighter-rouge">mnode_api-gateway</code>, since Dec 8, 2020 00:00:00 UTC time:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-k</span> <span class="nt">-X</span> GET <span class="se">\</span>
<span class="s2">"https://192.168.1.31/mnode/1/logs?service-name=mnode_api-gateway&amp;type=service&amp;since=2020-12-08T00%3A00%3A00Z"</span> <span class="se">\</span>
<span class="nt">-H</span>  <span class="s2">"accept: */*"</span> <span class="se">\</span>
<span class="nt">-H</span>  <span class="s2">"Authorization: Bearer eyJhbGciOiJSUzI....8a"</span>
</code></pre></div></div>

<h4 id="getting-logs-with-python-or-powershell">Getting logs with Python or PowerShell</h4>

<p>Now that we got a valid token we just need to pass it in headers like so:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">requests</span>

<span class="c1"># Loop over a list of HCC services to get the log each
# Assemble a per-service URL where service string is something like mnode_api-gateway
# service_url = url_base + time_since + service_string + service + ending
# example of service_url: 
# https://192.168.1.31/mnode/logs?since=2020-12-08T00%3A00%3A00Z&amp;service-name=mnode_api-gateway&amp;stopped=false
</span>
<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'Authorization'</span> <span class="p">:</span> <span class="p">(</span><span class="s">'Bearer '</span> <span class="o">+</span> <span class="n">token</span><span class="p">),</span>
    <span class="s">'accept'</span> <span class="p">:</span> <span class="s">'*/*'</span><span class="p">,</span>
    <span class="p">}</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">service_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div>

<p>PowerShell would work exactly the same: loop over a list of services, create custom URLs and hit each per-service URL with that token in request headers.</p>

<p>If everything works out you can save the response to a file. You can strip the first three rows if you don’t want them (hard line breaks below were inserted by me for better readability), but it doesn’t hurt to leave them as-is, especially if the logs must not be tampered with.</p>

<pre><code class="language-raw">&gt;&gt;&gt; result.text
'\n=========================================================
\n    mnode_api-gateway.1.gking7pxr280mpd97d1ho2z85
\n=========================================================
\n10.0.0.23 - - [08/Dec/2020:11:34:09 +0000] "GET /metrics HTTP/1.1" 200 2476 "-" ...
'
</code></pre>

<p>Simple demo using this approach can be viewed <a href="https://www.youtube.com/watch?v=_Yrnt9oq6uM">here</a> (length: 1m45s). What’s “missing” is log forwarding (which is usually required) which something I explained in the previous post about mNode/HCC log forwarding.</p>


      </article>
    </div>
    
      <div class="categories">
    <span><p>Categories:</p>
    
    
      <a href="
      /categories/#automation">automation</a>
       
    
  </span>
</div>
    

    
      <div class="related" data-pagefind-ignore>

    <h4>Possibly related - use live search at the top to find other content</h4>
    
    
    
    
    
    
    
        
        
    
        
    
        
          <div class = "related-posts">
          <h5><a href="/2024/04/01/windows-server-2025-with-solidfire-part-two-sql-server-2022.html">• Windows Server 2025 with NetApp SolidFire 12 iSCSI Part Two</a></h5>
          </div>
          
          
        
    
      
    
        
        
    
        
    
        
          <div class = "related-posts">
          <h5><a href="/2024/04/01/windows-server-2025-with-solidfire-part-three-hyper-v.html">• Windows Server 2025 with NetApp SolidFire 12 iSCSI Part Three</a></h5>
          </div>
          
          
        
    
      
    
        
        
    
        
    
        
          <div class = "related-posts">
          <h5><a href="/2024/03/31/windows-server-2025-with-solidfire-part-one.html">• Windows Server 2025 with NetApp SolidFire 12 iSCSI</a></h5>
          </div>
          
          
        
    
      
    
        
        
    
        
    
        
    
      
    
        
        
    
        
    
        
          <div class = "related-posts">
          <h5><a href="/2024/03/28/netapp-santricity-powershell-module.html">• NetApp SANtricity PowerShell module for E-Series</a></h5>
          </div>
          
          
        
    
      
    
        
        
    
        
    
        
    
      
    
        
        
    
        
    
        
    
      
    
        
        
    
        
    
        
    
      
    
        
        
    
        
    
        
    
      
    
        
        
    
        
    
        
    
      
    
        
        
    
        
    
        
          <div class = "related-posts">
          <h5><a href="/2024/03/17/monitoring-notifications-eseries-santricity-media-scan-progress.html">• Monitor progress and notify of E-Series media scan events</a></h5>
          </div>
          
          
            
    
    </div>

    

    
  </div><footer class= "footer">
    <p>2024-04-01 20:50 </p>
    <p>Copyright © 2024 scaleoutSean. Content is released under the CC BY license. Design: Alessio Franceschi</p>
</footer>

</body>
</html>
