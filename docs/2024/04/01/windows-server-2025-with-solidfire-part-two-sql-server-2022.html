<!doctype html>
<html lang="en">
  <head>
        <meta charset="UTF-8">
    <meta http-equiv="content-language" content="en">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="googlebot" content="noarchive">
    <meta name="googlebot" content="max-snippet:60">
    <meta name="googlebot" content="max-image-preview:small">
    <meta name="bingbot" content="noarchive">
    <meta name="bingbot" content="max-snippet:60">
    <meta name="bingbot" content="max-image-preview:small">
    <meta name="robots" content="noarchive">
    <meta name="robots" content="max-snippet:60">
    <meta name="google-site-verification" content="F6q7vIwQ2G0j8tk-KL9rAXOMLXMDMMUkEz4fRs1Nnnc" />
    <title>
        
            Windows Server 2025 with NetApp SolidFire 12 iSCSI Part Two | Acting Technologist
      
    </title>
    <meta name="description" content="
     Notes on hardware-assisted T-SQL snapshots (SQL Server 2022, Windows Server 2025, NetApp SolidFire)
     ">

    <!-- LINK TO ATOM FEED FOR SEO -->
    <link rel="alternate" type="application/atom+xml" href="https://scaleoutsean.github.io/feed.xml" />

    <!-- FAVICON -->
    <link rel="icon" href="/assets/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="/assets/favicon.ico" type="image/x-icon">

    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/syntax.css">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css">

    <link href="/_pagefind/pagefind-ui.css" rel="stylesheet">
    <script src="/_pagefind/pagefind-ui.js" type="text/javascript"></script>
    <div id="search"></div>
    <script src="https://cdn.counter.dev/script.js" data-id="83dc700a-b821-4e57-9425-02b8336a9456" data-utcoffset="0"></script>
    <script>
        window.addEventListener('DOMContentLoaded', (event) => {
            new PagefindUI({ element: "#search" });
        });
    </script>

    <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Windows Server 2025 with NetApp SolidFire 12 iSCSI Part Two | Acting Technologist</title>
<meta name="generator" content="Jekyll v4.3.4" />
<meta property="og:title" content="Windows Server 2025 with NetApp SolidFire 12 iSCSI Part Two" />
<meta name="author" content="scaleoutSean" />
<meta property="og:locale" content="en" />
<meta name="description" content="Notes on hardware-assisted T-SQL snapshots (SQL Server 2022, Windows Server 2025, NetApp SolidFire)" />
<meta property="og:description" content="Notes on hardware-assisted T-SQL snapshots (SQL Server 2022, Windows Server 2025, NetApp SolidFire)" />
<link rel="canonical" href="https://scaleoutsean.github.io/2024/04/01/windows-server-2025-with-solidfire-part-two-sql-server-2022.html" />
<meta property="og:url" content="https://scaleoutsean.github.io/2024/04/01/windows-server-2025-with-solidfire-part-two-sql-server-2022.html" />
<meta property="og:site_name" content="Acting Technologist" />
<meta property="og:image" content="https://scaleoutsean.github.io/assets/images/windows-server-2025-sql-server-2022-solidfire-08-sql-database-wwi-paths.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-04-01T00:00:00+08:00" />
<script type="application/ld+json">
{"image":"https://scaleoutsean.github.io/assets/images/windows-server-2025-sql-server-2022-solidfire-08-sql-database-wwi-paths.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://scaleoutsean.github.io/2024/04/01/windows-server-2025-with-solidfire-part-two-sql-server-2022.html"},"author":{"@type":"Person","name":"scaleoutSean"},"description":"Notes on hardware-assisted T-SQL snapshots (SQL Server 2022, Windows Server 2025, NetApp SolidFire)","@type":"BlogPosting","url":"https://scaleoutsean.github.io/2024/04/01/windows-server-2025-with-solidfire-part-two-sql-server-2022.html","headline":"Windows Server 2025 with NetApp SolidFire 12 iSCSI Part Two","dateModified":"2024-04-01T00:00:00+08:00","datePublished":"2024-04-01T00:00:00+08:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  </head>

<body>

  <div class="container">
    <header id="header">
	<div id = site_title>
		<a href="https://scaleoutsean.github.io/">
			<h2 style="font-size:1.8em;">Acting Technologist</h2>
		</a>
		
		<h3>
			civilizations are created by individuals
		</h3>
		
	</div>

	<div id="subheader">
		
		<nav class="pages">
<a href="/about.html">About</a>

<a href="/archive.html">Archive</a>

<a href="/categories/">Categories</a>

<a href="/projects.html">Projects</a>
</nav>
		
		
		<nav class="social">
			
  
    <a href="https://www.github.com/scaleoutsean" target="_blank" id="github"><i class="fab fa-github" aria-hidden="true"></i></a>
  
   

  
    <a href="https://twitter.com/scaleoutsean" target="_blank" id="twitter"><i class="fab fa-twitter" aria-hidden="true"></i></a>
  
   

  
  
    <a href="/feed.xml" target="_blank" id="rss"><i class="fas fa-rss" aria-hidden="true"></i></a>
   

		</nav>
		
	</div>
</header>


    <div class="post-container">
      <article id = "post">
        <h1 id = "post-title">Windows Server 2025 with NetApp SolidFire 12 iSCSI Part Two</h1>

  
  <div class = "post-info">
    <span>
        <i class="far fa-calendar" aria-hidden="true"></i> <span>01 Apr 2024</span> - <i class="far fa-clock"></i> 


  
  
    25 minute read
  

    </span>
  </div>
  
        <p>This is the second of the posts posts on Microsoft Windows Server 2025 and NetApp SolidFire.</p>

<ul>
  <li><a href="/2024/03/31/windows-server-2025-with-solidfire-part-one.html">Part One: Windows Server 2025 with NetApp SolidFire</a> - getting started</li>
  <li>(you’re here) <strong>Part Two: SQL Server T-SQL Snapshots</strong> - using SolidFire snapshots with SQL Server 2022</li>
  <li><a href="/2024/04/01/windows-server-2025-with-solidfire-part-three-hyper-v.html">Part Three: Windows Server 2025 with NetApp SolidFire 12 iSCSI</a> - notes related to Hyper-V</li>
</ul>

<p>In this post you can find the following:</p>

<ul>
  <li><a href="#solidfire-snapshots">SolidFire snapshots</a></li>
  <li><a href="#transact-sql-snapshot-backup-with-solidfire">Transact-SQL snapshot backup with SolidFire</a></li>
  <li><a href="#snapshot-schedule-creation">Snapshot schedule creation</a></li>
  <li><a href="#restore">Restore</a></li>
  <li><a href="#dr-for-sql-server-t-sql-hardware-assisted-snapshots">DR for SQL Server T-SQL hardware-assisted snapshots</a></li>
  <li><a href="#data-masking">Data masking</a></li>
  <li><a href="#other-uses-of-solidfire-snapshots">Other uses of SolidFire snapshots</a></li>
  <li><a href="#solidfire-dba-tools">SolidFire DBA Tools</a></li>
  <li><a href="#security">Security</a></li>
  <li><a href="#conclusion">Conclusion</a></li>
  <li><a href="#appendix-a---filesystem-layout">Appendix A - filesystem layout</a></li>
  <li><a href="#appendix-c---cloning-workflow-with-cli">Appendix C - cloning workflow with CLI</a></li>
  <li><a href="#appendix-d---workflow-screenshots-tips-and-workarounds">Appendix D - workflow screenshots, tips and workarounds</a></li>
</ul>

<p>As explained in Part One, SQL Server 2022 makes it possible to easily use hardware snapshots without VSS.</p>

<p>Windows Server 2025 isn’t <em>directly</em> related to that, but my thinking is SQL Server 2022 is, and by 2025, at least those SQL Server users who don’t wait until the last day of support will start using SQL Server 2022.</p>

<h2 id="solidfire-snapshots">SolidFire snapshots</h2>

<ul>
  <li>Maximum of 32 snapshots per volume</li>
  <li>Single volume snapshot takes a crash-consistent point-in-time snapshot of a volume</li>
  <li>Group (volume) snapshot takes a snapshot of one or more volumes</li>
  <li>Snapshots can be restored (which reverts the source volume) or cloned (which is a space-efficient copy with a new VolumeID, Name, etc.)</li>
</ul>

<p>If the “base” volume is wiped and its snapshots haven’t been replicated, backed up or cloned, they will be lost as well. Snapshot is not a backup.</p>

<p>If our SQL Server has database files on one volume and log files on another, we’d take a group snapshot to protect that data.</p>

<p><img src="/assets/images/windows-server-2025-sql-server-2022-solidfire-01-storage-filesystem-db-layout.png" alt="" /></p>

<p>wwi’s properties:</p>

<p><img src="/assets/images/windows-server-2025-sql-server-2022-solidfire-08-sql-database-wwi-paths.png" alt="" /></p>

<p>Above:</p>

<ul>
  <li>SQL data for the DB <code class="language-plaintext highlighter-rouge">wwi</code>: E:\data\wwi\ (VolumeID 136, Name sqldb)</li>
  <li>SQL logs: F:\log\wwi\ (Volume ID 134, Name win1)</li>
  <li>Backup directory: G:\ (Volume ID 135, Name win2)</li>
</ul>

<p><img src="/assets/images/windows-server-2025-sql-server-2022-solidfire-12-solidfire-volumes.png" alt="" /></p>

<p>To take a group snapshot of one or more volumes from the UI, select volume(s) and take a group snapshot like so.</p>

<p><img src="/assets/images/windows-server-2025-sql-server-2022-solidfire-02-solidfire-group-snapshot.png" alt="" /></p>

<p>Snapshot retention may be set and in PowerShell we’d use <code class="language-plaintext highlighter-rouge">-Retention "00:10:00"</code> to set the expiration to 10 minutes from the time of snapshot creation.</p>

<p>While you can set expiration to a very low value, that wouldn’t make sense as database would have to fail and be restored within seconds for that snapshot to be useful. Remember, T-SQL “backup” based on storage snapshots is just SQL Server’s data about (snapshot) data - if there’s no snapshot, there’s no way to get data back!</p>

<p><img src="/assets/images/windows-server-2025-sql-server-2022-solidfire-04-solidfire-group-snapshot-retention.png" alt="" /></p>

<p>Using PowerShell to create a snapshot:</p>

<ul>
  <li>Step 1: Find volume IDs you want to backup (note that a user may have dozens and you may want to filter by name or other properties)</li>
  <li>Step 2: Create a snapshot and specify retention time and optionally attributes.</li>
</ul>

<p><img src="/assets/images/windows-server-2025-sql-server-2022-solidfire-06-powershell-snapshot-options.png" alt="" /></p>

<p>SolidFire has had volume attributes for close to a decade now, by the way. If you automate a lot, you may want to take advantage of that feature to store a bit more KV pairs to make workflows faster.</p>

<p><img src="/assets/images/windows-server-2025-sql-server-2022-solidfire-07-powershell-snapshot-attribute-customize.png" alt="" /></p>

<p>If some snapshots are local-only while others need to be replicated, we can use that in snapshot attributes.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PS</span><span class="w"> </span><span class="nx">C:\</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">New-SFGroupSnapshot</span><span class="w"> </span><span class="nt">-VolumeID</span><span class="w"> </span><span class="nx">136</span><span class="p">,</span><span class="nx">134</span><span class="w"> </span><span class="se">`n</span><span class="w">
        </span><span class="nt">-Retention</span><span class="w"> </span><span class="s2">"00:48:00"</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s2">"02testSnap"</span><span class="w"> </span><span class="err">`</span><span class="n">n</span><span class="w">
        </span><span class="nt">-Attributes</span><span class="w"> </span><span class="p">@{</span><span class="nx">Database</span><span class="o">=</span><span class="s1">'wwi'</span><span class="p">;</span><span class="w"> </span><span class="nx">Type</span><span class="o">=</span><span class="s1">'meta'</span><span class="p">;</span><span class="w"> </span><span class="nx">Site</span><span class="o">=</span><span class="s1">'local'</span><span class="p">}</span><span class="w">  

</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">New-SFGroupSnapshot</span><span class="w"> </span><span class="nt">-VolumeID</span><span class="w"> </span><span class="nx">136</span><span class="p">,</span><span class="nx">134</span><span class="w"> </span><span class="se">`n</span><span class="w"> 
        </span><span class="nt">-Retention</span><span class="w"> </span><span class="s2">"00:08:00"</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s2">"03testSnap"</span><span class="w"> </span><span class="err">`</span><span class="n">n</span><span class="w">
        </span><span class="nt">-Attributes</span><span class="w"> </span><span class="p">@{</span><span class="nx">Database</span><span class="o">=</span><span class="s1">'wwi'</span><span class="p">;</span><span class="w"> </span><span class="nx">Type</span><span class="o">=</span><span class="s1">'full'</span><span class="p">;</span><span class="w"> </span><span class="nx">Site</span><span class="o">=</span><span class="s1">'replicated'</span><span class="p">}</span><span class="w">

</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-SFGroupSnapshot</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select-Object</span><span class="w"> </span><span class="nt">-Property</span><span class="w"> </span><span class="nx">GroupSnapshotID</span><span class="p">,</span><span class="w"> </span><span class="nx">Attributes</span><span class="w">

</span><span class="n">GroupSnapshotID</span><span class="w"> </span><span class="nx">Attributes</span><span class="w">
</span><span class="o">---------------</span><span class="w"> </span><span class="o">----------</span><span class="w">
             </span><span class="mi">70</span><span class="w"> </span><span class="p">{[</span><span class="n">Site</span><span class="p">,</span><span class="w"> </span><span class="n">replicated</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">Database</span><span class="p">,</span><span class="w"> </span><span class="n">wwi</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">Type</span><span class="p">,</span><span class="w"> </span><span class="n">full</span><span class="p">]}</span><span class="w">
             </span><span class="mi">69</span><span class="w"> </span><span class="p">{[</span><span class="n">Site</span><span class="p">,</span><span class="w"> </span><span class="n">local</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">Database</span><span class="p">,</span><span class="w"> </span><span class="n">wwi</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">Type</span><span class="p">,</span><span class="w"> </span><span class="n">meta</span><span class="p">]}</span><span class="w">

</span></code></pre></div></div>

<p>I may have a bunch of these, but if only full backups need to be replicated, it’s easy to find out which ones to set up for replication and add <code class="language-plaintext highlighter-rouge">-EnableRemoteReplication</code> to New-SFSnapshot options.</p>

<h2 id="transact-sql-snapshot-backup-with-solidfire">Transact-SQL snapshot backup with SolidFire</h2>

<p>This is based on <a href="https://learn.microsoft.com/en-us/sql/relational-databases/backup-restore/create-a-transact-sql-snapshot-backup?view=sql-server-ver16">this</a>, also linked from yesterday’s post.</p>

<p>For Transact-SQL backup assisted by hardware snapshots, I assume most users would take snapshots frequently and retain each for just minutes.</p>

<p>The idea is that because they’re very light on storage, there’s no harm in taking them every 15 minutes (for example), and keeping each for 30 minutes.</p>

<p>Using T-SQL snapshots with storage snapshots doesn’t mean you can’t have other snapshots, so it’s just one of the tools that is nice to use.</p>

<p>SolidFire seems perfectly suitable for this because its snapshots are fast and using them isn’t a pain in the butt.</p>

<ul>
  <li>PowerShell 5.1: <code class="language-plaintext highlighter-rouge">Install-Module SolidFire</code></li>
  <li>PowerShell 7: <code class="language-plaintext highlighter-rouge">Install-Module SolidFire.Core</code></li>
</ul>

<p>PowerShell 7 example:</p>

<p><img src="/assets/images/windows-server-2025-sql-server-2022-solidfire-03-powershell-modules.png" alt="" /></p>

<p>PowerShell 5 example:</p>

<p><img src="/assets/images/windows-server-2025-sql-server-2022-solidfire-11-powershell-modules.png" alt="" /></p>

<p>From the page on the Microsoft Web site, this is our workflow:</p>

<p><img src="/assets/images/windows-server-2025-sql-server-2022-solidfire-10-t-sql-snapshot-backup-flow.png" alt="" /></p>

<p>While a production script should handle errors, there’s little that can go wrong with <code class="language-plaintext highlighter-rouge">New-SFGroupSnapshot</code> (or <code class="language-plaintext highlighter-rouge">New-SFSnapshot</code>). You may max out the maximum number of snapshots per volume (so, don’t do that) and if you rotate passwords, you may forget to do that for the script. At the very least use Try-Catch as I annotated in the screenshot.</p>

<p>At the very minimum, just five lines will do. We connect to SolidFire MVIP at 192.168.30, freeze the database <code class="language-plaintext highlighter-rouge">wwi</code> , have SolidFire create a snapshot (Volume ID 134, 136), and then we backup database to G:\wwi_snap.bkp.</p>

<p>In <strong>theory</strong>, this would be all that it’d take (plus some exception handling):</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Import-Module</span><span class="w"> </span><span class="nx">SolidFire</span><span class="w">
</span><span class="nv">$cred</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-Credential</span><span class="w">
</span><span class="bp">$null</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Connect-SFCluster</span><span class="w"> </span><span class="nx">192.168.1.30</span><span class="w"> </span><span class="nt">-Credential</span><span class="w"> </span><span class="nv">$cred</span><span class="w">
</span><span class="n">Start-Job</span><span class="w"> </span><span class="nt">-ScriptBlock</span><span class="w"> </span><span class="p">{</span><span class="n">sqlcmd</span><span class="w"> </span><span class="nt">-E</span><span class="w"> </span><span class="nt">-Q</span><span class="w"> </span><span class="s2">"ALTER DATABASE wwi SET SUSPEND_FOR_SNAPSHOT_BACKUP=ON;"</span><span class="p">}</span><span class="w"> 
</span><span class="nv">$SfSnap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-SFGroupSnapshot</span><span class="w"> </span><span class="nt">-VolumeID</span><span class="w"> </span><span class="nx">136</span><span class="p">,</span><span class="nx">134</span><span class="w"> </span><span class="nt">-Retention</span><span class="w"> </span><span class="s2">"00:10:00"</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s2">"wwi-snap-demo"</span><span class="w">
</span><span class="n">Start-Job</span><span class="w"> </span><span class="nt">-ScriptBlock</span><span class="w"> </span><span class="p">{</span><span class="n">sqlcmd</span><span class="w"> </span><span class="nt">-E</span><span class="w"> </span><span class="nt">-Q</span><span class="w"> </span><span class="s2">"ALTER DATABASE wwi SET SUSPEND_FOR_SNAPSHOT_BACKUP=OFF;"</span><span class="p">}</span><span class="w"> 
</span></code></pre></div></div>

<p>SolidFire credentials could be loaded from environment variables. The example above is for interactive execution.</p>

<p>We could query DB log and compare against snapshot’s <code class="language-plaintext highlighter-rouge">CreateTime</code> to make sure snapshot is taken during suspend.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\Administrator</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">New-SFGroupSnapshot</span><span class="w"> </span><span class="nt">-VolumeID</span><span class="w"> </span><span class="nx">136</span><span class="p">,</span><span class="nx">134</span><span class="w"> </span><span class="nt">-Retention</span><span class="w"> </span><span class="s2">"00:05:00"</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s2">"Example"</span><span class="w">
</span><span class="n">GroupSnapshotID</span><span class="w">         </span><span class="p">:</span><span class="w"> </span><span class="nx">67</span><span class="w">
</span><span class="n">GroupSnapshotUUID</span><span class="w">       </span><span class="p">:</span><span class="w"> </span><span class="nx">cab2e806-3ead-4cc1-b7af-e97d6d79216d</span><span class="w">
</span><span class="n">Members</span><span class="w">                 </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="n">Example</span><span class="p">,</span><span class="w"> </span><span class="nx">Example</span><span class="p">}</span><span class="w">
</span><span class="n">Name</span><span class="w">                    </span><span class="p">:</span><span class="w"> </span><span class="nx">Example</span><span class="w">
</span><span class="n">CreateTime</span><span class="w">              </span><span class="p">:</span><span class="w"> </span><span class="nx">2024-04-01T07:32:24Z</span><span class="w">
</span><span class="n">Status</span><span class="w">                  </span><span class="p">:</span><span class="w"> </span><span class="nx">done</span><span class="w">
</span><span class="n">EnableRemoteReplication</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">False</span><span class="w">
</span><span class="n">RemoteStatuses</span><span class="w">          </span><span class="p">:</span><span class="w"> 
</span><span class="n">Attributes</span><span class="w">              </span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span></code></pre></div></div>

<p>In <strong>practice</strong>, I had problems with DB instance exiting suspend mode on its own before T-SQL backup job executed which meant that backup always failed.</p>

<p>My second idea was to schedule these jobs independently (SQL Server stored procedure as one, SolidFire snapshot as another). As long as NTP is managed and working properly and database can remain suspended 10-15 seconds, that should work fine.</p>

<p>Eventually that was the only way to get this to work reliably (from SQL Server 2022 side):</p>

<ul>
  <li>stored procedure that enters suspend mode, sleeps 15 seconds, takes a backup, and leaves suspend mode</li>
  <li>Scheduled or manual SolidFire snapshots that occur at the time database is suspended (i.e. they need to start 2-3 seconds after that stored procedure)</li>
</ul>

<p>We know a backup (command in SQL Server) will fail if database isn’t suspended, so I only had to make sure that SolidFire snapshot occurred during the time it was suspended.</p>

<p>I created this stored procedure in <code class="language-plaintext highlighter-rouge">master</code> database.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">USE</span> <span class="p">[</span><span class="n">master</span><span class="p">]</span>
<span class="k">GO</span>
<span class="k">SET</span> <span class="n">ANSI_NULLS</span> <span class="k">ON</span>
<span class="k">GO</span>
<span class="k">SET</span> <span class="n">QUOTED_IDENTIFIER</span> <span class="k">ON</span>
<span class="k">GO</span>
<span class="k">CREATE</span> <span class="k">PROCEDURE</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">backupTSql</span><span class="p">]</span>
<span class="k">AS</span>
<span class="k">BEGIN</span>
	<span class="k">SET</span> <span class="n">NOCOUNT</span> <span class="k">ON</span><span class="p">;</span>
	<span class="k">ALTER</span> <span class="k">DATABASE</span> <span class="p">[</span><span class="n">vip</span><span class="p">]</span> <span class="k">SET</span> <span class="n">SUSPEND_FOR_SNAPSHOT_BACKUP</span><span class="o">=</span><span class="k">ON</span><span class="p">;</span>
	<span class="n">WAITFOR</span> <span class="n">DELAY</span> <span class="s1">'00:00:10'</span><span class="p">;</span>
	<span class="n">BACKUP</span> <span class="k">DATABASE</span> <span class="p">[</span><span class="n">vip</span><span class="p">]</span> <span class="k">TO</span> <span class="n">DISK</span> <span class="o">=</span> <span class="s1">'G:</span><span class="se">\b</span><span class="s1">kp</span><span class="se">\v</span><span class="s1">ip.bkm'</span> <span class="k">WITH</span> <span class="n">METADATA_ONLY</span><span class="p">,</span> <span class="n">FORMAT</span><span class="p">;</span>
	<span class="k">ALTER</span> <span class="k">DATABASE</span> <span class="p">[</span><span class="n">vip</span><span class="p">]</span> <span class="k">SET</span> <span class="n">SUSPEND_FOR_SNAPSHOT_BACKUP</span><span class="o">=</span><span class="k">OFF</span><span class="p">;</span>
<span class="k">END</span>
</code></pre></div></div>

<p>I added some PRINT and SELECT statements to the stored procedure during debugging to show suspended databases at that time and also compared the time of SolidFire snapshot.</p>

<p>Here we can see that <code class="language-plaintext highlighter-rouge">vip</code> was correct suspended, and in the second query (below red rectangle), after we resumed it was not.</p>

<p><img src="/assets/images/windows-server-2025-sql-server-2022-solidfire-30-sp-backup-and-ps-snapshot.png" alt="" /></p>

<p>In Messages tab we could also see that database was suspended and successfully backed up, and that our SolidFire snapshot occurred during the time the DB was frozen.</p>

<p>Steps show:</p>

<ul>
  <li>Execute the stored procedure backupTSql located in <code class="language-plaintext highlighter-rouge">master</code></li>
  <li>After 2-3 seconds take a SolidFire snapshot of the volume(s) - manually, from a script, or scheduled</li>
  <li>Observe if snapshot was taken during the wait (while DB was suspended)</li>
</ul>

<p><img src="/assets/images/windows-server-2025-sql-server-2022-solidfire-31-sp-backup-and-ps-snapshot-complete.png" alt="" /></p>

<p>The snapshot we took contains the time it was taken, which is when the DB was suspended.</p>

<p><img src="/assets/images/windows-server-2025-sql-server-2022-solidfire-32-sp-backup-and-ps-snapshot-in-solidfire.png" alt="" /></p>

<p>It is possible to run PowerShell scripts from SQL Server (so you’d only have to schedule the SP itself, and take a SolidFire snapshot as one of its steps), but that’s another can of worms.</p>

<h2 id="snapshot-schedule-creation">Snapshot schedule creation</h2>

<p>This is easy to do in the Web UI. We’ll schedule snapshots for Volume ID 135 - one every 10 minutes, retain 30 minutes.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PS</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">New-SFSchedule</span><span class="w"> </span><span class="nt">-VolumeID</span><span class="w"> </span><span class="nx">135</span><span class="w"> </span><span class="nt">-ScheduleName</span><span class="w"> </span><span class="nx">db-vip</span><span class="w"> </span><span class="se">`
</span><span class="w">    </span><span class="nt">-Frequency</span><span class="w"> </span><span class="nx">TimeInterval</span><span class="w"> </span><span class="nt">-TimeIntervalHours</span><span class="w"> </span><span class="nx">0</span><span class="w">      </span><span class="se">`
</span><span class="w">    </span><span class="nt">-TimeIntervalMinutes</span><span class="w"> </span><span class="nx">10</span><span class="w"> </span><span class="nt">-SnapshotName</span><span class="w"> </span><span class="nx">win2025-g-db-vip-snap</span><span class="w"> </span><span class="se">`
</span><span class="w">    </span><span class="nt">-RetentionDays</span><span class="w"> </span><span class="nx">0</span><span class="w"> </span><span class="nt">-RetentionHours</span><span class="w"> </span><span class="nx">0</span><span class="w"> </span><span class="nt">-RetentionMinutes</span><span class="w"> </span><span class="nx">30</span><span class="w">

</span><span class="n">Frequency</span><span class="w">          </span><span class="p">:</span><span class="w"> </span><span class="nx">SolidFire.Element.Api.TimeIntervalFrequency</span><span class="w">
</span><span class="n">HasError</span><span class="w">           </span><span class="p">:</span><span class="w"> </span><span class="nx">False</span><span class="w">
</span><span class="n">LastRunStatus</span><span class="w">      </span><span class="p">:</span><span class="w"> </span><span class="nx">Success</span><span class="w">
</span><span class="n">LastRunTimeStarted</span><span class="w"> </span><span class="p">:</span><span class="w"> 
</span><span class="n">Name</span><span class="w">               </span><span class="p">:</span><span class="w"> </span><span class="nx">db-vip</span><span class="w">
</span><span class="n">Paused</span><span class="w">             </span><span class="p">:</span><span class="w"> </span><span class="nx">False</span><span class="w">
</span><span class="n">Recurring</span><span class="w">          </span><span class="p">:</span><span class="w"> </span><span class="nx">True</span><span class="w">
</span><span class="n">RunNextInterval</span><span class="w">    </span><span class="p">:</span><span class="w"> </span><span class="nx">False</span><span class="w">
</span><span class="n">ScheduleID</span><span class="w">         </span><span class="p">:</span><span class="w"> </span><span class="nx">3</span><span class="w">
</span><span class="n">ScheduleInfo</span><span class="w">       </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"Retention"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"00:30:00"</span><span class="p">,</span><span class="w"> </span><span class="s2">"SnapshotName"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"win2025-g-db-vip-snap"</span><span class="p">}</span><span class="w">
</span><span class="n">StartingDate</span><span class="w">       </span><span class="p">:</span><span class="w"> 
</span><span class="n">ToBeDeleted</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="nx">False</span><span class="w">
</span></code></pre></div></div>

<p>Group snapshots are created by simply specifying multiple volumes, e.g. <code class="language-plaintext highlighter-rouge">-VolumeID 134,135</code>.</p>

<p>View your schedule with <code class="language-plaintext highlighter-rouge">Get-SFSchedule</code> and see/modify it in SolidFire Web UI under Data Protection &gt; Snapshots (or Group Snapshots).</p>

<p>In the case you’re wondering, snapshots get scheduled like this. We would schedule our stored procedure to start three-four seconds earlier.</p>

<p><img src="/assets/images/windows-server-2025-sql-server-2022-solidfire-33-scheduled-snapshots.png" alt="" /></p>

<p>Notice how all snapshots are named the same. You’d identify them by UUID and as you <code class="language-plaintext highlighter-rouge">Get-SFSnapshot -Volume 135</code> you could sort-descending by Create Time and pick the first to get the latest. Maybe you can by Snapshot ID as well, but personally I prefer to know (and log) the time of creation in any case.</p>

<p>If you want to replicate these to a remote site (probably not; for those I’d create a separate schedule), also consider these options:</p>

<ul>
  <li>Include in replication</li>
  <li>FIFO (First In First Out)</li>
</ul>

<h2 id="restore">Restore</h2>

<p>Please refer to Microsoft examples - there’s little SolidFire-specific about that part.</p>

<ul>
  <li>T-SQL-assisted snapshots store only metadata, so snapshotted SolidFire volume must be cloned and database file copied either with T-SQL restore command, or manually</li>
  <li>Hardware snapshots can be rolled back, but that rolls back all databases on the volume, so pay attention</li>
</ul>

<p>The only <em>SolidFire-specific</em> tip I can think of is that when you roll back a snapshot (to overwrite “original” volume) from the SolidFire UI, you will see a check-box which says “Save volumes’ current state as a group snapshot” (if you’re rolling back a group). Of course, you should stop SQL Server, offline the volume that’s being restored from a snapshot, but you <em>may want</em> to take a snapshot of the volume that’s being rolled back because if you (separately) clone that volume later, you can get some transaction logs from it, to roll the database forward. Or you may want to have a “last before rollback” snapshot of the entire volume, for whatever purposes.</p>

<p>In Appendices below you can see some OS-related details and tips.</p>

<h2 id="dr-for-sql-server-t-sql-hardware-assisted-snapshots">DR for SQL Server T-SQL hardware-assisted snapshots</h2>

<ul>
  <li>SolidFire data/log volume(s) and snapshots replicated to another SolidFire cluster</li>
  <li>SQL Server backup “metadata” file uploaded to S3, or the volume replicated to another cluster; because SolidFire snapshot happens while DB is frozen and <em>before</em> this snapshot data is taken, it won’t exist on the snapshot of that DB volume. Save it elsewhere (another volume) with a timestamp suffix or - if you keep it on the same volume - also upload it to S3 or someplace safe.</li>
</ul>

<p>Remember that SQL Server can <a href="/2023/08/28/sql-server-polybase-s3.html#backup-use-case">backup to S3</a>. It may be less bandwidth-efficient but more operationally efficient to backup SQL Server to S3, especially if you have <a href="/2023/08/22/storagegrid-simple-two-site-copy-and-ec-ilm-example.html">multi-site S3</a> which can take care of DR and is accessible from both sites without any scripting.</p>

<h2 id="data-masking">Data masking</h2>

<p>Using built-in SQL Server features:</p>

<ul>
  <li>Determine masking requirements and prepare masking “template” files</li>
  <li>Backup Prod DB instance</li>
  <li>Restore Prod DB to DevTest DB (may be on another SQL Server instance)</li>
  <li>Execute data masking on DevTest DB</li>
  <li>Allow access to DevTest users to DevTest DB</li>
</ul>

<p>Some tools perform the masking during restore to DevTest.</p>

<p><img src="/assets/images/windows-server-2025-sql-server-2022-solidfire-18-data-masking.png" alt="" /></p>

<p>Masking can be performed after restore as well, as long as DevTest users are not immediately capable of accessing data.</p>

<p>While a sensitive column in a production database may look like this…</p>

<p><img src="/assets/images/windows-server-2025-sql-server-2022-solidfire-19-table-production.png" alt="" /></p>

<p>A clone DB with masked data could have random data instead of real values. Or it could be non-random, deterministic replacement of production values. While approaches and needs differ, the common point is DevTest database should not contain sensitive data.</p>

<p><img src="/assets/images/windows-server-2025-sql-server-2022-solidfire-20-prod-vs-devtest.png" alt="" /></p>

<p>Using SQL Server and SolidFire volume clone features, we can eliminate backup-and-restore and rely on storage-side features:</p>

<ul>
  <li>Create a DB snapshot (group snapshot or single volume snapshot)</li>
  <li>Create a clone from snapshot</li>
  <li>Rescan iSCSI targets, mount disk(s), attach DevTest DB</li>
  <li>Execute data masking on DevTest DB</li>
  <li>Allow access to DevTest users (or make another clone for actual DevTest user(s))</li>
</ul>

<p>Assuming CPU and disk resources required to mask data are the same, the main difference between these two approaches is for large databases it is much more efficient to use SolidFire to clone a volume than to restore database from a backup.</p>

<p>Also, remember that SolidFire has two ways of cloning:</p>

<ul>
  <li>Clone volume or snapshot to existing volume of the same or larger size (this is called “copy”)</li>
  <li>Clone to new volume (the usual), which will have the same size</li>
</ul>

<p>To a SQL Server user with larger databases the first approach is usually better, because if you clone volume ID 1 every day, it’s better to clone it once (say, volume ID 14) and the next day just run:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Copy-SFVolume -VolumeID 1 -DstVolume 14
# If this volume has been accessed before, no need to rescan
# Set-Disk 4 -ErrorAction Stop -IsOffline $true|$false
</code></pre></div></div>

<p>A potential disadvantage of that approach is you aren’t deleting the large volume, so with many databases that aren’t needed every day it may be wasteful in terms of maximum volume count or metadata use (both on Solidfire).</p>

<p>To avoid host confusion and mistakes, it is possible to re-assign storage tenant ownership so that production host doesn’t see any clones. We can also clone a volume outright, or use one of its existing snapshots. The latter may be interesting if you need a clone from some point-in-time, or if you’re taking database-consistent snapshots and want to work with such snapshots rather than create crash-consistent clones (or suspend SQL every time you create a clone).</p>

<p>As you can see the exact steps will vary depending on procedures, preferences and such.</p>

<p>Some users may use one host and one SolidFire tenant account for everything, others may have two or three. The intermediate and DevTest team may not need more than one copy per DB instance, but in some cases they may keep a bunch of them for regression testing, and so on.</p>

<p><img src="/assets/images/windows-server-2025-sql-server-2022-solidfire-17-low-cost-clones.png" alt="" /></p>

<p>Depending on the amount of masked data, this should be usually cost very little due to data deduplication and SolidFire’s global deduplication. In this screenshot we can see Compliance &amp; DevTest have one volume each as we refresh them daily, plus all identical blocks are deduplicated after being compressed by SolidFire.</p>

<p>Storage workload-wise, Copy-SFVolume is the same thing as New-SFClone; the only difference is if the target host is different usually no rescan is needed after Copy-SFVolume.</p>

<p>For large databases with a small amount of masking (just one or two columns, for example), it may be better to use one of these two commands than backup-mask-restore. 
For small databases and databases where many columns need to be masked, the benefit of cloning or copying volumes are less pronounced.</p>

<h2 id="other-uses-of-solidfire-snapshots">Other uses of SolidFire snapshots</h2>

<p>The T-SQL approach above doesn’t use much IO on storage.</p>

<p>If you have “traditional” backup jobs or data dump operations, then you may need some extra QoS Max/Burst for the duration of such jobs - both on Source (SQL Data/Logs) and destination (Backup) volumes. See <a href="/2020/11/28/powershell-set-sfqosexception.html">this post</a> for more on using volume attributes to handle temporary QoS adjustments. Here’s a simple demo of how that works:</p>

<p><img src="/assets/images/windows-server-2025-sql-server-2022-solidfire-13-solidfire-qos-exception.png" alt="" /></p>

<p>To use the module you just need to have at least two QoS policies defined so that you can switch between QosPolicyIDs. In my environment, I had three, with 2 being the one used during backup.</p>

<p><img src="/assets/images/windows-server-2025-sql-server-2022-solidfire-14-solidfire-qos-policies.png" alt="" /></p>

<p>You can find Set-SFQosException module in my Github repo “awesome-solidfire”.</p>

<p>Hyper-V (at least as of <a href="https://learn.microsoft.com/en-us/troubleshoot/windows-server/virtualization/back-up-hyper-v-vm-from-parent-partition">Windows Server 2019</a>) uses VSS writer, so there’s no integration with SolidFire. Protecting Hyper-V data may become a topic for a future post.</p>

<p>SolidFire snapshots are also used by Velero and other backup software for Kubernetes supports CSI.</p>

<h2 id="solidfire-dba-tools">SolidFire DBA Tools</h2>

<p>For fun &amp; giggles, I modified PureStorageDbaTools which has two hardware-related functions (crash-consistent snapshot and database refresh) and modified the first of those functions.</p>

<p>Here’s an example of the first function with SolidFire:</p>

<p><img src="/assets/images/windows-server-2025-sql-server-2022-solidfire-29-simple-crash-consistent-snapshot.png" alt="" /></p>

<p>But it would take some work to make it work for everyone.</p>

<p>For an example, PureStorageDbaTools assumes data and logs are all on the same volume. That’s probably the case for many small databases, but to deal with other cases it would need to look up all volumes, and (on SolidFire) use Consistency Group Snapshots.</p>

<p>The other part is if I want a crash-consistent snapshot, it’s easy enough to do “New-SFGroupSnapshot -VolumeID 200,201”, so to make that function work with databases on multiple volumes it’d need more work and still do the same thing as that one line (crash-consistent SolidFire snapshot command).</p>

<p>The second function from PureStorageDbaTools performs volume copy and optional data masking on the clone, which would also need to be modified to support consistency groups in order to deal with multiple volumes. As-is, using single volume you can get the same with <code class="language-plaintext highlighter-rouge">Copy-SFVolume</code> - just bring the destination DB offline with detach, offline the volume, then Copy-SFVolume, online the clone volume and re-attach the DB.</p>

<p>If you want you can use DbaTools to make both of them nicer. PureStorageDbaTools has one very nice feature and that is it’s able to figure out the volume from drive letter, so as a DBA you don’t need to know the SolidFire Volume ID, you just snapshot your DB instance and let the script figure out which volume to pass to <code class="language-plaintext highlighter-rouge">New-SFSnapshot</code>.</p>

<p>I adjusted that for SolidFire and you can get the function in <a href="https://github.com/scaleoutsean/solidfire-windows/">solidfire-windows</a>.</p>

<h2 id="security">Security</h2>

<p>Be mindful of security when working with scripts that use SolidFire, OS and database credentials.</p>

<ul>
  <li>Guard the OS</li>
  <li>Sign your scripts</li>
  <li>Limit read/execute access to the specific OS account that executes the script</li>
  <li>Don’t use the default account “admin” on SolidFire and remember to change passwords when/if you rotate them on SolidFire</li>
  <li>Encrypt the SolidFire account’s password and load it from the script when it runs</li>
</ul>

<p>As mentioned elsewhere (see my SolidFire RBAC-related posts) you may also go out of your way to route SolidFire API calls through a reverse HTTPS proxy.</p>

<p>Scheduled crash-consistent snapshots on SolidFire give you less flexibility, but more security as there are no scripts to run and no passwords to manage. But the storage admin may need to get involved to set it up and clone/restore volumes when they need to be copied or rolled back.</p>

<h2 id="conclusion">Conclusion</h2>

<p>T-SQL with hardware snapshots works great - they take less than 10 seconds, are robust and trivially easy to use.</p>

<p>Other approaches may involve more work and more careful performance management. The ability to easily set and un-set a QoS policy specific to backup requirements is also extremely easy - it takes just two commands.</p>

<p>Other use cases for Windows Server 2025 with SolidFire need more investigation. That includes containers, but I haven’t heard of anyone using Kubernetes on Windows with SolidFire.</p>

<h2 id="appendix-a---filesystem-layout">Appendix A - filesystem layout</h2>

<p>My test database was basically empty, but even so - notice how small wwi_snap.bkp is (&lt;40 KB) - it’s just metadata that tells SQL Server about what’s supposed to be in the snapshot (should it be cloned and used in a restore operation) and should remain small regardless of database size.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">    </span><span class="n">Directory:</span><span class="w"> </span><span class="nx">E:\data\wwi</span><span class="w">

</span><span class="n">Mode</span><span class="w">                 </span><span class="nx">LastWriteTime</span><span class="w">         </span><span class="nx">Length</span><span class="w"> </span><span class="nx">Name</span><span class="w">
</span><span class="o">----</span><span class="w">                 </span><span class="o">-------------</span><span class="w">         </span><span class="o">------</span><span class="w"> </span><span class="o">----</span><span class="w">
</span><span class="nt">-a</span><span class="o">---</span><span class="w">            </span><span class="mi">4</span><span class="n">/1/2024</span><span class="w">  </span><span class="nx">1:29</span><span class="w"> </span><span class="nx">PM</span><span class="w">        </span><span class="nx">8388608</span><span class="w"> </span><span class="nx">wwi.mdf</span><span class="w">

    </span><span class="n">Directory:</span><span class="w"> </span><span class="nx">F:\log\wwi</span><span class="w">

</span><span class="n">Mode</span><span class="w">                 </span><span class="nx">LastWriteTime</span><span class="w">         </span><span class="nx">Length</span><span class="w"> </span><span class="nx">Name</span><span class="w">
</span><span class="o">----</span><span class="w">                 </span><span class="o">-------------</span><span class="w">         </span><span class="o">------</span><span class="w"> </span><span class="o">----</span><span class="w">
</span><span class="nt">-a</span><span class="o">---</span><span class="w">            </span><span class="mi">4</span><span class="n">/1/2024</span><span class="w">  </span><span class="nx">1:29</span><span class="w"> </span><span class="nx">PM</span><span class="w">        </span><span class="nx">8388608</span><span class="w"> </span><span class="nx">wwi_log.ldf</span><span class="w">

    </span><span class="n">Directory:</span><span class="w"> </span><span class="nx">G:\</span><span class="w">

</span><span class="n">Mode</span><span class="w">                 </span><span class="nx">LastWriteTime</span><span class="w">         </span><span class="nx">Length</span><span class="w"> </span><span class="nx">Name</span><span class="w">
</span><span class="o">----</span><span class="w">                 </span><span class="o">----</span><span class="nt">--New-SFSnapshot</span><span class="w">                   
</span><span class="nt">-a</span><span class="o">---</span><span class="w">            </span><span class="mi">4</span><span class="n">/1/2024</span><span class="w">  </span><span class="nx">2:01</span><span class="w"> </span><span class="nx">PM</span><span class="w">          </span><span class="nx">36864</span><span class="w"> </span><span class="nx">wwi_snap.bkp</span><span class="w">

</span></code></pre></div></div>

<h2 id="appendix-c---cloning-workflow-with-cli">Appendix C - cloning workflow with CLI</h2>

<p>This example uses three accounts:</p>

<ul>
  <li>Account 13 - Hyper-V cluster or a host used for Prod</li>
  <li>Account 16 - Hyper-V cluster or a host used for Compliance (Masking)</li>
  <li>Account 17 - Hyper-V cluster or a host used for Dev-Test</li>
</ul>

<p><img src="/assets/images/windows-server-2025-sql-server-2022-solidfire-15-masking-accounts.png" alt="" /></p>

<p>The idea is to use SolidFire storage tenant Account 16 as an intermediate step (for masking of cloned volumes) before we assign them to Account 17.</p>

<p>We start with a single volume DB in Prod - volume ID 136:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PS</span><span class="w"> </span><span class="nx">C:\</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-SFAccount</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select-Object</span><span class="w"> </span><span class="nt">-Property</span><span class="w"> </span><span class="nx">Username</span><span class="p">,</span><span class="nx">AccountID</span><span class="w">

</span><span class="n">Username</span><span class="w">          </span><span class="nx">AccountID</span><span class="w">
</span><span class="o">--------</span><span class="w">          </span><span class="o">---------</span><span class="w">
</span><span class="n">hyperv2025</span><span class="w">               </span><span class="nx">13</span><span class="w">
</span><span class="n">hyperv2025-masker</span><span class="w">        </span><span class="nx">16</span><span class="w">
</span><span class="n">hyperv2025-tester</span><span class="w">        </span><span class="nx">17</span><span class="w">


</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\Administrator</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-SFVolume</span><span class="w"> </span><span class="nt">-AccountID</span><span class="w"> </span><span class="nx">13</span><span class="w">

</span><span class="n">VolumeID</span><span class="w">                    </span><span class="p">:</span><span class="w"> </span><span class="nx">136</span><span class="w">
</span><span class="n">Name</span><span class="w">                        </span><span class="p">:</span><span class="w"> </span><span class="nx">sqldb</span><span class="w">
</span><span class="n">AccountID</span><span class="w">                   </span><span class="p">:</span><span class="w"> </span><span class="nx">13</span><span class="w">
</span><span class="o">...</span><span class="w">
</span></code></pre></div></div>

<p>We create a crash-consistent snapshot-on-the-fly to clone volume ID 136 for the compliance guy (account ID 16).</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PS</span><span class="w"> </span><span class="nx">C:\</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">New-SFClone</span><span class="w"> </span><span class="nt">-VolumeID</span><span class="w"> </span><span class="nx">136</span><span class="w"> </span><span class="nt">-NewAccountID</span><span class="w"> </span><span class="nx">16</span><span class="w">

</span><span class="n">cmdlet</span><span class="w"> </span><span class="nx">New-SFClone</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="nx">command</span><span class="w"> </span><span class="nx">pipeline</span><span class="w"> </span><span class="nx">position</span><span class="w"> </span><span class="nx">1</span><span class="w">
</span><span class="n">Supply</span><span class="w"> </span><span class="nx">values</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">following</span><span class="w"> </span><span class="nx">parameters:</span><span class="w">
</span><span class="p">(</span><span class="kr">Type</span><span class="w"> </span><span class="o">!</span><span class="nf">?</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">Help.</span><span class="p">)</span><span class="w">
</span><span class="n">Name:</span><span class="w"> </span><span class="nx">wwi-4-masking</span><span class="w">

</span><span class="n">Volume</span><span class="w">
</span><span class="o">------</span><span class="w">
</span><span class="p">{</span><span class="s2">"VolumeID"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">141</span><span class="p">,</span><span class="w"> </span><span class="s2">"Name"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"wwi-4-masking"</span><span class="p">,</span><span class="w"> </span><span class="s2">"AccountID"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="s2">"CreateTime"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"2024-04-12T05:20:02Z"</span><span class="p">,</span><span class="w"> </span><span class="s2">"EnableSnapMir...

</span></code></pre></div></div>

<p>The compliance guy rescans the storage, discovers volume ID 141, onlines it, picks a path, attaches SQL to DB, masks data.</p>

<p>He then clones volume 141 for the DevTest guy, Account ID 17. After he’s done, he deletes his copy (volume ID 141) because he’s a compliance guy.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PS</span><span class="w"> </span><span class="nx">C:\</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">New-SFClone</span><span class="w"> </span><span class="nt">-VolumeID</span><span class="w"> </span><span class="nx">141</span><span class="w"> </span><span class="nt">-NewAccountID</span><span class="w"> </span><span class="nx">17</span><span class="w">

</span><span class="n">cmdlet</span><span class="w"> </span><span class="nx">New-SFClone</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="nx">command</span><span class="w"> </span><span class="nx">pipeline</span><span class="w"> </span><span class="nx">position</span><span class="w"> </span><span class="nx">1</span><span class="w">
</span><span class="n">Supply</span><span class="w"> </span><span class="nx">values</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">following</span><span class="w"> </span><span class="nx">parameters:</span><span class="w">
</span><span class="p">(</span><span class="kr">Type</span><span class="w"> </span><span class="o">!</span><span class="nf">?</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">Help.</span><span class="p">)</span><span class="w">
</span><span class="n">Name:</span><span class="w"> </span><span class="nx">wwi-4-devtest</span><span class="w">

</span><span class="n">Volume</span><span class="w">
</span><span class="o">------</span><span class="w">
</span><span class="p">{</span><span class="s2">"VolumeID"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">142</span><span class="p">,</span><span class="w"> </span><span class="s2">"Name"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"wwi-4-devtest"</span><span class="p">,</span><span class="w"> </span><span class="s2">"AccountID"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">17</span><span class="p">,</span><span class="w"> </span><span class="s2">"CreateTime"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"2024-04-12T05:20:24Z"</span><span class="p">,</span><span class="w"> </span><span class="s2">"EnableSnapMir...

PS C:\&gt; Remove-SFVolume -VolumeID 141 -Confirm:</span><span class="bp">$false</span><span class="s2">
</span></code></pre></div></div>

<p><img src="/assets/images/windows-server-2025-sql-server-2022-solidfire-16-masking-workflow-clones-accounts.png" alt="" /></p>

<p>The DevTest person uses this new volume with masked data (ID 142): rescan, online, attach.</p>

<p>After they’re done testing (before next refresh), they detach and offline the volume.</p>

<p>The next day, Prod admin suspends Prod database (not shown), takes a new, short-lived (5 min) application-consistent snapshot of Prod.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PS</span><span class="w"> </span><span class="nx">C:\</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">New-SFSnapshot</span><span class="w"> </span><span class="nt">-VolumeID</span><span class="w"> </span><span class="nx">136</span><span class="w"> </span><span class="nt">-Retention</span><span class="w"> </span><span class="s2">"00:05:00"</span><span class="w">


</span><span class="n">SnapshotID</span><span class="w">              </span><span class="p">:</span><span class="w"> </span><span class="nx">454</span><span class="w">
</span><span class="n">VolumeID</span><span class="w">                </span><span class="p">:</span><span class="w"> </span><span class="nx">136</span><span class="w">
</span><span class="n">Name</span><span class="w">                    </span><span class="p">:</span><span class="w"> </span><span class="nx">2024-04-12T05:31:08Z</span><span class="w">
</span><span class="n">Checksum</span><span class="w">                </span><span class="p">:</span><span class="w"> </span><span class="nx">0x43da1c997e6ce7e5</span><span class="w">
</span><span class="n">EnableRemoteReplication</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">False</span><span class="w">
</span><span class="n">ExpirationReason</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="nx">None</span><span class="w">
</span><span class="n">ExpirationTime</span><span class="w">          </span><span class="p">:</span><span class="w"> </span><span class="nx">2024-04-12T05:36:08Z</span><span class="w">
</span><span class="n">RemoteStatuses</span><span class="w">          </span><span class="p">:</span><span class="w">
</span><span class="n">Status</span><span class="w">                  </span><span class="p">:</span><span class="w"> </span><span class="nx">done</span><span class="w">
</span><span class="n">SnapshotUUID</span><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="nx">29e17467-546e-4bc4-8c57-1b2f0d100ca6</span><span class="w">
</span><span class="n">TotalSize</span><span class="w">               </span><span class="p">:</span><span class="w"> </span><span class="nx">5000658944</span><span class="w">
</span><span class="n">GroupID</span><span class="w">                 </span><span class="p">:</span><span class="w"> </span><span class="nx">0</span><span class="w">
</span><span class="n">GroupSnapshotUUID</span><span class="w">       </span><span class="p">:</span><span class="w"> </span><span class="nx">00000000-0000-0000-0000-000000000000</span><span class="w">
</span><span class="n">CreateTime</span><span class="w">              </span><span class="p">:</span><span class="w"> </span><span class="nx">2024-04-12T05:31:08Z</span><span class="w">
</span><span class="n">InstanceCreateTime</span><span class="w">      </span><span class="p">:</span><span class="w"> </span><span class="nx">2024-04-12T05:31:08Z</span><span class="w">
</span><span class="n">VolumeName</span><span class="w">              </span><span class="p">:</span><span class="w"> </span><span class="nx">sqldb</span><span class="w">
</span><span class="n">InstanceSnapshotUUID</span><span class="w">    </span><span class="p">:</span><span class="w"> </span><span class="nx">29e17467-546e-4bc4-8c57-1b2f0d100ca6</span><span class="w">
</span><span class="n">VirtualVolumeID</span><span class="w">         </span><span class="p">:</span><span class="w">
</span><span class="n">Attributes</span><span class="w">              </span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span><span class="n">SnapMirrorLabel</span><span class="w">         </span><span class="p">:</span><span class="w">
</span></code></pre></div></div>

<p>If the compliance person leaves his clone online, this snapshot ID 454 could be copied into it, but we saw he likes to delete volumes he isn’t using, so we have no choice but to make a new clone every day. Now from this latest snapshot ID 454.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PS</span><span class="w"> </span><span class="nx">C:\</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">New-SFClone</span><span class="w"> </span><span class="nt">-VolumeID</span><span class="w"> </span><span class="nx">136</span><span class="w"> </span><span class="nt">-SnapshotID</span><span class="w"> </span><span class="nx">454</span><span class="w"> </span><span class="nt">-NewAccountID</span><span class="w"> </span><span class="nx">16</span><span class="w">

</span><span class="n">cmdlet</span><span class="w"> </span><span class="nx">New-SFClone</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="nx">command</span><span class="w"> </span><span class="nx">pipeline</span><span class="w"> </span><span class="nx">position</span><span class="w"> </span><span class="nx">1</span><span class="w">
</span><span class="n">Supply</span><span class="w"> </span><span class="nx">values</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">following</span><span class="w"> </span><span class="nx">parameters:</span><span class="w">
</span><span class="p">(</span><span class="kr">Type</span><span class="w"> </span><span class="o">!</span><span class="nf">?</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">Help.</span><span class="p">)</span><span class="w">
</span><span class="n">Name:</span><span class="w"> </span><span class="nx">wwi-4-devtest</span><span class="w">

</span><span class="n">Volume</span><span class="w">
</span><span class="o">------</span><span class="w">
</span><span class="p">{</span><span class="s2">"VolumeID"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">143</span><span class="p">,</span><span class="w"> </span><span class="s2">"Name"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"wwi-4-devtest"</span><span class="p">,</span><span class="w"> </span><span class="s2">"AccountID"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="s2">"CreateTime"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"2024-04-12T05:31:40Z"</span><span class="p">,</span><span class="w"> </span><span class="s2">"EnableSnapMir...

</span></code></pre></div></div>

<p>The compliance guy runs his usual script (rescan, online, attach, mask, detach) and then copies that volume to the DevTest guy’s clone from yesterday (volume ID 142).</p>

<p>Because the DevTest guy only detaches and offlines his volumes, the compliance guy can use Copy-SFVolume here to refresh that volume 142. He waits until that async job is complete (see Get-Async* cmdlets) and then deletes his own copy (Volume ID 143).</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PS</span><span class="w"> </span><span class="nx">C:\</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Copy-SFVolume</span><span class="w"> </span><span class="nt">-VolumeID</span><span class="w"> </span><span class="nx">143</span><span class="w"> </span><span class="nt">-DstVolumeID</span><span class="w"> </span><span class="nx">142</span><span class="w">

</span><span class="n">CloneID</span><span class="w"> </span><span class="nx">AsyncHandle</span><span class="w">
</span><span class="o">-------</span><span class="w"> </span><span class="o">-----------</span><span class="w">
     </span><span class="mi">60</span><span class="w">         </span><span class="mi">154</span><span class="w">


</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Remove-SFVolume</span><span class="w"> </span><span class="nt">-VolumeID</span><span class="w"> </span><span class="nx">143</span><span class="w"> </span><span class="nt">-Confirm</span><span class="p">:</span><span class="bp">$false</span><span class="w">
</span></code></pre></div></div>

<p><strong>NOTE:</strong></p>

<ul>
  <li>Volume cloning and deletion would probably not be left to these different users, although we could <a href="/2023/12/07/solidfire-rbac-for-json-rpc-api.html">implement RBAC</a>, by default it doesn’t exist so the DevTest guy could clone for himself whatever volumes he wants. Some “storage admin” would likely execute these steps from a script or manually. Tenants can only view their own volumes and VLANs can also be used to further segregate tenants and environments.</li>
  <li>Remember we can use use Set-SFQosPolicyID on non-production clones if you want to give clones more or less performance. By default, a clone inherits parent’s QoS Policy ID.</li>
</ul>

<p>You may encounter some unexpected issues - Appendix D shows what I observed.</p>

<h2 id="appendix-d---workflow-screenshots-tips-and-workarounds">Appendix D - workflow screenshots, tips and workarounds</h2>

<p>In this appendix I show screenshots from a workflow that uses the <em>same</em> SQL Server 2022 host (Windows Server 2025 Preview) for everything, and there’s just one person in charge of both production and dev-test database.</p>

<p>It also contains some tips and workarounds.</p>

<p>While trying to rescan iSCSI portal to view a clone, nothing came up. I forgot that I had been using Volume Access Groups (rather than CHAP). That’s common in Hyper-V (and  other HA) environments, but if you want to avoid this step, you can configure iSCSI Initiator to use CHAP. I used Add-SFVolumeToVolumeAccessGroup to <a href="https://github.com/scaleoutsean/solidfire-windows/blob/master/config-sf-account-vag-iqn-for-first-win-host.ps1">add the new volume</a> (clone) to VAG and then rescan worked fine.</p>

<p>While adding that volume to VAG I remembered that LUN IDs can be specified at the very bottom of that modal. I never tried changing the order, but if you want to further “tune” your approach, you may try playing with those to see if it can help you present volumes in the order you want, rather than in the order of discovery.</p>

<p><img src="/assets/images/windows-server-2025-sql-server-2022-solidfire-21-add-clone-to-vag.png" alt="" /></p>

<p>Maybe this has effect only before host-side scan/discovery.</p>

<p>When you login to a new clone target that you may not need, do not add that target to Favorites (in Connect dialog box).</p>

<p><img src="/assets/images/windows-server-2025-sql-server-2022-solidfire-22-iscsi-initiator-login-clone.png" alt="" /></p>

<p>Next, when you get connected, you need to online the new disk. The first time - because it’s a clone of one of the other disks on this system - it’s flagged as Read Only (even though it’s Read-Write on SolidFire).</p>

<p><img src="/assets/images/windows-server-2025-sql-server-2022-solidfire-23-online-clone-volume.png" alt="" /></p>

<p>I used the tip from the Web site of Easeus to clear that read-only flag.</p>

<p><img src="/assets/images/windows-server-2025-sql-server-2022-solidfire-24-remove-read-only-flag.png" alt="" /></p>

<p>Then I was able to bring the disk online.</p>

<p><img src="/assets/images/windows-server-2025-sql-server-2022-solidfire-25-issue-with-read-only-flag.png" alt="" /></p>

<p>As I assigned it drive letter H, that’s where it was mounted. Note the label “win2clone” on H.</p>

<p><img src="/assets/images/windows-server-2025-sql-server-2022-solidfire-26-clone-online.png" alt="" /></p>

<p>Since I was about to attach a DB that was a clone of a DB that I was actively using on the same host, I used a new name (vip-devtest) and made sure the paths used H:.</p>

<p><img src="/assets/images/windows-server-2025-sql-server-2022-solidfire-27-attach-db.png" alt="" /></p>

<p>I checked the contents to make sure it was populated with the same data. Then I disconnected my client, ran a sp_detach_db procedure, and offlined the disk (second row in the CLI screenshot below). It is very important to offline the disk if it’s going to be copied to by <code class="language-plaintext highlighter-rouge">Copy-SFVolume</code>.</p>

<p><img src="/assets/images/windows-server-2025-sql-server-2022-solidfire-28-refresh-clone.png" alt="" /></p>

<p>After that I was ready to update Prod (<code class="language-plaintext highlighter-rouge">[vip]</code>) again, and then I ran <code class="language-plaintext highlighter-rouge">Copy-SFVolume</code> to refresh my clone volume.</p>

<p>As you can see in this screenshot Set-Disk worked fine - no readonly flag was required, and furthermore, earlier disk assignment remained.</p>

<p>But I did notice that after one refresh the clone volume lost its label I gave it - “win2clone” - and automatically used the label from the original volume, which made sense as it was indeed its clone. It didn’t bother me so I didn’t try to override or change.</p>

<p>The only sensitive part is detach, especially if you’re using SQL Server Management Studio where <em>you</em> may be the connection that’s causing detach to fail. Use generic SQL Server procedures to close those connections - it’s not something related to iSCSI or SolidFire.</p>

<p>The way I executed SQL commands was to double-click on them in Explorer, which brought up SMS and then I’d execute them there.</p>

<p>SQL commands can be easily executed from a PowerShell script - you could develop queries in SMS and then load them from PowerShell.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">New-SFSnapshot</span><span class="w"> </span><span class="o">...</span><span class="w">
</span><span class="nv">$q1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-Content</span><span class="w"> </span><span class="nx">sp_detach_vip.sql</span><span class="w">
</span><span class="n">Invoke-Sqlcmd</span><span class="w"> </span><span class="nt">-Query</span><span class="w"> </span><span class="nv">$q1</span><span class="o">...</span><span class="w">
</span><span class="n">New-SFClone</span><span class="w"> </span><span class="c"># or Copy-SFVolume</span><span class="w">
</span><span class="o">...</span><span class="w">
</span></code></pre></div></div>

<p>I haven’t done this because it was just a one-off workflow, but if you do this daily or for more than one database, maybe you could.</p>

<p>The SolidFire API is well behaving so from that side you’d need very little error handling.</p>


      </article>
    </div>
    
      <div class="categories">
    <span><p>Categories:</p>
    
    
      <a href="
      /categories/#storage">storage</a>
      &nbsp; 
    
      <a href="
      /categories/#solidfire">solidfire</a>
      &nbsp; 
    
      <a href="
      /categories/#automation">automation</a>
       
    
  </span>
</div>
    

  
    <div>
      <h3>Related Posts</h3>
      <ul>
      
        <li><a href="/2024/03/31/windows-server-2025-with-solidfire-part-one.html">Windows Server 2025 with NetApp SolidFire 12 iSCSI</a></li>
      
        <li><a href="/2024/04/01/windows-server-2025-with-solidfire-part-three-hyper-v.html">Windows Server 2025 with NetApp SolidFire 12 iSCSI Part Three</a></li>
      
        <li><a href="/2024/03/28/netapp-santricity-powershell-module.html">NetApp SANtricity PowerShell module for E-Series</a></li>
      
        <li><a href="/2025/05/22/windows-2025-netapp-solidfire.html">Windows Server 2025 with NetApp SolidFire</a></li>
      
        <li><a href="/2024/06/28/growing-solidfire-volumes-paired-for-replication.html">Increase size of SolidFire volumes paired for replication</a></li>
      
      </ul>
    </div>
  

    
  </div><footer class= "footer">
    <p>2025-06-05 12:01 </p>
    <p>Copyright © 2025 scaleoutSean. Content is released under the CC BY license. Design: Alessio Franceschi</p>
</footer>

</body>
</html>
