<!doctype html>
<html lang="en">
  <head>
        <meta charset="UTF-8">
    <meta http-equiv="content-language" content="en">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="googlebot" content="noarchive">
    <meta name="googlebot" content="max-snippet:60">
    <meta name="googlebot" content="max-image-preview:small">
    <meta name="bingbot" content="noarchive">
    <meta name="bingbot" content="max-snippet:60">
    <meta name="bingbot" content="max-image-preview:small">
    <meta name="robots" content="noarchive">
    <meta name="robots" content="max-snippet:60">
    <meta name="google-site-verification" content="F6q7vIwQ2G0j8tk-KL9rAXOMLXMDMMUkEz4fRs1Nnnc" />
    <title>
        
            Monitor progress and notify of E-Series media scan events | Acting Technologist
      
    </title>
    <meta name="description" content="
     Detect, monitor, and notify of media scan jobs on NetApp E-Series
     ">

    <!-- LINK TO ATOM FEED FOR SEO -->
    <link rel="alternate" type="application/atom+xml" href="https://scaleoutsean.github.io/feed.xml" />

    <!-- FAVICON -->
    <link rel="icon" href="/assets/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="/assets/favicon.ico" type="image/x-icon">

    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/syntax.css">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css">

    <link href="/_pagefind/pagefind-ui.css" rel="stylesheet">
    <script src="/_pagefind/pagefind-ui.js" type="text/javascript"></script>
    <div id="search"></div>
    <script src="https://cdn.counter.dev/script.js" data-id="83dc700a-b821-4e57-9425-02b8336a9456" data-utcoffset="0"></script>
    <script>
        window.addEventListener('DOMContentLoaded', (event) => {
            new PagefindUI({ element: "#search" });
        });
    </script>

    <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Monitor progress and notify of E-Series media scan events | Acting Technologist</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Monitor progress and notify of E-Series media scan events" />
<meta name="author" content="scaleoutSean" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Detect, monitor, and notify of media scan jobs on NetApp E-Series" />
<meta property="og:description" content="Detect, monitor, and notify of media scan jobs on NetApp E-Series" />
<link rel="canonical" href="https://scaleoutsean.github.io/2024/03/17/monitoring-notifications-eseries-santricity-media-scan-progress.html" />
<meta property="og:url" content="https://scaleoutsean.github.io/2024/03/17/monitoring-notifications-eseries-santricity-media-scan-progress.html" />
<meta property="og:site_name" content="Acting Technologist" />
<meta property="og:image" content="https://scaleoutsean.github.io/assets/images/eseries-santricity-media-scan-04.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-03-17T00:00:00+08:00" />
<script type="application/ld+json">
{"headline":"Monitor progress and notify of E-Series media scan events","dateModified":"2024-03-17T00:00:00+08:00","datePublished":"2024-03-17T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://scaleoutsean.github.io/2024/03/17/monitoring-notifications-eseries-santricity-media-scan-progress.html"},"image":"https://scaleoutsean.github.io/assets/images/eseries-santricity-media-scan-04.png","author":{"@type":"Person","name":"scaleoutSean"},"@type":"BlogPosting","url":"https://scaleoutsean.github.io/2024/03/17/monitoring-notifications-eseries-santricity-media-scan-progress.html","description":"Detect, monitor, and notify of media scan jobs on NetApp E-Series","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  </head>

<body>

  <div class="container">
    <header id="header">
	<div id = site_title>
		<a href="https://scaleoutsean.github.io/">
			<h2 style="font-size:1.8em;">Acting Technologist</h2>
		</a>
		
		<h3>
			civilizations are created by individuals
		</h3>
		
	</div>

	<div id="subheader">
		
		<nav class="pages">
<a href="/about.html">About</a>

<a href="/archive.html">Archive</a>

<a href="/categories/">Categories</a>

<a href="/projects.html">Projects</a>
</nav>
		
		
		<nav class="social">
			
  
    <a href="https://www.github.com/scaleoutsean" target="_blank" id="github"><i class="fab fa-github" aria-hidden="true"></i></a>
  
   

  
    <a href="https://twitter.com/scaleoutsean" target="_blank" id="twitter"><i class="fab fa-twitter" aria-hidden="true"></i></a>
  
   

  
  
    <a href="/feed.xml" target="_blank" id="rss"><i class="fas fa-rss" aria-hidden="true"></i></a>
   

		</nav>
		
	</div>
</header>


    <div class="post-container">
      <article id = "post">
        <h1 id = "post-title">Monitor progress and notify of E-Series media scan events</h1>

  
  <div class = "post-info">
    <span>
        <i class="far fa-calendar" aria-hidden="true"></i> <span>17 Mar 2024</span> - <i class="far fa-clock"></i> 


  
  
    6 minute read
  

    </span>
  </div>
  
        <ul>
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#wtf-is-media-scan">WTF is Media Scan?</a></li>
  <li><a href="#santricity-api-methods-related-to-scrubbing-scanning-fixing-data-issues">SANtricity API methods related to scrubbing, scanning, fixing data issues</a></li>
  <li><a href="#implementation">Implementation</a></li>
  <li><a href="#example">Example</a></li>
  <li><a href="#polling-frequency">Polling frequency</a></li>
  <li><a href="#conclusion">Conclusion</a></li>
</ul>

<p><strong>NOTE</strong>: accounts and passwords from this post are given as examples and not used in production.</p>

<h2 id="introduction">Introduction</h2>

<p>NetApp E-Series (and its SANtricity OS) periodically performs disk media scan to detect and, if necessary, fix bit rot.</p>

<p>Recently I heard of someone complaining how it’s hard to find out what’s going on without looking at some “logs”.</p>

<p>I’ve no idea which logs because I don’t even bother with that - the first place to look is the API.</p>

<p>To be honest, I’worked with E-Series for two decades and never heard media scans are a problem or require being aware of them. Maybe that’s why they’re not clearly exposed in the SANtricity Web UI. I guess it has to be impactful enough on your workload and volumes must be extremely large for media scan status to be a thing of concern.</p>

<h2 id="wtf-is-media-scan">WTF is Media Scan?</h2>

<blockquote>
  <p>Media scan is a process that, when enabled, runs during idle time to check the physical disks in a volume. It works to ensure that the sectors are readable, and if Redundancy Check is enabled, will check RAID parity for consistency.</p>
</blockquote>

<p>I got that from <a href="https://kb.netapp.com/onprem/E-Series/SANtricity_OS/What_is_Media_Scan_on_E_Series_storage_systems">this NetApp KB</a>. The rest is not available to users without a valid support account, but it’s also documented in the SANtricity documentation.</p>

<h2 id="santricity-api-methods-related-to-scrubbing-scanning-fixing-data-issues">SANtricity API methods related to scrubbing, scanning, fixing data issues</h2>

<p>The SANtricity API is confusing:</p>
<ul>
  <li>Terminology is in some places inconsistent</li>
  <li>There’s a <code class="language-plaintext highlighter-rouge">check-volume-parity</code> API (presumably this is media scan) and <code class="language-plaintext highlighter-rouge">data-parity-repair</code> and it’s hard to figure out which API does what, when they should be used</li>
  <li>Media scans manually-initiated in the SANtricity Web UI scans don’t appear in the API output of media scan jobs (which makes the problem mentioned just above harder to solve)</li>
  <li>There’s no documentation on how media scan API is supposed to be used (especially <code class="language-plaintext highlighter-rouge">endLBA</code> value)</li>
  <li>Media scan progress indicator provided in API responses is constantly stuck on 0 (%)</li>
  <li>For system-initiated media-scans, it’s hard to see when/where (on which volumes) without using the API, so one really has to poll the API every few minutes and watch it that way</li>
</ul>

<p>Fortunately, even an outsider can get past these.</p>

<p>After some experimenting:</p>
<ul>
  <li>Use <code class="language-plaintext highlighter-rouge">check-volume-parity</code> to initiate media scan jobs on your own (you shouldn’t do that, but you need to do that if you’re developing a monitor), otherwise you may need to wait on SANtricity</li>
  <li>When calling that API, set an <code class="language-plaintext highlighter-rouge">endLBA</code> value that’s a little smaller than what you may think it should be. Say you think capacity/blockSize means endLBA should be 1234567000, try deducting a MB or two (e.g. deduct a few MB; 1234500000). You can ignore this in production as automated SANtricity-initiated scans get this right</li>
  <li>Use seconds elapsed and seconds left indicators to figure out the correct % completed indicator</li>
  <li>Check out other related API calls (e.g. error reporting) if you want a bit more detail on errors detected (if any)</li>
</ul>

<h2 id="implementation">Implementation</h2>

<p>While there’s nothing complicated to analyze, this is interesting to me because I don’t know the use case.</p>

<ul>
  <li>Some people may want to know which volume is media-scanned before performing maintenance actions</li>
  <li>Others may want to know how much time is left (i.e. when this internal workload will go away, since it has a performance impact) and trigger/throttle client workloads</li>
  <li>Yet others may want to monitor these jobs to watch for errors/fixes, for example to spot an uptrend for old media (especially HDDs)</li>
  <li>Some may want to integrate notifications or kick off some batch jobs when a job completes</li>
</ul>

<p>Because everyone may want a different thing, I didn’t try to do a full PoC.</p>

<p>I may add media scan jobs to <a href="https://github.com/scaleoutsean/eseries-perf-analyzer/">E-Series Perf Analyzer (EPA)</a> at a later time. For now I just tried to check which APIs work and how - I’m not convinced many users really care about media scans and those who do now know how to add them to EPA (or other monitoring software) on their own.</p>

<p>One thing I didn’t try is looking at reports on errors found (there’s another API call for that), in part because I don’t know if anyone cared about that or not. Also, I didn’t get any errors. I don’t think one can simulate errors (especially since I don’t even know how such API responses look like), so until I hear from someone who has this problem/need, I’ll just ignore that.</p>

<p>If I had more time I’d try building a simple JavaScript based media scan. As we use the read-only “monitor” account, it’s safe to build a nice single page monitor with media scan table, charts that can be easily scraped by whomever needs that info, and just let it run on LAN, especially if we don’t need retention or can push updates to some DB that’s already out there.</p>

<h2 id="example">Example</h2>

<p>A few months ago I discussed monitoring E-Series from PRTG. I used PowerShell in those articles and since this is something that could also be added to PRTG, I used PowerShell here as well.</p>

<p>The script takes a volume name and few other inputs. Then it logs in, gets volume parity check jobs that are <code class="language-plaintext highlighter-rouge">inProgress</code> to see if the volume <code class="language-plaintext highlighter-rouge">fifteen</code> is one of them. If yes, it looks at “seconds used” and “seconds left” (an estimate, obviously). If no in-progress job on the volume is found, it exits silently.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">&gt;</span><span class="w"> </span><span class="n">Get-ESeriesMediaScan.ps1</span><span class="w"> </span><span class="nt">-ApiEp</span><span class="w"> </span><span class="s2">"1.2.3.4"</span><span class="w"> </span><span class="nt">-ApiPort</span><span class="w"> </span><span class="s2">"8443"</span><span class="w"> </span><span class="se">`
</span><span class="w">    </span><span class="nt">-SanSysId</span><span class="w"> </span><span class="s2">"600a098000f63714000000005e79c17c"</span><span class="w"> </span><span class="se">`
</span><span class="w">    </span><span class="nt">-Account</span><span class="w"> </span><span class="s2">"monitor"</span><span class="w"> </span><span class="nt">-Password</span><span class="w"> </span><span class="s2">"XXXXXXXXXX"</span><span class="w"> </span><span class="se">`
</span><span class="w">    </span><span class="nt">-VolName</span><span class="w"> </span><span class="s2">"fifteen"</span><span class="w">

</span><span class="n">VolumeName</span><span class="w"> </span><span class="nx">PctComplete</span><span class="w"> </span><span class="nx">SecUsed</span><span class="w"> </span><span class="nx">SecLeftEstimate</span><span class="w">

</span><span class="o">----------</span><span class="w"> </span><span class="o">-----------</span><span class="w"> </span><span class="o">-------</span><span class="w"> </span><span class="o">---------------</span><span class="w">

</span><span class="n">fifteen</span><span class="w">          </span><span class="nx">79.22</span><span class="w"> </span><span class="nx">549</span><span class="w">     </span><span class="nx">144</span><span class="w">
</span></code></pre></div></div>

<p>As mentioned earlier, the API constantly returns 0 as % complete. I solve that by calculating that value on my own.</p>

<p>That’s about it. Again, I initiated scans manually through the API, and as mentioned above I can’t be certain that SANtricity-initiated scans are visible in the same API. I couldn’t spot any SANtricity-initiated jobs during the few hours I was working on this, so I can only hope they’d be visible the same way when they do run.</p>

<p>We could send notifications or push these updates to InfluxDB or Elasticsearch or Slack, but that’s unrelated to E-Series and “use case”-dependent so I’ll leave it out for now.</p>

<p><img src="/assets/images/eseries-santricity-media-scan-04.png" alt="PowerShell monitor of E-Series media scan job" /></p>

<h2 id="polling-frequency">Polling frequency</h2>

<p>On my small and idle SSD-based volumes, scans took mere minutes. But on huge and/or busy NL-SAS volumes (500 TB, for example) media scans could take days since they self-throttle when user workload is high.</p>

<p>The API seems to update every 30-60 seconds, so there’s no point in polling every 10 seconds. For HDD-based volumes or large SSD volumes, consider 600 seconds or even longer. There’s no need to constantly update this status, especially if you already use the API for pulling tons of other metrics every 60 seconds.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Media scan jobs aren’t easily accessible in SANtricity, but after 2-3 hours of fiddling with this I was able to overcome issues mentioned in this post.</p>

<p>If you want to implement this in your environment, perhaps run a monitor for a few days to make sure automatically initiated jobs can be observed through that API method, and then proceed with the rest.</p>


      </article>
    </div>
    
      <div class="categories">
    <span><p>Categories:</p>
    
    
      <a href="
      /categories/#storage">storage</a>
      &nbsp; 
    
      <a href="
      /categories/#automation">automation</a>
       
    
  </span>
</div>
    

    
      <div class="related" data-pagefind-ignore>

    <h4>Possibly related - use live search at the top to find other content</h4>
    
    
    
    
    
    
    
        
        
    
        
    
        
    
      
    
        
        
    
        
    
        
          <div class = "related-posts">
          <h5><a href="/2024/02/29/ubuntu-2404-lts-with-netapp-solidfire.html">• Ubuntu 24.04 LTS with NetApp SolidFire</a></h5>
          </div>
          
          
        
    
      
    
        
        
    
        
    
        
          <div class = "related-posts">
          <h5><a href="/2024/02/28/incus-zfs-netapp-eseries.html">• ZFS with NetApp E-Series</a></h5>
          </div>
          
          
        
    
      
    
        
        
    
        
    
        
          <div class = "related-posts">
          <h5><a href="/2024/02/26/zfs-deduplication-netapp-eseries.html">• ZFS deduplication with NetApp E-Series</a></h5>
          </div>
          
          
        
    
      
    
        
        
    
        
    
        
          <div class = "related-posts">
          <h5><a href="/2024/02/23/storagegrid-notifications-kafka.html">• Kafka notifications in NetApp StorageGRID 11.8</a></h5>
          </div>
          
          
        
    
      
    
        
        
    
        
    
        
          <div class = "related-posts">
          <h5><a href="/2024/02/22/storagegrid-delete-old-object-versions.html">• Delete old object versions on NetApp StorageGRID</a></h5>
          </div>
          
          
            
    
    </div>

    

    
  </div><footer class= "footer">
    <p>2024-03-17 13:18 </p>
    <p>Copyright © 2024 scaleoutSean. Content is released under the CC BY license. Design: Alessio Franceschi</p>
</footer>

</body>
</html>
