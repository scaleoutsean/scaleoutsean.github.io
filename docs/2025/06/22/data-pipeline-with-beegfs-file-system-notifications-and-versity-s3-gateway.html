<!doctype html>
<html lang="en">
  <head>
        <meta charset="UTF-8">
    <meta http-equiv="content-language" content="en">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="googlebot" content="noarchive">
    <meta name="googlebot" content="max-snippet:60">
    <meta name="googlebot" content="max-image-preview:small">
    <meta name="bingbot" content="noarchive">
    <meta name="bingbot" content="max-snippet:60">
    <meta name="bingbot" content="max-image-preview:small">
    <meta name="robots" content="noarchive">
    <meta name="robots" content="max-snippet:60">
    <meta name="google-site-verification" content="F6q7vIwQ2G0j8tk-KL9rAXOMLXMDMMUkEz4fRs1Nnnc" />
    <title>
        
            Data pipeline with BeeGFS FS Event Notifications and Versity S3 Gateway | Acting Technologist
      
    </title>
    <meta name="description" content="
     Make use of BeeGFS 8 file-system event notifications with Versity S3 Gateway
     ">

    <!-- LINK TO ATOM FEED FOR SEO -->
    <link rel="alternate" type="application/atom+xml" href="https://scaleoutsean.github.io/feed.xml" />

    <!-- FAVICON -->
    <link rel="icon" href="/assets/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="/assets/favicon.ico" type="image/x-icon">

    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/syntax.css">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css">

    <link href="/_pagefind/pagefind-ui.css" rel="stylesheet">
    <script src="/_pagefind/pagefind-ui.js" type="text/javascript"></script>
    <div id="search"></div>
    <script src="https://cdn.counter.dev/script.js" data-id="83dc700a-b821-4e57-9425-02b8336a9456" data-utcoffset="0"></script>
    <script>
        window.addEventListener('DOMContentLoaded', (event) => {
            new PagefindUI({ element: "#search" });
        });
    </script>

    <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Data pipeline with BeeGFS FS Event Notifications and Versity S3 Gateway | Acting Technologist</title>
<meta name="generator" content="Jekyll v4.3.4" />
<meta property="og:title" content="Data pipeline with BeeGFS FS Event Notifications and Versity S3 Gateway" />
<meta name="author" content="scaleoutSean" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Make use of BeeGFS 8 file-system event notifications with Versity S3 Gateway" />
<meta property="og:description" content="Make use of BeeGFS 8 file-system event notifications with Versity S3 Gateway" />
<link rel="canonical" href="https://scaleoutsean.github.io/2025/06/22/data-pipeline-with-beegfs-file-system-notifications-and-versity-s3-gateway.html" />
<meta property="og:url" content="https://scaleoutsean.github.io/2025/06/22/data-pipeline-with-beegfs-file-system-notifications-and-versity-s3-gateway.html" />
<meta property="og:site_name" content="Acting Technologist" />
<meta property="og:image" content="https://scaleoutsean.github.io/assets/images/versity-s3-gw-av-scanner.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-06-22T00:00:00+08:00" />
<script type="application/ld+json">
{"image":"https://scaleoutsean.github.io/assets/images/versity-s3-gw-av-scanner.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://scaleoutsean.github.io/2025/06/22/data-pipeline-with-beegfs-file-system-notifications-and-versity-s3-gateway.html"},"author":{"@type":"Person","name":"scaleoutSean"},"description":"Make use of BeeGFS 8 file-system event notifications with Versity S3 Gateway","@type":"BlogPosting","url":"https://scaleoutsean.github.io/2025/06/22/data-pipeline-with-beegfs-file-system-notifications-and-versity-s3-gateway.html","headline":"Data pipeline with BeeGFS FS Event Notifications and Versity S3 Gateway","dateModified":"2025-06-22T00:00:00+08:00","datePublished":"2025-06-22T00:00:00+08:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  </head>

<body>

  <div class="container">
    <header id="header">
	<div id = site_title>
		<a href="https://scaleoutsean.github.io/">
			<h2 style="font-size:1.8em;">Acting Technologist</h2>
		</a>
		
		<h3>
			civilizations are created by individuals
		</h3>
		
	</div>

	<div id="subheader">
		
		<nav class="pages">
<a href="/about.html">About</a>

<a href="/archive.html">Archive</a>

<a href="/categories/">Categories</a>

<a href="/projects.html">Projects</a>
</nav>
		
		
		<nav class="social">
			
  
    <a href="https://www.github.com/scaleoutsean" target="_blank" id="github"><i class="fab fa-github" aria-hidden="true"></i></a>
  
   

  
    <a href="https://twitter.com/scaleoutsean" target="_blank" id="twitter"><i class="fab fa-twitter" aria-hidden="true"></i></a>
  
   

  
  
    <a href="/feed.xml" target="_blank" id="rss"><i class="fas fa-rss" aria-hidden="true"></i></a>
   

		</nav>
		
	</div>
</header>


    <div class="post-container">
      <article id = "post">
        <h1 id = "post-title">Data pipeline with BeeGFS FS Event Notifications and Versity S3 Gateway</h1>

  
  <div class = "post-info">
    <span>
        <i class="far fa-calendar" aria-hidden="true"></i> <span>22 Jun 2025</span> - <i class="far fa-clock"></i> 


  
  
    8 minute read
  

    </span>
  </div>
  
        <ul>
  <li><a href="#background">Background</a></li>
  <li><a href="#why-this-is-cool">Why this is cool</a></li>
  <li><a href="#catches">Catches</a></li>
  <li><a href="#fileobject-duality-considerations">File/object duality considerations</a></li>
  <li><a href="#conclusion">Conclusion</a></li>
  <li><a href="#demo">Demo</a></li>
</ul>

<h2 id="background">Background</h2>

<p>For the context, see <a href="/2025/06/15/pipeline-with-beegfs-file-system-notifications-v2.html">“Improved pipelines with BeeGFS FS Event Notifications in v8”</a> where I build on top of an earlier approach to scalable S3 anti-virus scanning from some time ago, and discover that BeeGFS file-system event notifications in version 8 are very fast, useful and convenient.</p>

<p><img src="/assets/images/storagegrid-s3-scanner-beegfs.png" alt="StorageGRID Kafka notifications for AV scanner architecture" /></p>

<p>Where does BeeGFS come in play here? It is a parallel file-system, so scanning and/or downloading can be done from different BeeGFS nodes, and notifications from version 8 can be used for this.</p>

<p>Well, it has occurred to me that the Versity S3 Gateway can <em>also</em> run on BeeGFS. I blogged about it years ago.</p>

<p>And it has also occurred to me that, since it’s an S3 gateway, as soon as S3 PUT requests complete and object content are flushed to BeeGFS file-system, I don’t <em>have to</em> deal with Kafka or Web hooks and arrange for S3 downloads in order to scan those files.</p>

<p>As objects land on Versity S3 Gateway server in the form of S3 PUTs, BeeGFS file-system event notifications kick off automatically.</p>

<p>If you don’t want a complex stack, it doesn’t get simpler than this:</p>

<ul>
  <li>Receive gRPC notifications and send AV scan jobs to a job scheduler. That’s it!</li>
</ul>

<p><img src="/assets/images/versity-s3-gw-av-scanner.png" alt="StorageGRID Web hook notifications for AV scanner architecture" /></p>

<p>If you want to persist job queue, pick a scheduler that does it, if not, pick a simpler one. I used a memory-based outgoing queue in gRPC, but I could have used a kind that persists outgoing queue to disk.</p>

<p>You can make your stack more complex and add Kafka or NATS back into the picture, but I don’t think it’d add much value.</p>

<p>Versity S3 Gateway supports <a href="https://github.com/versity/versitygw/wiki/Events-Notifications">Web hook notifications, NATS and Kafka</a> so you could duplicate the complex design from the top with Versity S3 Gateway, too.</p>

<h2 id="why-this-is-cool">Why this is cool</h2>

<p>There are some niche use cases I can think of (such as, S3 metadata-related scanning or when we only ever use S3 to create content) where scanning based on Versity Web hooks would be better, but relying on underlying BeeGFS notifications - although they’re not super full-featured yet - gives you the following advantages:</p>

<ul>
  <li>No need to download S3 objects to containers or VMs with AV software to scan uploaded content (may save a lot of time for large objects!)</li>
  <li>Scale-out scanning of Versity S3 Gateway uploads from <em>any</em> BeeGFS client that can access (ACLs, etc.) that file-system location</li>
  <li>Two-in-one event notifications for <em>both</em> file-system and S3 scanning (let’s not forget - the reason we use S3 gateway and not an S3-only service (like MinIO) is that we probably upload data via both file and object services)</li>
  <li>Very simple stack, easy to understand, operate, maintain and monitor</li>
  <li>You can still use Versity event notifications for whatever other stuff you need</li>
</ul>

<p>In the previous posts related to this topic I mentioned “decide &amp; dispatch” location (e.g. maybe a messaging service or right there on the gRPC server, if it wouldn’t add too much complexity to it), so regarding that - you <em>could</em> keep that decider logic for S3 on Versity.</p>

<p>Or you could take a step back and centralize logic and rules in a messaging service (step (3)) where both BeeGFS (file-system-only, via steps (1) and (2)) and Versity S3 Gateway (S3-only, via Web hooks) send their notifications.</p>

<p><img src="/assets/images/versity-s3-gw-av-scanner-full-featured.png" alt="StorageGRID Web hook notifications for AV scanner architecture" /></p>

<p>This has advantages and disadvantages, depending on the situation, but notice that even if Versity S3 Gateway sends Web-hook notifications to NATS, the advantages of being able to scan objects as files remains and step (4) can remain unchanged: it should be advantageous to scan S3 PUTs as file-system objects, even if we got notified about it by a Versity Web hook notification.</p>

<ul>
  <li>Web hook: https://s3/bucket/obj.ect - when we are about AV-scan this, we know that object can be found at /mnt/beegfs/bucket/obj.ect and can “translate to POSIX path &amp; scan” on file-system</li>
  <li>FS event: we’d get notified about LAST_WRITER_CLOSED on bucket/obj.ect and we’d prefix those with the BeeGFS mount point such as ‘/mnt/beegfs/’</li>
</ul>

<p>Either way, regardless of where notifiations are coming from we can scan the file/object on BeeGFS - there’s no need to “download” it.</p>

<p>We’d just need to be careful to avoid scanning the same file twice if both gRPC and S3 Web hook notifications are active.</p>

<p>We can’t “exclude” certain file-system paths on BeeGFS gRPC client in 8.0.1, so we should build “drop duplicates” and similar rules in our job scheduler, for example, or drop bucket paths in Step (2) or (4) above.</p>

<p>A simplified depiction of a setup that uses both Versity S3 Gateway and BeeGFS gRPC notifications.</p>

<p><img src="/assets/images/versity-s3-gw-av-scanner-dual-event-pipeline.png" alt="Dual event pipeline with Versity S3 GW and BeeGFS gRPC notifications" /></p>

<p>These event sources could also “cross-pollinate”, so to speak, as we could (for example) use S3 web hooks to initiate non-AV on-file-system processing.</p>

<p>Or we could use BeeGFS gRPC notifications to kick off data pipelines processing on file-system level. Example:</p>

<ul>
  <li>On new S3 PUT, we receive gRPC notification and update embeddings for the “object-file” in a vector DB</li>
  <li>We then “touch” the object over S3 (new tag: <code class="language-plaintext highlighter-rouge">embeddings=ok</code>)</li>
  <li>That triggers a new S3 Web hook notification</li>
  <li>Some Web hook event subscriber out there sees that vector DB has embeddings for latest version of the documents and selectively prunes outdated KV cache for an AI chat bot</li>
</ul>

<h2 id="catches">Catches</h2>

<p>I did a generic demo of the approach with BeeGFS and gRPC in the linked post, but I also did one with Versity S3 Gateway today.</p>

<p>I first blogged about the (not original) approach to AV scanning on premises <a href="/2024/01/29/antivirus-scanning-for-on-premises-s3.html">in early 2024</a>, but I kept this on my “to-do” list as the PoC I did in that post was extremely basic.</p>

<p>The recent ones were more real and I’ve discovered several unexpected things. I’m always happy to discover problems and ““gotchas”.</p>

<p>With this stack, I’ve found two problems, neither of which is a show-stopper for most people.</p>

<p>The first was I had to use a non-BeeGFS volume (which can be a stand-alone E-Series LUN or a PVC on such LUN, for example) for Versity S3 metadata (so in effect Versity S3 Gateway container starts with 2 “volumes”, one local directory (metadata) and one BeeGFS directory). What this means is that I can’t scale out individual instances of Versity S3 Gateway on BeeGFS: if I did, each gateway’s metadata could be different.</p>

<p>This isn’t a big deal for most cases as each “bucket” on BeeGFS, as the smallest unit of metadata allocation, can’t go beyond a few GB/s. But that is plenty for a bucket and would be limiting to very few users.</p>

<p>Another workaround - also not great, but may be acceptable, is to start several Versity S3 Gateway instances each on own sub-directory below the BeeGFS data path we want to “scale-out”. Also, consider the “classic” approach where everything has to be downloaded from S3 to a file-system - that’s far from “free” and scalable. If your “classic” external S3 object store ingests at 5GB/s, you’d’ need the same throughput on your NAS or other storage used to download and AV-scan new objects from S3, so other ways wouldn’t necessarily be easier or cheaper.</p>

<p>In fact, even without BeeGFS your Versity S3 Gateway’s metadata would be single-instance only, unless you had a file-system that supported “shared metadata volumes” (I don’t know of any, and “metadata volume” feature of Versity S3 Gateway is experimental in any case, so it’s great enough that it works as-is at this time).</p>

<p>The second gotcha was I had to modify my gRPC server to drop BeeGFS events related to Versity’s temporary files (used during S3 PUT and “housekeeping” Versity S3 Gateway operations). I modified my gRPC server to ignore events related to temporary files, and that fixed it.</p>

<h2 id="fileobject-duality-considerations">File/object duality considerations</h2>

<p>I’ve mentioned this in other posts, but I’ll say it again because it’s necessary.</p>

<p>The user needs to consider what to do with infected objects/files.</p>

<p>I’ve mentioned before: in “classic” (no file/object duality) scenarios some approaches include moving infected object to a quarantine, in others deleting it, and there’s also a “temp bucket” approach in which objects first go to a temporary bucket and only get moved to the intended destination if they are clean.</p>

<p>I think the right way is to send AV scan results to a message store and let bucket owners figure it out. As long as they have access (and as owners, they should) to the bucket, they can wipe the objects or squirrel them away seconds later. There’s no need for storage layer to get involved here.</p>

<p>But, if you do get involved, work on infected files through S3 gateway: that’s where it came from, and that’s how it should be (re)moved. Messing with objects from file-system side may be risky:</p>

<ul>
  <li>Risky for S3 gateway cache and metadata (I’m not saying it is, but it could be)</li>
  <li>Risky for S3 users who may count on S3 web hooks to track what’s going on with the object. It’s nicer to tag the object with “<code class="language-plaintext highlighter-rouge">infected: true</code>” than just yank it or “<code class="language-plaintext highlighter-rouge">chown 0400</code>” it from BeeGFS side.</li>
</ul>

<h2 id="conclusion">Conclusion</h2>

<p>Versity S3 Gateway on BeeGFS is a good stack for scanning incoming data for viruses and malware before you process it.</p>

<p>Unlike AV scanning with “external” S3 storage, any S3 PUT is a BeeGFS write which automatically drives gRPC notifications, eliminates at least one layer of complexity, eliminates the downloading of S3 data to a file-system for scanning, and allows scale-out in AV scanning.</p>

<h2 id="demo">Demo</h2>

<ul>
  <li><a href="https://rumble.com/v6vimvh-event-processing-with-versity-s3-gateway-and-beegfs-grpc-event-notification.html">Event processing with Versity S3 Gateway and BeeGFS gRPC event notifications</a> (2m46s)</li>
</ul>


      </article>
    </div>
    
      <div class="categories">
    <span><p>Categories:</p>
    
    
      <a href="
      /categories/#storage">storage</a>
      &nbsp; 
    
      <a href="
      /categories/#ai">ai</a>
      &nbsp; 
    
      <a href="
      /categories/#analytics">analytics</a>
       
    
  </span>
</div>
    

  
    <div>
      <h3>Related Posts</h3>
      <ul>
      
        <li><a href="/2025/06/15/pipeline-with-beegfs-file-system-notifications-v2.html">Improved pipelines with BeeGFS FS Event Notifications in v8</a></li>
      
        <li><a href="/2023/09/20/versity-gw-s3-posix-gateway-beegfs-eseries.html">Versity S3 Gateway with BeeGFS</a></li>
      
        <li><a href="/2023/07/28/thanos-with-minio-eseries-or-ontap-s3.html">Thanos with different S3 backends - StorageGRID, ONTAP S3 and MinIO on E-Series</a></li>
      
        <li><a href="/2024/10/14/minio-versitygw-s3-performance-netapp-ef-series.html">MinIO and Versity S3 GW with tiny object workloads on NetApp E-Series</a></li>
      
        <li><a href="/2023/06/14/versity-s3-posix-gateway.html">Versity S3 Gateway</a></li>
      
      </ul>
    </div>
  

    
  </div><footer class= "footer">
    <p>2025-07-27 02:00 </p>
    <p>Copyright © 2025 scaleoutSean. Content is released under the CC BY license. Design: Alessio Franceschi</p>
</footer>

</body>
</html>
