<!doctype html>
<html lang="en">
  <head>
        <meta charset="UTF-8">
    <meta http-equiv="content-language" content="en">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="googlebot" content="noarchive">
    <meta name="googlebot" content="max-snippet:60">
    <meta name="googlebot" content="max-image-preview:small">
    <meta name="bingbot" content="noarchive">
    <meta name="bingbot" content="max-snippet:60">
    <meta name="bingbot" content="max-image-preview:small">
    <meta name="robots" content="noarchive">
    <meta name="robots" content="max-snippet:60">
    <meta name="google-site-verification" content="F6q7vIwQ2G0j8tk-KL9rAXOMLXMDMMUkEz4fRs1Nnnc" />
    <title>
        
            Flatcar Container Linux with SolidFire iSCSI | Acting Technologist
      
    </title>
    <meta name="description" content="
     Flatcar Container Linux (and similar distributions) with SolidFire
     ">

    <!-- LINK TO ATOM FEED FOR SEO -->
    <link rel="alternate" type="application/atom+xml" href="https://scaleoutsean.github.io/feed.xml" />

    <!-- FAVICON -->
    <link rel="icon" href="/assets/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="/assets/favicon.ico" type="image/x-icon">

    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/syntax.css">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css">

    <link href="/_pagefind/pagefind-ui.css" rel="stylesheet">
    <script src="/_pagefind/pagefind-ui.js" type="text/javascript"></script>
    <div id="search"></div>
    <script src="https://cdn.counter.dev/script.js" data-id="83dc700a-b821-4e57-9425-02b8336a9456" data-utcoffset="0"></script>
    <script>
        window.addEventListener('DOMContentLoaded', (event) => {
            new PagefindUI({ element: "#search" });
        });
    </script>

    <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Flatcar Container Linux with SolidFire iSCSI | Acting Technologist</title>
<meta name="generator" content="Jekyll v4.3.4" />
<meta property="og:title" content="Flatcar Container Linux with SolidFire iSCSI" />
<meta name="author" content="scaleoutSean" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Flatcar Container Linux (and similar distributions) with SolidFire" />
<meta property="og:description" content="Flatcar Container Linux (and similar distributions) with SolidFire" />
<link rel="canonical" href="https://scaleoutsean.github.io/2021/12/07/flatcar-linux-with-solidfire-iscsi.html" />
<meta property="og:url" content="https://scaleoutsean.github.io/2021/12/07/flatcar-linux-with-solidfire-iscsi.html" />
<meta property="og:site_name" content="Acting Technologist" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-12-07T00:00:00+08:00" />
<script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"https://scaleoutsean.github.io/2021/12/07/flatcar-linux-with-solidfire-iscsi.html"},"author":{"@type":"Person","name":"scaleoutSean"},"description":"Flatcar Container Linux (and similar distributions) with SolidFire","@type":"BlogPosting","url":"https://scaleoutsean.github.io/2021/12/07/flatcar-linux-with-solidfire-iscsi.html","headline":"Flatcar Container Linux with SolidFire iSCSI","dateModified":"2021-12-07T00:00:00+08:00","datePublished":"2021-12-07T00:00:00+08:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  </head>

<body>

  <div class="container">
    <header id="header">
	<div id = site_title>
		<a href="https://scaleoutsean.github.io/">
			<h2 style="font-size:1.8em;">Acting Technologist</h2>
		</a>
		
		<h3>
			civilizations are created by individuals
		</h3>
		
	</div>

	<div id="subheader">
		
		<nav class="pages">
<a href="/about.html">About</a>

<a href="/archive.html">Archive</a>

<a href="/categories/">Categories</a>

<a href="/projects.html">Projects</a>
</nav>
		
		
		<nav class="social">
			
  
    <a href="https://www.github.com/scaleoutsean" target="_blank" id="github"><i class="fab fa-github" aria-hidden="true"></i></a>
  
   

  
    <a href="https://twitter.com/scaleoutsean" target="_blank" id="twitter"><i class="fab fa-twitter" aria-hidden="true"></i></a>
  
   

  
  
    <a href="/feed.xml" target="_blank" id="rss"><i class="fas fa-rss" aria-hidden="true"></i></a>
   

		</nav>
		
	</div>
</header>


    <div class="post-container">
      <article id = "post">
        <h1 id = "post-title">Flatcar Container Linux with SolidFire iSCSI</h1>

  
  <div class = "post-info">
    <span>
        <i class="far fa-calendar" aria-hidden="true"></i> <span>07 Dec 2021</span> - <i class="far fa-clock"></i> 


  
  
    6 minute read
  

    </span>
  </div>
  
        <p><strong>NOTICE</strong>: any and all credentials and tokens on this page are samples, not leaked.</p>

<p>If you’re into containers you’ve probably heard of <a href="https://www.flatcar-linux.org/">Flatcar Container Linux</a>, popular community fork of CoreOS.</p>

<p>I don’t think any Flatcar Container Linux user would encounter a problem configuring SolidFire (SolidFire configuration for iSCSI clients is pretty hard to screw up), but some NetApp HCI or SolidFire users may not be used to Flatcar Linux, CoreOS or similar distributions. I’m not either.</p>

<h3 id="deploy-flatcar-linux">Deploy Flatcar Linux</h3>

<p>For this, just click on the link above and RTFM - I can’t make it simpler or more accurate.</p>

<p>Well, actually maybe I could, there are some typos and omissions in the official Flatcar documentation, but I will submit corrections over Github rather than post a corrected version here. I’ll do this in coming days.</p>

<p>But it can be useful to understand what needs to be done (at minimum) iSCSI-wise, so that you don’t have to read all the docs:</p>

<h3 id="prepare-solidfire-for-flatcar-container-linux-nodes">Prepare SolidFire for Flatcar Container Linux nodes</h3>

<p>Create an account and possibly one or more (e.g. one for each Flatcar Linux VM) volumes.</p>

<p>Why “possibly”? Because you may want to have NetApp Trident (dynamic CSI provisioner) create volumes for you.</p>

<p>Otherwise, you may also want to create and provision some or all volumes statically, for example you want ephemeral iSCSI devices that aren’t managed by Kubernetes, or you’re using Docker and not Kubernetes.</p>

<p>In the case you’re setting up Kubernetes or just want to script and automate the SolidFire part, you can work by the NetApp Trident documentation or chose my <a href="https://solidfire-kubernetes.pages.dev/docs/intro">SolidFire-focused Trident setup guide here</a> (recommended).</p>

<p>For this occasion I assumed that I need one emphemeral volume, so I created that volume manually. (The real reason is I don’t have a Flatcar Container Linux-based Kubernetes cluster and I’m lazy to install it and Trident for this post.)</p>

<h3 id="deploy-flatcar-container-linux-with-iscsi-service-configuration">Deploy Flatcar Container Linux with iSCSI service configuration</h3>

<p>You can also first deploy Flatcar and add iSCSi components after - configure it once OS is up and running and network ready - but if you automate, then you’ll probably configure everything before you deploy by using a Flatcar Container Linux provisioning template. How to configure iSCSI initiator? RTFM <a href="https://www.flatcar-linux.org/docs/latest/setup/storage/iscsi/">here</a>.</p>

<p>Because most people want to use iSCSI over a dedicated NIC or two, you’d need to configure network first, and iSCSI after that.</p>

<p>I configured the second NIC through automation and also iSCSI initiator file (simply tell Flatcar to write stuff to iscsid.conf), while initiatorname.iscsi is random if you don’t set it. By the time you log in, both the network and iSCSI initiator configuration should be ready. In fact the entire Kubernetes cluster can be ready in minutes.</p>

<p>I deployed the official Flatcar OVA image to vSphere 7 using 2 a vNIC configuration (one of which was connected to iSCSI vSwitch where SolidFire can be reached). That took about 20 seconds and after that I logged in:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> /etc/lsb-release 
<span class="nv">DISTRIB_ID</span><span class="o">=</span><span class="s2">"Flatcar Container Linux by Kinvolk"</span>
<span class="nv">DISTRIB_RELEASE</span><span class="o">=</span>2983.2.1
<span class="nv">DISTRIB_CODENAME</span><span class="o">=</span><span class="s2">"Oklo"</span>
<span class="nv">DISTRIB_DESCRIPTION</span><span class="o">=</span><span class="s2">"Flatcar Container Linux by Kinvolk 2983.2.1 (Oklo)"</span>
</code></pre></div></div>

<p>I had the second NIC, ens224, defined for iSCSI under <code class="language-plaintext highlighter-rouge">nic2.network</code> (your NIC names may be different; ens192 and ens224 is what this Flatcar Linux edition got on VMware ESXi 7):</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">networkd</span><span class="pi">:</span>
  <span class="na">units</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nic1.network</span>
      <span class="na">contents</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">[Match]</span>
        <span class="s">Name=ens192</span>
        <span class="s">[Network]</span>
        <span class="s">Address=192.168.1.215/24</span>
        <span class="s">Gateway=192.168.1.1</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nic2.network</span>
      <span class="na">contents</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">[Match]</span>
        <span class="s">Name=ens224</span>
        <span class="s">[Network]</span>
        <span class="s">Address=192.168.103.215/24</span>
        <span class="s">LinkLocalAddressing=no</span>
        <span class="s">IPv6AcceptRA=no</span>
</code></pre></div></div>

<p>Flatcar lets you hard-code MTU in NIC configuration file, but I didn’t do that. But if your iSCSI network supports jumbo frames, configure it that way.</p>

<p>Flatcar configuration file reflected in OS network configuration:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    <span class="nb">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: ens192: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000
    <span class="nb">link</span>/ether 00:0c:29:fc:31:c9 brd ff:ff:ff:ff:ff:ff
    altname enp11s0
    inet 192.168.1.215/24 brd 192.168.1.255 scope global ens192
       valid_lft forever preferred_lft forever
    inet6 fe80::20c:29ff:fefc:31c9/64 scope <span class="nb">link 
       </span>valid_lft forever preferred_lft forever
3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default 
    <span class="nb">link</span>/ether 02:42:7e:65:fc:4b brd ff:ff:ff:ff:ff:ff
    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0
       valid_lft forever preferred_lft forever
4: ens224: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000
    <span class="nb">link</span>/ether 00:50:56:98:b5:73 brd ff:ff:ff:ff:ff:ff
    altname enp19s0
    inet 192.168.103.215/24 brd 192.168.103.255 scope global ens224
       valid_lft forever preferred_lft forever
</code></pre></div></div>

<p>I would recommend against multipathing - if you want 2 NICs for HA, create an LACP bond (Flatcar lets you do that in network configuration file) - you’ll get your HA but you won’t need to deal with MPIO configuration (and bugs). As you can see (from docker0) I also deployed Docker in the same go.</p>

<p>My iscsid.conf was created on the first try - great!</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sean@fcl1 ~ <span class="nv">$ </span><span class="nb">sudo cat</span> /etc/iscsi/iscsid.conf 
isns.address <span class="o">=</span> 192.168.103.30
isns.port <span class="o">=</span> 3260
node.session.auth.username <span class="o">=</span> flatcarlinux
node.session.auth.password <span class="o">=</span> flatcarlinux
discovery.sendtargets.auth.username <span class="o">=</span> flatcarlinux
discovery.sendtargets.auth.password <span class="o">=</span> flatcarlinux
</code></pre></div></div>

<p>How to do that?</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">storage</span><span class="pi">:</span>
  <span class="na">files</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">path</span><span class="pi">:</span> <span class="s">/etc/iscsi/iscsid.conf</span>
      <span class="na">filesystem</span><span class="pi">:</span> <span class="s">root</span>
      <span class="na">mode</span><span class="pi">:</span>       <span class="m">0644</span>
      <span class="na">contents</span><span class="pi">:</span>
        <span class="na">inline</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">isns.address = 192.168.103.30</span>
          <span class="s">isns.port = 3260</span>
          <span class="s">node.session.auth.username = flatcarlinux</span>
          <span class="s">node.session.auth.password = flatcarlinux</span>
          <span class="s">discovery.sendtargets.auth.username = flatcarlinux</span>
          <span class="s">discovery.sendtargets.auth.password = flatcarlinux</span>
</code></pre></div></div>

<p>I manually started iscsid, discovered and logged in to the target (an ephemeral volume I created for this account).</p>

<p>Once I confirmed everything was fine, I enabled iSCSI service and performed other follow up steps (create a filesystem, <a href="https://www.flatcar-linux.org/docs/latest/setup/storage/mounting-storage/">mount storage</a>, <a href="https://www.flatcar-linux.org/docs/latest/setup/storage/mounting-storage/#use-attached-storage-for-docker">use attached storage for Docker</a>, etc.).</p>

<p><img src="/assets/images/flatcar-linux-with-solidfire-iscsi.png" alt="Deploy Flatcar Linux with SolidFire iSCSI" /></p>

<p>Remember that in order for iSCSI to start, network service must be up!</p>

<h3 id="automate">Automate</h3>

<p>As you login to SolidFire SVIP (Storage Virtual IP), you’ll be able to list device by one unique path followed by unique cluster UUID and volume details:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo ls</span> <span class="nt">-lat</span> /dev/disk/by-path/
total 0
lrwxrwxrwx. 1 root root   9 Dec  7 07:25 ip-192.168.103.30:3260-iscsi-iqn.2010-01.com.solidfire:mn4y.ephemeral.571-lun-0 -&gt; ../../sdb
</code></pre></div></div>

<p>What’s what:</p>

<ul>
  <li>Storage VIP is 192.168.103.30 and always the same in one cluster (four or 40 nodes)</li>
  <li>Cluster UUID you can see from the Web UI or obtain from the API or CLI. Mine is <code class="language-plaintext highlighter-rouge">mn4y</code></li>
  <li>You just need to append the name you gave and volume ID that returned when you created it, in my case the name is <code class="language-plaintext highlighter-rouge">ephemeral</code> and volume ID 571</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ip-<span class="o">{</span>SVIP<span class="o">}</span>:3260-iscsi-iqn.2010-01.com.solidfire:<span class="o">{</span>CLUSTERUUID<span class="o">}</span>.<span class="o">{</span>VOLUMENAME<span class="o">}</span>.<span class="o">{</span>VOLUMEID<span class="o">}</span><span class="nt">-lun-0</span>
</code></pre></div></div>

<p>That’s all it takes to map SolidFire to Linux iSCSI clients (remember, I didn’t partition LUNs - one problem less to worry about).</p>

<p><img src="/assets/images/flatcar-linux-with-solidfire-iscsi-mount.png" alt="Mount SolidFire iSCSI target from Flatcar Linux" /></p>

<p>There’s no FS tab in Flatcar, so we wouldn’t add something like this to /etc/fstab:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># /dev/disk/by-path/ip-192.168.103.30:3260-iscsi-iqn.2010-01.com.solidfire:mn4y.ephemeral.571-lun-0 /mnt/docker xfs discard,noatime 0 0</span>
</code></pre></div></div>

<p>Instead you’d add a section like this to your Flatcar configuration file and this section could also be dynamically created from a template that creates N LUNs for N Flatcar nodes and prepares storage section details for each node’s ephemeral volume.</p>

<p>(The systemd section below that is there just to give you an idea of what Flatcar’s “fstab” looks like; to make this volume used by Docker for graph storage, you’d have to use the right path for your Docker, or change Docker configuration file to use /mnt/docker. Either way is fine, but if you make such changes better check the Docker documentation.)</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">storage</span><span class="pi">:</span>
  <span class="na">filesystems</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ephemeral</span>
      <span class="na">mount</span><span class="pi">:</span>
        <span class="na">device</span><span class="pi">:</span> <span class="s">/dev/disk/by-path/ip-192.168.103.30:3260-iscsi-iqn.2010-01.com.solidfire:mn4y.ephemeral.571-lun-0</span>
        <span class="na">format</span><span class="pi">:</span> <span class="s">xfs</span>
        <span class="na">wipe_filesystem</span><span class="pi">:</span> <span class="kc">true</span>
<span class="na">systemd</span><span class="pi">:</span>
  <span class="na">units</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">var-lib-docker.mount</span>
      <span class="na">enable</span><span class="pi">:</span> <span class="kc">true</span>
      <span class="na">contents</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">[Unit]</span>
        <span class="s">Description=Mount ephemeral to /mnt/docker</span>
        <span class="s">Before=local-fs.target</span>
        <span class="s">[Mount]</span>
        <span class="s">What=/dev/disk/by-path/ip-192.168.103.30:3260-iscsi-iqn.2010-01.com.solidfire:mn4y.ephemeral.571-lun-0</span>
        <span class="s">Where=/mnt/docker</span>
        <span class="s">Type=xfs</span>
        <span class="s">Options=discard</span>
        <span class="s">[Install]</span>
        <span class="s">WantedBy=local-fs.target </span>
</code></pre></div></div>

<p>Also notice there’s a <code class="language-plaintext highlighter-rouge">discard</code> option in mount service - highly recommended if you’re using SolidFire for ephemeral volumes, as it’ll help you save (release) deleted space and keep these volumes thin.</p>

<p>Before you reboot make sure your iSCSI service is enabled, or update your configuration file and redeploy, otherwise iSCSI initiator may fail to start and connect to target.</p>

      </article>
    </div>
    
      <div class="categories">
    <span><p>Categories:</p>
    
    
      <a href="
      /categories/#storage">storage</a>
      &nbsp; 
    
      <a href="
      /categories/#virtualization">virtualization</a>
       
    
  </span>
</div>
    

  
    <div>
      <h3>Related Posts</h3>
      <ul>
      
        <li><a href="/2022/08/21/rocky-linux-docker-netapp-trident-solidfire.html">Rocky Linux 8 and 9 with NetApp Trident Docker volume plugin and SolidFire 12 iSCSI storage</a></li>
      
        <li><a href="/2023/05/29/microsoft-azure-linux-with-solidfire-iscsi.html">Azure Linux with SolidFire iSCSI targets</a></li>
      
        <li><a href="/2024/02/07/migrate-netapp-hci-from-vmware.html">How to change NetApp HCI from VMware to alternatives</a></li>
      
        <li><a href="/2024/07/31/openshift-ocp-416-iscsi-boot-solidfire.html">Boot OpenShift RCOS from NetApp SolidFire iSCSI target</a></li>
      
        <li><a href="/2024/04/01/windows-server-2025-with-solidfire-part-three-hyper-v.html">Windows Server 2025 with NetApp SolidFire 12 iSCSI Part Three</a></li>
      
      </ul>
    </div>
  

    
  </div><footer class= "footer">
    <p>2025-05-19 03:39 </p>
    <p>Copyright © 2025 scaleoutSean. Content is released under the CC BY license. Design: Alessio Franceschi</p>
</footer>

</body>
</html>
