<!doctype html>
<html lang="en">
  <head>
        <meta charset="UTF-8">
    <meta http-equiv="content-language" content="en">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="googlebot" content="noarchive">
    <meta name="googlebot" content="max-snippet:60">
    <meta name="googlebot" content="max-image-preview:small">
    <meta name="bingbot" content="noarchive">
    <meta name="bingbot" content="max-snippet:60">
    <meta name="bingbot" content="max-image-preview:small">
    <meta name="robots" content="noarchive">
    <meta name="robots" content="max-snippet:60">
    <meta name="google-site-verification" content="F6q7vIwQ2G0j8tk-KL9rAXOMLXMDMMUkEz4fRs1Nnnc" />
    <title>
        
            SolidFire monitoring with Elasticsearch | Acting Technologist
      
    </title>
    <meta name="description" content="
     How to monitor SolidFire with Elasticsearch
     ">

    <!-- LINK TO ATOM FEED FOR SEO -->
    <link rel="alternate" type="application/atom+xml" href="https://scaleoutsean.github.io/feed.xml" />

    <!-- FAVICON -->
    <link rel="icon" href="/assets/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="/assets/favicon.ico" type="image/x-icon">

    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/syntax.css">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css">

    <link href="/_pagefind/pagefind-ui.css" rel="stylesheet">
    <script src="/_pagefind/pagefind-ui.js" type="text/javascript"></script>
    <div id="search"></div>
    <script src="https://cdn.counter.dev/script.js" data-id="83dc700a-b821-4e57-9425-02b8336a9456" data-utcoffset="0"></script>
    <script>
        window.addEventListener('DOMContentLoaded', (event) => {
            new PagefindUI({ element: "#search" });
        });
    </script>

    <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>SolidFire monitoring with Elasticsearch | Acting Technologist</title>
<meta name="generator" content="Jekyll v4.3.4" />
<meta property="og:title" content="SolidFire monitoring with Elasticsearch" />
<meta name="author" content="scaleoutSean" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="How to monitor SolidFire with Elasticsearch" />
<meta property="og:description" content="How to monitor SolidFire with Elasticsearch" />
<link rel="canonical" href="https://scaleoutsean.github.io/2021/10/18/solidfire-syslog-filebeat-logstash-elk-stack.html" />
<meta property="og:url" content="https://scaleoutsean.github.io/2021/10/18/solidfire-syslog-filebeat-logstash-elk-stack.html" />
<meta property="og:site_name" content="Acting Technologist" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-10-18T00:00:00+08:00" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"scaleoutSean"},"description":"How to monitor SolidFire with Elasticsearch","@type":"BlogPosting","headline":"SolidFire monitoring with Elasticsearch","dateModified":"2021-10-18T00:00:00+08:00","datePublished":"2021-10-18T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://scaleoutsean.github.io/2021/10/18/solidfire-syslog-filebeat-logstash-elk-stack.html"},"url":"https://scaleoutsean.github.io/2021/10/18/solidfire-syslog-filebeat-logstash-elk-stack.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  </head>

<body>

  <div class="container">
    <header id="header">
	<div id = site_title>
		<a href="https://scaleoutsean.github.io/">
			<h2 style="font-size:1.8em;">Acting Technologist</h2>
		</a>
		
		<h3>
			civilizations are created by individuals
		</h3>
		
	</div>

	<div id="subheader">
		
		<nav class="pages">
<a href="/about.html">About</a>

<a href="/archive.html">Archive</a>

<a href="/categories/">Categories</a>

<a href="/projects.html">Projects</a>
</nav>
		
		
		<nav class="social">
			
  
    <a href="https://www.github.com/scaleoutsean" target="_blank" id="github"><i class="fab fa-github" aria-hidden="true"></i></a>
  
   

  
    <a href="https://twitter.com/scaleoutsean" target="_blank" id="twitter"><i class="fab fa-twitter" aria-hidden="true"></i></a>
  
   

  
  
    <a href="/feed.xml" target="_blank" id="rss"><i class="fas fa-rss" aria-hidden="true"></i></a>
   

		</nav>
		
	</div>
</header>


    <div class="post-container">
      <article id = "post">
        <h1 id = "post-title">SolidFire monitoring with Elasticsearch</h1>

  
  <div class = "post-info">
    <span>
        <i class="far fa-calendar" aria-hidden="true"></i> <span>18 Oct 2021</span> - <i class="far fa-clock"></i> 


  
  
    19 minute read
  

    </span>
  </div>
  
        <!-- TOC -->

<ul>
  <li><a href="#problem">Problem</a>
    <ul>
      <li><a href="#why-elk">Why ELK</a></li>
    </ul>
  </li>
  <li><a href="#log-forwarding-with-syslog-ng">Log Forwarding with syslog-ng</a>
    <ul>
      <li><a href="#challenges-with-solidfire-log-forwarding">Challenges with SolidFire Log Forwarding</a></li>
      <li><a href="#solving-single-log-many-formats-challenge">Solving Single-Log-Many-Formats Challenge</a></li>
      <li><a href="#structured-logs">Structured Logs</a>
        <ul>
          <li><a href="#get-events-and-faults-completely-from-api-logs">Get Events and Faults Completely from API logs</a></li>
        </ul>
      </li>
      <li><a href="#unstructured-logs">Unstructured Logs</a>
        <ul>
          <li><a href="#searching-unstructured-logs">Searching Unstructured Logs</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#status-polling-with-http_poller">Status Polling with http_poller</a></li>
  <li><a href="#snmp-trap-monitoring">SNMP Trap Monitoring</a></li>
  <li><a href="#creating-charts-and-visualizations">Creating Charts and Visualizations</a></li>
  <li><a href="#video-demo">Video Demo</a></li>
  <li><a href="#conclusion">Conclusion</a></li>
  <li><a href="#appendix-a-software-used">Appendix A: Software Used</a></li>
  <li><a href="#appendix-b-structured-log-monitoring-notes">Appendix B: Structured Log Monitoring Notes</a></li>
  <li><a href="#appendix-c-unstructured-log-monitoring-notes">Appendix C: Unstructured Log Monitoring Notes</a></li>
  <li><a href="#appendix-d-http_polling-examples">Appendix D: http_polling Examples</a></li>
</ul>

<!-- /TOC -->

<p><strong>NOTE:</strong> Passwords and credentials are from lab systems.</p>

<h2 id="problem">Problem</h2>

<p>We want to monitor SolidFire with ELK stack. What now?</p>

<p>I’d recommend one or more of these three approaches:</p>

<ul>
  <li>Log forwarding</li>
  <li>Status polling</li>
  <li>SNMP monitoring</li>
</ul>

<p>This isn’t to say there aren’t other ways - especially indirect (we could pull data from Grafana that feeds on data collected by HCI Collector, for example) - but that you probably don’t need more than two.</p>

<p>Note that all screenshot images can be opened in new tab for clearer view.</p>

<h3 id="why-elk">Why ELK</h3>

<p>Yes I know there are other stacks and each has some advantage over ELK as whole or individual components.</p>

<p>But this is for ELK, because there’s a lot of it out there.</p>

<h2 id="log-forwarding-with-syslog-ng">Log Forwarding with syslog-ng</h2>

<p>There are several ways to do this. I used the following approach:</p>

<ul>
  <li>Forward SolidFire logs to a VM running syslog-ng</li>
  <li>In syslog-ng, save SolidFire log to <code class="language-plaintext highlighter-rouge">/var/log/solidfire.log</code> using ISO8601 timestamp (or other of your choosing)</li>
  <li>In Filebeat running on the same VM, pick that log, remove some junk, and send the rest to Logstash</li>
  <li>In Logstash, send the data to Elastic</li>
</ul>

<p>It’s not a fixed approach and it’s not “the best” approach. It’s just an approach.</p>

<p>You can use rsyslog, or something else. You could also make things simpler and remove Filebeat or even syslog-ng out of this workflow - it’s entirely up to you.</p>

<h3 id="challenges-with-solidfire-log-forwarding">Challenges with SolidFire Log Forwarding</h3>

<p>The main one is to realize that SolidFire log isn’t really a log. It’s a bunch of different logs (JBODL?) from one source.</p>

<p>Or, more precisely, it’s a bunch of different logs from different SolidFire services coming from one cluster. And the logs aren’t necessarily structured the same.</p>

<p>Here’s an example:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2021-10-18T01:53:37+00:00 192.168.1.33 slice5[7385]: <span class="o">{</span><span class="s2">"action"</span>:<span class="s2">"SessionStats"</span>,<span class="s2">"idg"</span>:<span class="s2">"1982029371179181"</span>,<span class="s2">"idx"</span>:117806,<span class="s2">"system"</span>:<span class="s2">"ISCSI"</span>,<span class="s2">"utc"</span>:<span class="s2">"2021-10-18T01:53:37.283651Z"</span>,<span class="s2">"ver"</span>:<span class="s2">"1.1"</span>,<span class="s2">"xISCSISessionStats"</span>:<span class="o">{</span><span class="s2">"LoginMSecs"</span>:<span class="o">{</span><span class="s2">"avg"</span>:null,<span class="s2">"ct"</span>:0,<span class="s2">"max"</span>:null,<span class="s2">"min"</span>:null,<span class="s2">"std"</span>:0,<span class="s2">"tmax"</span>:0,<span class="s2">"tmin"</span>:0<span class="o">}</span>,<span class="s2">"RedirectCount"</span>:0,<span class="s2">"RedirectMSecs"</span>:<span class="o">{</span><span class="s2">"avg"</span>:null,<span class="s2">"ct"</span>:0,<span class="s2">"max"</span>:null,<span class="s2">"min"</span>:null,<span class="s2">"std"</span>:0,<span class="s2">"tmax"</span>:0,<span class="s2">"tmin"</span>:0<span class="o">}</span>,<span class="s2">"ServiceID"</span>:4,<span class="s2">"SessionCount"</span>:13<span class="o">}}</span>
2021-10-18T01:53:40+00:00 192.168.1.33 master-1[5540]: <span class="o">[</span>MS] 8992 CapacitySampler ms/ClusterCapacity.cpp:75:CapacityThread|Taking a Cluster Capacity sample.
2021-10-18T01:58:02+00:00 192.168.1.33 master-1[5540]: <span class="o">[</span>APIClient] 7430 master-1 httpserver/RestAPIClient.cpp:246:SendCommandRaw|curl_easy_perform failed <span class="nv">result</span><span class="o">=</span>7 <span class="nv">errorbuffer</span><span class="o">=</span>Failed to connect to 192.168.1.30 port 443: No route to host
2021-10-18T01:59:02+00:00 192.168.1.33 block7[7378]: <span class="o">{</span><span class="s2">"action"</span>:<span class="s2">"DriveStats"</span>,<span class="s2">"idg"</span>:<span class="s2">"2449920755878951"</span>,<span class="s2">"idx"</span>:18700,<span class="s2">"system"</span>:<span class="s2">"Component"</span>,<span class="s2">"utc"</span>:<span class="s2">"2021-10-18T01:59:02.329866Z"</span>,<span class="s2">"ver"</span>:<span class="s2">"1.1"</span>,<span class="s2">"xComponentDriveStats"</span>:<span class="o">{</span><span class="s2">"PercentInUse"</span>:[60,50,48,48,6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],<span class="s2">"TotalActiveData"</span>:2843353090,<span class="s2">"TotalDiscardedData"</span>:2682642430,<span class="s2">"TotalUnusedSpace"</span>:48161095680<span class="o">}}</span>
2021-10-18T01:59:12+00:00 192.168.1.33 master-1[5540]: <span class="o">{</span><span class="s2">"action"</span>:<span class="s2">"ApiCall"</span>,<span class="s2">"idg"</span>:<span class="s2">"940460905823515"</span>,<span class="s2">"idx"</span>:156655,<span class="s2">"system"</span>:<span class="s2">"Cluster"</span>,<span class="s2">"utc"</span>:<span class="s2">"2021-10-18T01:59:11.986249Z"</span>,<span class="s2">"ver"</span>:<span class="s2">"1.1"</span>,<span class="s2">"xClusterApiCall"</span>:<span class="o">{</span><span class="s2">"Method"</span>:<span class="s2">"GetVasaProviderInfo"</span>,<span class="s2">"SourceIP"</span>:<span class="s2">"192.168.1.33"</span>,<span class="s2">"Threads"</span>:1,<span class="s2">"Time"</span>:0,<span class="s2">"Username"</span>:<span class="s2">"vasa_admin_72k4"</span><span class="o">}}</span>
</code></pre></div></div>

<h3 id="solving-single-log-many-formats-challenge">Solving Single-Log-Many-Formats Challenge</h3>

<p>Given that various SolidFire services have different log structure, we have to decide what to do with that.</p>

<p>I couldn’t get anything smart to work, but I came up with two solutions, each of which sort-of-works but isn’t greatest.</p>

<ul>
  <li>syslog-based (with structure): filter incoming data and save stuff that you need to different log files (such as sfapi.log, sfevent.log, etc.). Then process log files differently according to their structure, and save them to different Elastic indexes. This would give us two or more formats, but they’d be structured.</li>
  <li>Kibana-based (no structure): use one heterogeneous log, and create Kibana queries that work around it by querying unstructured logs.</li>
</ul>

<h3 id="structured-logs">Structured Logs</h3>

<p>SolidFire system log can be saved into multiple files with syslog-ng (or rsyslog), Filebeat and even Logstash.</p>

<p>To split a log, you need to decide how and then do it.</p>

<p>In syslog-ng, there you’d parse the the incoming log entries, use <code class="language-plaintext highlighter-rouge">filter</code>, if-else blocks and <code class="language-plaintext highlighter-rouge">destination</code> to save them.</p>

<p>If you haven’t done it prior to Filebeat (or Logstash), you can use Filebeat features to achieve something similar. Or, if there’s no Filebeat then use Logstash’s pipeline-to-pipeline.</p>

<p>The point is, with the log sample above, you’ll get more than one index collection. I settled on two:</p>

<ul>
  <li>one for JSON-formatted ApiCall action messages (last row in the sample above): these are already structured. We want xClusterApiCall nested JSON for API logs</li>
  <li>one for <code class="language-plaintext highlighter-rouge">[MS]</code> program messages, which usually contain useful notifications. There’s also <code class="language-plaintext highlighter-rouge">[API]</code> (similar to ApiCall, but not fully JSON-formatted) and <code class="language-plaintext highlighter-rouge">[Event]</code>, each slightly different</li>
</ul>

<p>Given the following line with JSON-based message content:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2021-10-17T05:33:55+00:00 192.168.1.33 master-1[5540]: <span class="o">{</span><span class="se">\"</span>action<span class="se">\"</span>:<span class="se">\"</span>ApiCall<span class="se">\"</span>,<span class="se">\"</span>idg<span class="se">\"</span>:<span class="se">\"</span>940460905823515<span class="se">\"</span>,<span class="se">\"</span>idx<span class="se">\"</span>:86874,<span class="se">\"</span>system<span class="se">\"</span>:<span class="se">\"</span>Cluster<span class="se">\"</span>,<span class="se">\"</span>utc<span class="se">\"</span>:<span class="se">\"</span>2021-10-17T05:33:55.501699Z<span class="se">\"</span>,<span class="se">\"</span>ver<span class="se">\"</span>:<span class="se">\"</span>1.1<span class="se">\"</span>,<span class="se">\"</span>xClusterApiCall<span class="se">\"</span>:<span class="o">{</span><span class="se">\"</span>Method<span class="se">\"</span>:<span class="se">\"</span>GetClusterStats<span class="se">\"</span>,<span class="se">\"</span>SourceIP<span class="se">\"</span>:<span class="se">\"</span>192.168.1.12<span class="se">\"</span>,<span class="se">\"</span>Threads<span class="se">\"</span>:1,<span class="se">\"</span>Time<span class="se">\"</span>:22,<span class="se">\"</span>Username<span class="se">\"</span>:<span class="se">\"</span>admin<span class="se">\"</span><span class="o">}}</span><span class="s2">"
</span></code></pre></div></div>

<p>We could Grok such lines with something like this (I use ISO8601 in syslog-ng) and then use the JSON content to overwrite the original message entry:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>%{TIMESTAMP_ISO8601:iso8601_timestamp} %{IPV4} %{SYSLOGPROG:program}: %{GREEDYDATA:json_message}
</code></pre></div></div>

<p>Result:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"json_message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{</span><span class="se">\\\"</span><span class="s2">action</span><span class="se">\\\"</span><span class="s2">:</span><span class="se">\\\"</span><span class="s2">ApiCall</span><span class="se">\\\"</span><span class="s2">,</span><span class="se">\\\"</span><span class="s2">idg</span><span class="se">\\\"</span><span class="s2">:</span><span class="se">\\\"</span><span class="s2">940460905823515</span><span class="se">\\\"</span><span class="s2">,</span><span class="se">\\\"</span><span class="s2">idx</span><span class="se">\\\"</span><span class="s2">:86874,</span><span class="se">\\\"</span><span class="s2">system</span><span class="se">\\\"</span><span class="s2">:</span><span class="se">\\\"</span><span class="s2">Cluster</span><span class="se">\\\"</span><span class="s2">,</span><span class="se">\\\"</span><span class="s2">utc</span><span class="se">\\\"</span><span class="s2">:</span><span class="se">\\\"</span><span class="s2">2021-10-17T05:33:55.501699Z</span><span class="se">\\\"</span><span class="s2">,</span><span class="se">\\\"</span><span class="s2">ver</span><span class="se">\\\"</span><span class="s2">:</span><span class="se">\\\"</span><span class="s2">1.1</span><span class="se">\\\"</span><span class="s2">,</span><span class="se">\\\"</span><span class="s2">xClusterApiCall</span><span class="se">\\\"</span><span class="s2">:{</span><span class="se">\\\"</span><span class="s2">Method</span><span class="se">\\\"</span><span class="s2">:</span><span class="se">\\\"</span><span class="s2">GetClusterStats</span><span class="se">\\\"</span><span class="s2">,</span><span class="se">\\\"</span><span class="s2">SourceIP</span><span class="se">\\\"</span><span class="s2">:</span><span class="se">\\\"</span><span class="s2">192.168.1.12</span><span class="se">\\\"</span><span class="s2">,</span><span class="se">\\\"</span><span class="s2">Threads</span><span class="se">\\\"</span><span class="s2">:1,</span><span class="se">\\\"</span><span class="s2">Time</span><span class="se">\\\"</span><span class="s2">:22,</span><span class="se">\\\"</span><span class="s2">Username</span><span class="se">\\\"</span><span class="s2">:</span><span class="se">\\\"</span><span class="s2">admin</span><span class="se">\\\"</span><span class="s2">}}</span><span class="se">\"</span><span class="s2">"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"iso8601_timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2021-10-17T05:33:55+00:00"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"pid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5540"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"program"</span><span class="p">:</span><span class="w"> </span><span class="s2">"master-1"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>I haven’t yet tried to create working Grok or other examples with <code class="language-plaintext highlighter-rouge">[MS]</code> and similar logs. Using the same Grok filter, the entire content gets stuffed into <code class="language-plaintext highlighter-rouge">json_message</code> which is unlikely to survive conversion to JSON. We’d need to process such entries differently.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"json_message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[Event] 8970 PionScheduler serviceshared/EventReporter.cpp:582:ReportEvent|Successfully reported event={id=47307 type=ApiEvent nodeID=1 message=[API Call (CreateSnapshot)] details={</span><span class="se">\"</span><span class="s2">context</span><span class="se">\"</span><span class="s2">:{</span><span class="se">\"</span><span class="s2">ip</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">192.168.1.12</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">user</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">admin</span><span class="se">\"</span><span class="s2">},</span><span class="se">\"</span><span class="s2">method</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">CreateSnapshot</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">params</span><span class="se">\"</span><span class="s2">:{</span><span class="se">\"</span><span class="s2">name</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">elastic-snapshot</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">requestAPIVersion</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">11.0</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">retention</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">0:5:00</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">volumeID</span><span class="se">\"</span><span class="s2">:484},</span><span class="se">\"</span><span class="s2">success</span><span class="se">\"</span><span class="s2">:true} reported=2021-10-18T05:01:23.480432Z published=2021-10-18T05:01:23.480489Z} mNumEventsPublished=5"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"iso8601_timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2021-10-18T05:01:23+00:00"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"pid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5540"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"program"</span><span class="p">:</span><span class="w"> </span><span class="s2">"master-1"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>If we used JSON decoding on a SolidFire log with mixed log types, lines with <code class="language-plaintext highlighter-rouge">[MS]</code> and <code class="language-plaintext highlighter-rouge">[Event]</code> in them could get tagged with <code class="language-plaintext highlighter-rouge">[_jsonparsefailure]</code> (see <a href="https://www.elastic.co/guide/en/logstash/current/plugins-filters-json.html#plugins-filters-json-tag_on_failure">here</a>), so although that would fail, it’d still give us a way to find those failed entries (or send them to their own index set) where we could use unstructured search on them.</p>

<h4 id="get-events-and-faults-completely-from-api-logs">Get Events and Faults Completely from API logs</h4>

<p>Can we just forget about [MS], [API], [Event] and such, and get Events and Faults from JSON formatted logs? Let’s try.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> /var/log/solidfire.log | <span class="nb">grep</span> <span class="s2">"</span><span class="se">\"</span><span class="s2">action</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">Fault"</span>
2021-10-18T02:55:05+00:00 192.168.1.33 master-1[5540]: <span class="o">{</span><span class="s2">"action"</span>:<span class="s2">"Fault"</span>,<span class="s2">"idg"</span>:<span class="s2">"940460905823515"</span>,<span class="s2">"idx"</span>:159046,<span class="s2">"system"</span>:<span class="s2">"Cluster"</span>,<span class="s2">"utc"</span>:<span class="s2">"2021-10-18T02:55:04.650426Z"</span>,<span class="s2">"ver"</span>:<span class="s2">"1.1"</span>,<span class="s2">"xClusterFault"</span>:<span class="o">{</span><span class="s2">"Code"</span>:<span class="s2">"ClusterIOPSAreOverProvisioned"</span>,<span class="s2">"Details"</span>:<span class="s2">"The sum of all minimum QoS IOPS (5300) is greater than the expected IOPS (3000) of the cluster. The minimum QoS can not be maintained for all volumes simultaneously in this condition. Adjust QoS settings on one or more volumes to not exceed available cluster IOPS."</span>,<span class="s2">"DriveIDs"</span>:[],<span class="s2">"FaultID"</span>:68,<span class="s2">"HardwareID"</span>:0,<span class="s2">"NodeID"</span>:0,<span class="s2">"ServiceID"</span>:0,<span class="s2">"Severity"</span>:<span class="s2">"Warning"</span>,<span class="s2">"Type"</span>:<span class="s2">"Cluster"</span><span class="o">}}</span>
2021-10-18T02:55:05+00:00 192.168.1.33 master-1[5540]: <span class="o">{</span><span class="s2">"action"</span>:<span class="s2">"Fault"</span>,<span class="s2">"idg"</span>:<span class="s2">"940460905823515"</span>,<span class="s2">"idx"</span>:159047,<span class="s2">"system"</span>:<span class="s2">"Cluster"</span>,<span class="s2">"utc"</span>:<span class="s2">"2021-10-18T02:55:04.652291Z"</span>,<span class="s2">"ver"</span>:<span class="s2">"1.1"</span>,<span class="s2">"xClusterFault"</span>:<span class="o">{</span><span class="s2">"Code"</span>:<span class="s2">"DisconnectedClusterPair"</span>,<span class="s2">"Details"</span>:<span class="s2">"One of the clusters in a pair may have become misconfigured or disconnected.  Remove the local pairing and retry pairing the clusters. Disconnected Cluster Pairs: [11]. Misconfigured Cluster Pairs: []"</span>,<span class="s2">"DriveIDs"</span>:[],<span class="s2">"FaultID"</span>:69,<span class="s2">"HardwareID"</span>:0,<span class="s2">"NodeID"</span>:0,<span class="s2">"ServiceID"</span>:0,<span class="s2">"Severity"</span>:<span class="s2">"Warning"</span>,<span class="s2">"Type"</span>:<span class="s2">"Cluster"</span><span class="o">}}</span>
</code></pre></div></div>

<p>Using the same Grok line as above, these could result in valid JSON. We’d need some “fine tuning” to get to <code class="language-plaintext highlighter-rouge">xClusterFault</code>, but even without that this could be usable enough.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"json_message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{</span><span class="se">\"</span><span class="s2">action</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">Fault</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">idg</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">940460905823515</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">idx</span><span class="se">\"</span><span class="s2">:159047,</span><span class="se">\"</span><span class="s2">system</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">Cluster</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">utc</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">2021-10-18T02:55:04.652291Z</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">ver</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">1.1</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">xClusterFault</span><span class="se">\"</span><span class="s2">:{</span><span class="se">\"</span><span class="s2">Code</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">DisconnectedClusterPair</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">Details</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">One of the clusters in a pair may have become misconfigured or disconnected.  Remove the local pairing and retry pairing the clusters. Disconnected Cluster Pairs: [11]. Misconfigured Cluster Pairs: []</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">DriveIDs</span><span class="se">\"</span><span class="s2">:[],</span><span class="se">\"</span><span class="s2">FaultID</span><span class="se">\"</span><span class="s2">:69,</span><span class="se">\"</span><span class="s2">HardwareID</span><span class="se">\"</span><span class="s2">:0,</span><span class="se">\"</span><span class="s2">NodeID</span><span class="se">\"</span><span class="s2">:0,</span><span class="se">\"</span><span class="s2">ServiceID</span><span class="se">\"</span><span class="s2">:0,</span><span class="se">\"</span><span class="s2">Severity</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">Warning</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">Type</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">Cluster</span><span class="se">\"</span><span class="s2">}}"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"iso8601_timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2021-10-18T02:55:05+00:00"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"pid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5540"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"program"</span><span class="p">:</span><span class="w"> </span><span class="s2">"master-1"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>To evaluate this further, we included only a handful of JSON-formatted calls in Filebeat <code class="language-plaintext highlighter-rouge">include_lines</code> and dropped everything else.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">filestream</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">paths</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">/var/log/solidfire.log</span>
  <span class="na">fields</span><span class="pi">:</span>
    <span class="na">logtype</span><span class="pi">:</span> <span class="s">sfapi</span>
  <span class="na">include_lines</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">.*{"action":"ApiCall".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"Config".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"ConnectionState".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"Create".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"Event".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"Exit".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"Fault".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"Heartbeat".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"LoginResponse".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"PhyDrive".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"PhyNetwork".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"PhyNode".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"PhyNodeSensors".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"PhyNvram".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"Role".*'</span><span class="pi">]</span>
</code></pre></div></div>

<p>In Logstash, we use the same Grok rule as above (and <code class="language-plaintext highlighter-rouge">overwrite</code> is optional - as we store fields and values under <code class="language-plaintext highlighter-rouge">sf_api</code>):</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">filter</span> <span class="p">{</span>
  <span class="n">grok</span> <span class="p">{</span>
    <span class="s2">"match"</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="s2">"message"</span> <span class="o">=&gt;</span> <span class="s1">'%{TIMESTAMP_ISO8601:iso8601_timestamp} %{IPV4} %{SYSLOGPROG:program}: %{GREEDYDATA:message}'</span> <span class="p">}</span>
    <span class="n">overwrite</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="s2">"message"</span> <span class="p">]</span>
 <span class="p">}</span>
 <span class="n">json</span> <span class="p">{</span>
   <span class="n">source</span> <span class="o">=&gt;</span> <span class="s2">"message"</span>
   <span class="n">target</span> <span class="o">=&gt;</span> <span class="s2">"sf_api"</span>
 <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This appears to work - searching for RestoreDeletedVolume:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sf_api.xClusterApiCall.Method : RestoreDeletedVolume
</code></pre></div></div>

<p><img src="/assets/images/elastic-solidfire-04-structured-json-search-01.png" alt="Structured query of message contents" /></p>

<p>All right, so this is sort-of-solved, although additional improvements are possible.</p>

<p>In next section let’s assume we didn’t do any filtering and logs from all SolidFire services have hit the same Elastic index set: we have to search unstructured logs (in “message” field).</p>

<h3 id="unstructured-logs">Unstructured Logs</h3>

<p>Assuming the above proves too overwhelming, we could just send everything to Elastic and try to create unstructured queries that work around those problems.</p>

<p>Even in this case, I’d recommend two steps:</p>

<ul>
  <li>Drop unnecessary lines in syslog or Filebeat or Logstash</li>
  <li>Create unstructured queries that search content in <code class="language-plaintext highlighter-rouge">messages</code></li>
</ul>

<p>As an example, Filebeat has <code class="language-plaintext highlighter-rouge">include_lines</code> and we could use it to pick only the useful lines from the logs. In my simple tests useful lines were 1% of the total.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">filestream</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">paths</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">/var/log/solidfire.log</span>
  <span class="na">include_lines</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">.*{"action":"ApiCall".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"Config".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"ConnectionState".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"Create".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"Event".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"Exit".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"Fault".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"Heartbeat".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"LoginResponse".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"PhyDrive".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"PhyNetwork".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"PhyNode".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"PhyNodeSensors".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"PhyNvram".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"Role".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">\[Event\]</span><span class="nv"> </span><span class="s">[[:digit:]]+'</span><span class="pi">,</span> <span class="s1">'</span><span class="nv"> </span><span class="s">\[MS\]</span><span class="nv"> </span><span class="s">[[:digit:]]+</span><span class="nv"> </span><span class="s">CFaultMon</span><span class="nv"> </span><span class="s">'</span><span class="pi">,</span> <span class="s1">'</span><span class="nv"> </span><span class="s">\[API\]</span><span class="nv"> </span><span class="s">[[:digit:]]+</span><span class="nv"> </span><span class="s">PionScheduler</span><span class="nv"> </span><span class="s">httpserver/RestAPIServer'</span><span class="pi">]</span>
</code></pre></div></div>

<p>If you want to spend an evening playing with this, you could split the above in two inputs, one with the JSON-based <code class="language-plaintext highlighter-rouge">action</code> stuff (like the above, just without non-action items) and one for <code class="language-plaintext highlighter-rouge">[Thing]</code>-based entries (example below)). In each we could have “fields.logtype” (see example below); the one above could be <code class="language-plaintext highlighter-rouge">sfapi</code>, the one below <code class="language-plaintext highlighter-rouge">sfevents</code>. Then try to process (filter) each type separately and send results to different indexes.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">filestream</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">paths</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">/var/log/solidfire.log</span>
  <span class="na">fields</span><span class="pi">:</span>
    <span class="na">logtype</span><span class="pi">:</span> <span class="s">sfevents</span>
  <span class="na">include_lines</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">\[Event\]</span><span class="nv"> </span><span class="s">[[:digit:]]+'</span><span class="pi">,</span> <span class="s1">'</span><span class="nv"> </span><span class="s">\[MS\]</span><span class="nv"> </span><span class="s">[[:digit:]]+</span><span class="nv"> </span><span class="s">CFaultMon</span><span class="nv"> </span><span class="s">'</span><span class="pi">,</span> <span class="s1">'</span><span class="nv"> </span><span class="s">\[API\]</span><span class="nv"> </span><span class="s">[[:digit:]]+</span><span class="nv"> </span><span class="s">PionScheduler</span><span class="nv"> </span><span class="s">httpserver/RestAPIServer'</span><span class="pi">]</span>
</code></pre></div></div>

<p>This didn’t work for me (it seems it was too simplistic; Filebeat maybe tracks just one file per instance), but I didn’t try any workarounds (such as running two Filebeat instances, each for one type, or using the more advanced pipeline functionality). If you can’t make it work either, just use the first filestream example that contains all <code class="language-plaintext highlighter-rouge">include_lines</code> that you’ll probably need.</p>

<p>In any case, let us assume we couldn’t split the log and now everything is in the same index group <code class="language-plaintext highlighter-rouge">logstash-*</code>. How can we query unstructured text inside <code class="language-plaintext highlighter-rouge">message</code> field (here even JSON is unstructured)?</p>

<p>Find CreateVolume actions can be found in Kibana (Analytics &gt; Discover) with:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>message: " [API] " AND message: "RestAPI::CreateVolume SUCCESS"
</code></pre></div></div>

<p>When looking for a particular volume name, use:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>message: " [API] " AND message: "RestAPI::CreateVolume SUCCESS" AND "\"name\":\"elastic\""
</code></pre></div></div>

<p><img src="/assets/images/elastic-solidfire-01-unstructured-query.png" alt="Unstructured query of message contents" /></p>

<p>Similarly, for <code class="language-plaintext highlighter-rouge">DeleteVolume</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>message: " [API] " AND message: "RestAPI::DeleteVolume SUCCESS"
</code></pre></div></div>

<p>It’s not terribly convenient, but it works. Save such queries (see that floppy disk icon in top left corner) without the name value so that, when you want to use them, you just fill in a volume name.</p>

<h4 id="searching-unstructured-logs">Searching Unstructured Logs</h4>

<p>One way is with trial &amp; error, just look at all message contents and search for a keyword - say, a snapshot I created:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>message: " elastic-snapshot"
</code></pre></div></div>

<p>You may get multiple lines back. Find the one you’re interested in, and add additional search criteria. Rinse &amp; repeat…</p>

<p>Another way is to go to SolidFire UI (Reporting &gt; Event Log, or Reporting &gt; Alerts depending if you’re looking for all events or just faults) and examine what fields you want to focus on (i.e. filter by). You can open this screenshot in new tab, but you don’t have to - the point is I figured it’s ApiEvent that I’m after.</p>

<p><img src="/assets/images/elastic-solidfire-03-unstructured-event-search-01.png" alt="Reference SolidFire events" /></p>

<p>Then improve your Kibana query to eliminate false positives:</p>

<p><img src="/assets/images/elastic-solidfire-03-unstructured-event-search-02.png" alt="Create query in Kibana" /></p>

<p>Final query to find non-scheduled <code class="language-plaintext highlighter-rouge">CreateSnapshot</code> activity related to the snapshot named elastic-snapshot:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>message: " master" and message: " [Event] " and not message: "\"action\":" and (message: "CreateSnapshot" and message: "type=ApiEvent" and message: "\"params\"{\"name\":\"elastic-snapshot\"}")
</code></pre></div></div>

<p>If you expect to do this often, save this query in Kibana:</p>

<p><img src="/assets/images/elastic-solidfire-03-unstructured-event-search-03.png" alt="Save query in Kibana" /></p>

<p>You can also examine SolidFire log on syslog server, just be careful with escape characters and wildcards because Kibana queries may require a different syntax:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat /var/log/solidfire.log | grep "\[Event\]" | grep "elastic-snapshot"
</code></pre></div></div>

<p>The above would result in finding the same snapshot (line breaks are mine, to make it easier to see):</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2021-10-18T05:01:23+00:00 192.168.1.33 master-1[5540]:
 <span class="o">[</span>Event] 8970 PionScheduler serviceshared/EventReporter.cpp:582:ReportEvent
 |Successfully reported <span class="nv">event</span><span class="o">={</span><span class="nb">id</span><span class="o">=</span>47307 <span class="nb">type</span><span class="o">=</span><span class="nv">ApiEventnodeID</span><span class="o">=</span>1 <span class="nv">message</span><span class="o">=</span>
 <span class="o">[</span>API Call <span class="o">(</span>CreateSnapshot<span class="o">)]</span> <span class="nv">details</span><span class="o">=</span>
 <span class="o">{</span><span class="s2">"context"</span>:<span class="o">{</span><span class="s2">"ip"</span>:<span class="s2">"192.168.1.12"</span>,<span class="s2">"user"</span>:<span class="s2">"admin"</span><span class="o">}</span>,
 <span class="s2">"method"</span>:<span class="s2">"CreateSnapshot"</span>,<span class="s2">"params"</span>:
 <span class="o">{</span><span class="s2">"name"</span>:<span class="s2">"elastic-snapshot"</span>,<span class="s2">"requestAPIVersion"</span>:<span class="s2">"11.0"</span>,<span class="s2">"retention"</span>:<span class="s2">"0:5:00"</span>,<span class="s2">"volumeID"</span>:484<span class="o">}</span>,
 <span class="s2">"success"</span>:true<span class="o">}</span> 
 <span class="nv">reported</span><span class="o">=</span>2021-10-18T05:01:23.480432Z 
 <span class="nv">published</span><span class="o">=</span>2021-10-18T05:01:23.480489Z<span class="o">}</span> 
 <span class="nv">mNumEventsPublished</span><span class="o">=</span>50
</code></pre></div></div>

<p>SolidFire node &amp; cluster faults (Reporting &gt; Alerts) are even easier to work with, because if we query for current (rather than all or resolved) faults, we won’t have to do much filtering - if no faults are found, you won’t get anything returned.</p>

<p>Status polling with <code class="language-plaintext highlighter-rouge">http_poller</code> (below) show how we can work with cluster faults using another ELK (Logstash, in this case) feature which results in structured data in Elasticsearch.</p>

<h2 id="status-polling-with-http_poller">Status Polling with http_poller</h2>

<p>Fed up with the log format challenges I examined <code class="language-plaintext highlighter-rouge">http_poller</code> plugin and hours later (just as I was also getting fed up with the Logstash documentation for the plugin), I made it work (see configuration and output samples in Appendix D).</p>

<p>I don’t do any filtering - it’s just in-and-out - but the responses are already structured well enough.</p>

<p><img src="/assets/images/elastic-solidfire-02-http-poller-logs.png" alt="http_poller of SolidFire cluster faults" /></p>

<p>I don’t know if you can make it out (in any case, you can see the contents in http-poller.conf in Appendix D), but we’re using <code class="language-plaintext highlighter-rouge">ListClusterFaults</code> and the answer is there’s two of them: (1) IOPS are overprovisioned, and (2) paired cluster is unreachable. (It’s a SolidFire Demo VM whose replication peer VM has been shut down.)</p>

<p>Upon seeing this we should fix these issues. They’d become resolved and disappear. Until such time you can create a chart that shows fault count and perhaps group them by severity.</p>

<p>When I said about the well-defined structure, I meant that we can easily get contents of each fault (<code class="language-plaintext highlighter-rouge">faults.code</code>), severity (<code class="language-plaintext highlighter-rouge">faults.severity)</code>, and other important details:</p>

<p><img src="/assets/images/elastic-solidfire-02-http-poller-fault-details.png" alt="http_poller structure of SolidFire fault" /></p>

<p>Don’t forget that this is just one of the many easy-to-use SolidFire API methods. You could get cluster capacity, cluster efficiency, volume capacity and other details this way: just copy-paste the example I provide and change <code class="language-plaintext highlighter-rouge">body</code> contents (use Postman with SolidFire Postman Collection for prototyping).</p>

<p>Security-wise <code class="language-plaintext highlighter-rouge">http_poller</code> should use a read-only, monitoring-type cluster administrator account, because it needs to access the API (MVIP). Comparatively speaking log forwarding is safer and probably has a shorter lag (<code class="language-plaintext highlighter-rouge">http_polller</code> runs once a minute), but these trade-offs could be acceptable for most environments (in highly secure environments we could drive this traffic through a restful HTTPS proxy to ensure only allowed Get and List methods are used).</p>

<h2 id="snmp-trap-monitoring">SNMP Trap Monitoring</h2>

<p>I didn’t have time to try <a href="https://www.elastic.co/guide/en/logstash/current/plugins-inputs-snmptrap.html#plugins-inputs-snmptrap-community">this one</a>, but it looks simple enough for fault and event monitoring.</p>

<p><code class="language-plaintext highlighter-rouge">http_poller</code> seems easier, but SNMP Traps are usually more secure from access perspective (SNMP Traps are “push”, and don’t require inbound access to SolidFire cluster admin account and Management network).</p>

<p>To prepare SolidFire, you’d enable SNMP and send SNMP Fault Traps and Resolved Fault Traps to Logstash service. I wrote several posts on SolidFire v11/v12 and SNMP - go to Archive and find SNMP on the page.</p>

<h2 id="creating-charts-and-visualizations">Creating Charts and Visualizations</h2>

<p>I’ll show two examples, one with structured logs and another with http_poller logs.</p>

<p>Using configuration from Structured Logs example (where only SolidFire log messages in the JSON format are sent to Elastic), we pick an event such as CreateSnapshot:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sf_api.xClusterEvent.Data.method: "CreateSnapshot"
</code></pre></div></div>

<p>Kibana &gt; Analytics &gt; Dashboard takes us to a place where we can visualize this information. Notice I picked <code class="language-plaintext highlighter-rouge">iso8601_timestamp</code> (extracted with Grok filter) from SolidFire logs rather than just <code class="language-plaintext highlighter-rouge">timestamp</code>.</p>

<p><img src="/assets/images/elastic-solidfire-05-structured-json-dashboard-01.png" alt="Chart showing number of Create Snapshot Events over time" /></p>

<p>Knowing the number of snapshot creates isn’t immensely useful, but you could watch something else (capacity, number of volumes, etc.) - just create a query that finds the information you need.</p>

<p>The second example uses http_poller with <code class="language-plaintext highlighter-rouge">ListVolumeStats</code> method. I created a donut chart that shows volumes’ IDs and relative sizes.</p>

<p><img src="/assets/images/elastic-solidfire-05-structured-json-dashboard-02.png" alt="Chart showing Volume Sizes" /></p>

<p>Notice I used <code class="language-plaintext highlighter-rouge">volumeStats.volumeID</code> and <code class="language-plaintext highlighter-rouge">volumeStats.volumeSize</code>. We’d change <code class="language-plaintext highlighter-rouge">volumeStats.volumeSize</code> to <code class="language-plaintext highlighter-rouge">volumeStats.volumeIOPS</code> or other field to visualize performance, or efficiency, or some other property.</p>

<h2 id="video-demo">Video Demo</h2>

<p>Find it <a href="https://youtu.be/kjQnGk06kic">here</a> (2m40s).</p>

<h2 id="conclusion">Conclusion</h2>

<p>I’ve created several video demos of SolidFire log redirection to Elastic, Graylog, and Splunk, but I’ve never had a reason to dive deeper into this.</p>

<p>I still don’t have all the answers, but I’d say this is close enough.</p>

<p><code class="language-plaintext highlighter-rouge">http_poller</code> looks very promising, especially given how good the SolidFire API is.</p>

<p>Some ideas for next steps (when I find time):</p>

<ul>
  <li>More advanced query examples</li>
  <li><del>Performance monitoring</del> (2021/10/19: added section with charts and visualizations)</li>
  <li><del>Develop additional examples with <code class="language-plaintext highlighter-rouge">http_poller</code></del> (2021/10/19: added performance monitoring example)</li>
</ul>

<p>Kudos to whoever at Elastic came up with the idea to create a Dev/Test mode that doesn’t force fascist security measures on people who just want to check some product functionality over the weekend.</p>

<h2 id="appendix-a-software-used">Appendix A: Software Used</h2>

<ul>
  <li>NetApp SolidFire 11.7 (12 behaves the same)
    <ul>
      <li>Self-signed CA &amp; TLS certificate</li>
    </ul>
  </li>
  <li>Ubuntu 20.04
    <ul>
      <li>syslog-ng 3.25</li>
      <li>ELK Stack 7.15.1</li>
    </ul>
  </li>
</ul>

<h2 id="appendix-b-structured-log-monitoring-notes">Appendix B: Structured Log Monitoring Notes</h2>

<ul>
  <li>filebeat.yml: grep syslog for actions and include those you want (example below) and eliminate the [MS], [API], [Event] and other stuff</li>
</ul>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">filestream</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">paths</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">/var/log/solidfire.log</span>
  <span class="na">fields</span><span class="pi">:</span>
    <span class="na">logtype</span><span class="pi">:</span> <span class="s">sfapi</span>
  <span class="na">include_lines</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">.*{"action":"ApiCall".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"Config".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"ConnectionState".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"Create".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"Event".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"Exit".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"Fault".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"Heartbeat".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"LoginResponse".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"PhyDrive".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"PhyNetwork".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"PhyNode".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"PhyNodeSensors".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"PhyNvram".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"Role".*'</span><span class="pi">]</span>
</code></pre></div></div>

<ul>
  <li>sf-pipe.conf used with Logstash:</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">input</span> <span class="p">{</span>
    <span class="n">beats</span> <span class="p">{</span>
        <span class="n">port</span> <span class="o">=&gt;</span> <span class="s2">"5044"</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="n">filter</span> <span class="p">{</span>
  <span class="n">grok</span> <span class="p">{</span>
    <span class="s2">"match"</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="s2">"message"</span> <span class="o">=&gt;</span> <span class="s1">'%{TIMESTAMP_ISO8601:iso8601_timestamp} %{IPV4} %{SYSLOGPROG:program}: %{GREEDYDATA:message}'</span> <span class="p">}</span>
    <span class="n">overwrite</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="s2">"message"</span> <span class="p">]</span>
 <span class="p">}</span>
 <span class="n">json</span> <span class="p">{</span>
   <span class="n">source</span> <span class="o">=&gt;</span> <span class="s2">"message"</span>
   <span class="n">target</span> <span class="o">=&gt;</span> <span class="s2">"sf_api"</span>
 <span class="p">}</span>
<span class="p">}</span>
<span class="n">output</span> <span class="p">{</span>
  <span class="n">elasticsearch</span> <span class="p">{</span> <span class="n">hosts</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s2">"192.168.1.202:9200"</span><span class="p">]</span> <span class="p">}</span>
  <span class="n">stdout</span> <span class="p">{</span> <span class="n">codec</span> <span class="o">=&gt;</span> <span class="n">rubydebug</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="appendix-c-unstructured-log-monitoring-notes">Appendix C: Unstructured Log Monitoring Notes</h2>

<ul>
  <li>Note that regular expressions in this section are not production-quality - on the contrary (in the case you can’t tell)</li>
  <li><code class="language-plaintext highlighter-rouge">[API]</code> logs contain the contents of all SolidFire RestAPI calls. I haven’t compared the contents of these lines vs. JSON-based logs, but it’s possible that we could get everything we need from <code class="language-plaintext highlighter-rouge">[API]</code>, <code class="language-plaintext highlighter-rouge">[MS]</code>, and <code class="language-plaintext highlighter-rouge">[Event]</code> entries</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2021-10-16T08:24:27+00:00 192.168.1.33 master-1[5540]: <span class="o">[</span>API] 8980 PionScheduler httpserver/RestAPIServer.cpp:281:LogAndDispatch|RestAPI::CreateVolume SUCCESS <span class="nv">result</span><span class="o">={</span><span class="s2">"curve"</span>:<span class="o">{</span><span class="s2">"1048576"</span>:15000,<span class="s2">"131072"</span>:1950,<span class="s2">"16384"</span>:270,<span class="s2">"262144"</span>:3900,<span class="s2">"32768"</span>:500,<span class="s2">"4096"</span>:100,<span class="s2">"524288"</span>:7600,<span class="s2">"65536"</span>:1000,<span class="s2">"8192"</span>:160<span class="o">}</span>,<span class="s2">"volume"</span>:<span class="o">{</span><span class="s2">"access"</span>:<span class="s2">"readWrite"</span>,<span class="s2">"accountID"</span>:9,<span class="s2">"attributes"</span>:<span class="o">{}</span>,<span class="s2">"blockSize"</span>:4096,<span class="s2">"createTime"</span>:<span class="s2">"2021-10-16T08:24:27Z"</span>,<span class="s2">"currentProtectionScheme"</span>:<span class="s2">"singleHelix"</span>,<span class="s2">"deleteTime"</span>:<span class="s2">""</span>,<span class="s2">"enable512e"</span>:true,<span class="s2">"enableSnapMirrorReplication"</span>:false,<span class="s2">"iqn"</span>:<span class="s2">"iqn.2010-01.com.solidfire:72k4.elastic.473"</span>,<span class="s2">"lastAccessTime"</span>:null,<span class="s2">"lastAccessTimeIO"</span>:null,<span class="s2">"name"</span>:<span class="s2">"elastic"</span>,<span class="s2">"previousProtectionScheme"</span>:null,<span class="s2">"purgeTime"</span>:<span class="s2">""</span>,<span class="s2">"qos"</span>:<span class="o">{</span><span class="s2">"burstIOPS"</span>:1000,<span class="s2">"burstTime"</span>:60,<span class="s2">"curve"</span>:<span class="o">{</span><span class="s2">"1048576"</span>:15000,<span class="s2">"131072"</span>:1950,<span class="s2">"16384"</span>:270,<span class="s2">"262144"</span>:3900,<span class="s2">"32768"</span>:500,<span class="s2">"4096"</span>:100,<span class="s2">"524288"</span>:7600,<span class="s2">"65536"</span>:1000,<span class="s2">"8192"</span>:160<span class="o">}</span>,<span class="s2">"maxIOPS"</span>:800,<span class="s2">"minIOPS"</span>:300<span class="o">}</span>,<span class="s2">"qosPolicyID"</span>:9,<span class="s2">"scsiEUIDeviceID"</span>:<span class="s2">"37326b34000001d9f47acc0100000000"</span>,<span class="s2">"scsiNAADeviceID"</span>:<span class="s2">"6f47acc10000000037326b34000001d9"</span>,<span class="s2">"sliceCount"</span>:0,<span class="s2">"status"</span>:<span class="s2">"active"</span>,<span class="s2">"totalSize"</span>:2000683008,<span class="s2">"virtualVolumeID"</span>:null,<span class="s2">"volumeAccessGroups"</span>:[],<span class="s2">"volumeConsistencyGroupUUID"</span>:<span class="s2">"121812ca-4477-4382-b06c-1f4e1483b9a0"</span>,<span class="s2">"volumeID"</span>:473,<span class="s2">"volumePairs"</span>:[],<span class="s2">"volumeUUID"</span>:<span class="s2">"5c854ba6-eeb7-4378-8f14-96c7839ca6a7"</span><span class="o">}</span>,<span class="s2">"volumeID"</span>:473<span class="o">}</span>
</code></pre></div></div>

<p>The above could be massaged to get the JSON part in the last group like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>((20[2-9][0-9])-[0,1][0-9]-[0-2][0-9]T[0-9]{1,2}:[0-9]{1,2}:[0-9]{1,2}\+[0-2][0-9]:[0-9][0-9] [0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3} master-[0-9]{0,1}\[[0-9]+]: \[API\] [0-9]{1,6} PionScheduler httpserver\/RestAPIServer.cpp:[0-9]{1,5}:LogAndDispatch|RestAPI::[a-zA-Z]+ SUCCESS result=)({*.*})
</code></pre></div></div>

<ul>
  <li>In the case of JSON-based logs, we could use regular expressions to extract the content of actual API call by looking under <code class="language-plaintext highlighter-rouge">xClusterApiCall</code>. This may be easier to do with Logstash JSON decode filters, but in the case you use it elsewhere.</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2021-10-17T02:59:35+00:00 192.168.1.33 master-1[5540]: <span class="o">{</span><span class="s2">"action"</span>:<span class="s2">"ApiCall"</span>,<span class="s2">"idg"</span>:<span class="s2">"940460905823515"</span>,<span class="s2">"idx"</span>:76909,<span class="s2">"system"</span>:<span class="s2">"Cluster"</span>,<span class="s2">"utc"</span>:<span class="s2">"2021-10-17T02:59:35.345599Z"</span>,<span class="s2">"ver"</span>:<span class="s2">"1.1"</span>,<span class="s2">"xClusterApiCall"</span>:<span class="o">{</span><span class="s2">"Method"</span>:<span class="s2">"ListSyncJobs"</span>,<span class="s2">"SourceIP"</span>:<span class="s2">"192.168.1.12"</span>,<span class="s2">"Threads"</span>:1,<span class="s2">"Time"</span>:4,<span class="s2">"Username"</span>:<span class="s2">"admin"</span><span class="o">}}</span>
</code></pre></div></div>

<p>Getting to nested JSON:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>((20[2-9][0-9])-[0,1][0-9]-[0-2][0-9]T[0-9]{1,2}:[0-9]{1,2}:[0-9]{1,2}\+[0-2][0-9]:[0-9][0-9] [0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3} master-[0-9]{0,1}\[[0-9]+]:.*)({\"action\":\"ApiCall\".*\"xClusterApiCall\":)({.*})
</code></pre></div></div>

<ul>
  <li>filebeat.yml for many-formats-one-log approach:</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">filebeat.inputs</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">filestream</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">paths</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">/var/log/solidfire.log</span>
  <span class="na">include_lines</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">.*{"action":"ApiCall".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"Config".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"ConnectionState".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"Create".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"Event".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"Exit".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"Fault".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"Heartbeat".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"LoginResponse".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"PhyDrive".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"PhyNetwork".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"PhyNode".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"PhyNodeSensors".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"PhyNvram".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">.*{"action":"Role".*'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">\[Event\]</span><span class="nv"> </span><span class="s">[[:digit:]]+'</span><span class="pi">,</span> <span class="s1">'</span><span class="nv"> </span><span class="s">\[MS\]</span><span class="nv"> </span><span class="s">[[:digit:]]+</span><span class="nv"> </span><span class="s">CFaultMon</span><span class="nv"> </span><span class="s">'</span><span class="pi">,</span> <span class="s1">'</span><span class="nv"> </span><span class="s">\[API\]</span><span class="nv"> </span><span class="s">[[:digit:]]+</span><span class="nv"> </span><span class="s">PionScheduler</span><span class="nv"> </span><span class="s">httpserver/RestAPIServer'</span><span class="pi">]</span>
<span class="na">filebeat.config.modules</span><span class="pi">:</span>
  <span class="na">path</span><span class="pi">:</span> <span class="s">${path.config}/modules.d/*.yml</span>
  <span class="na">reload.enabled</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">reload.period</span><span class="pi">:</span> <span class="s">10s</span>
<span class="na">setup.template.settings</span><span class="pi">:</span>
  <span class="na">index.number_of_shards</span><span class="pi">:</span> <span class="m">1</span>
<span class="na">setup.kibana</span><span class="pi">:</span>
  <span class="na">host</span><span class="pi">:</span> <span class="s2">"</span><span class="s">192.168.1.202:5601"</span>
<span class="na">output.logstash</span><span class="pi">:</span>
  <span class="na">hosts</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">192.168.1.202:5044"</span><span class="pi">]</span>
<span class="na">processors</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">add_host_metadata</span><span class="pi">:</span>
      <span class="na">when.not.contains.tags</span><span class="pi">:</span> <span class="s">forwarded</span>
  <span class="pi">-</span> <span class="na">add_cloud_metadata</span><span class="pi">:</span> <span class="s">~</span>
  <span class="pi">-</span> <span class="na">add_docker_metadata</span><span class="pi">:</span> <span class="s">~</span>
  <span class="pi">-</span> <span class="na">add_kubernetes_metadata</span><span class="pi">:</span> <span class="s">~</span>
<span class="na">logging.level</span><span class="pi">:</span> <span class="s">debug</span>
<span class="na">logging.selectors</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">beat"</span><span class="pi">]</span>
</code></pre></div></div>

<ul>
  <li>Logstash with sf-pipeline.conf (running on the same node as Filebeat and Elasticsearch) for many-formats-one-log (unstructured) approach:</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">input</span> <span class="p">{</span>
    <span class="n">beats</span> <span class="p">{</span>
        <span class="n">port</span> <span class="o">=&gt;</span> <span class="s2">"5044"</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="n">output</span> <span class="p">{</span>
  <span class="n">elasticsearch</span> <span class="p">{</span> <span class="n">hosts</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s2">"192.168.1.202:9200"</span><span class="p">]</span> <span class="p">}</span>
  <span class="n">stdout</span> <span class="p">{</span> <span class="n">codec</span> <span class="o">=&gt;</span> <span class="n">rubydebug</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="appendix-d-http_polling-examples">Appendix D: http_polling Examples</h2>

<ul>
  <li>Configuration
    <ul>
      <li>If your SolidFire uses the “default” TLS certificate, <code class="language-plaintext highlighter-rouge">http_poller</code> won’t work. You can use Postman to upload certificate with (see <a href="/2020/11/24/scary-bs-postman-ssl-certs.html">here</a>)</li>
      <li>You’d need to create and upload a new one. If you created a valid TLS certificate, that’ll work; if you create a self-signed TLS certificate, you’ll need a truststore</li>
      <li>See the Logstash documentation for the truststore steps; sadly there’s no <code class="language-plaintext highlighter-rouge">--insecure</code> or such to let us save time</li>
    </ul>
  </li>
  <li>Upload your TLS certificate to SolidFire MVIP (no need to remove delimiters in PEM and key files, just <code class="language-plaintext highlighter-rouge">cat</code> their content, and paste the content of each between the appropriate double quotes):</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w"> 
    </span><span class="nl">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"SetSSLCertificate"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"params"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    	</span><span class="nl">"certificate"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;TLS Certificate&gt;"</span><span class="p">,</span><span class="w">
    	</span><span class="nl">"privateKey"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;TLS Cert's Private Key&gt;"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>http_poller.conf:</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">input</span> <span class="p">{</span>
  <span class="n">http_poller</span> <span class="p">{</span>
    <span class="n">urls</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="n">getfaults</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nb">method</span> <span class="o">=&gt;</span> <span class="no">POST</span>
        <span class="n">user</span> <span class="o">=&gt;</span> <span class="s2">"monitor"</span>
        <span class="n">password</span> <span class="o">=&gt;</span> <span class="s2">"p@ssword"</span>
        <span class="n">body</span> <span class="o">=&gt;</span> <span class="s1">'{"method":"ListClusterFaults","params":{"bestPractices":false,"faultTypes":"current"}}'</span>
        <span class="n">codec</span> <span class="o">=&gt;</span> <span class="s2">"json"</span>
        <span class="n">url</span> <span class="o">=&gt;</span> <span class="s2">"https://192.168.1.34/json-rpc/11.7"</span>
        <span class="n">headers</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="s2">"Accept"</span> <span class="o">=&gt;</span> <span class="s2">"application/json"</span>
          <span class="s2">"Content-Type"</span> <span class="o">=&gt;</span> <span class="s2">"application/json"</span> 
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">truststore</span> <span class="o">=&gt;</span> <span class="s2">"/etc/logstash/tls/downloaded_truststore.jks"</span>
    <span class="n">truststore_password</span> <span class="o">=&gt;</span> <span class="s2">"123456"</span>
    <span class="n">request_timeout</span> <span class="o">=&gt;</span> <span class="mi">30</span>
    <span class="n">schedule</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">cron</span> <span class="o">=&gt;</span> <span class="s2">"* * * * * UTC"</span><span class="p">}</span>
    <span class="n">metadata_target</span> <span class="o">=&gt;</span> <span class="s2">"http_poller_metadata"</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="n">output</span> <span class="p">{</span>
  <span class="n">elasticsearch</span> <span class="p">{</span> <span class="n">hosts</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s2">"192.168.1.202:9200"</span><span class="p">]</span> <span class="p">}</span>
  <span class="n">stdout</span> <span class="p">{</span> <span class="n">codec</span> <span class="o">=&gt;</span> <span class="n">rubydebug</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">http_poller</code> in action:</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
</span><span class="s2">"result"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"faults"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w">
                               </span><span class="s2">"data"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="err">nil</span><span class="p">,</span><span class="w">
                               </span><span class="s2">"date"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="s2">"2021-09-09T08:48:09.561100Z"</span><span class="p">,</span><span class="w">
                           </span><span class="s2">"resolved"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
                       </span><span class="s2">"resolvedDate"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
                           </span><span class="s2">"severity"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="s2">"warning"</span><span class="p">,</span><span class="w">
                               </span><span class="s2">"type"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="s2">"cluster"</span><span class="p">,</span><span class="w">
                      </span><span class="s2">"blocksUpgrade"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
                           </span><span class="s2">"driveIDs"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="p">[],</span><span class="w">
                     </span><span class="s2">"externalSource"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
                             </span><span class="s2">"nodeID"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
                </span><span class="s2">"nodeHardwareFaultID"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
                            </span><span class="s2">"details"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="s2">"The sum of all minimum QoS IOPS (5300) is greater than the expected IOPS (3000) of the cluster. The minimum QoS can not be maintained for all volumes simultaneously in this condition. Adjust QoS settings on one or more volumes to not exceed available cluster IOPS."</span><span class="p">,</span><span class="w">
                            </span><span class="s2">"driveID"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
                   </span><span class="s2">"networkInterface"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
                     </span><span class="s2">"clusterFaultID"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="mi">58</span><span class="p">,</span><span class="w">
                               </span><span class="s2">"code"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="s2">"clusterIOPSAreOverProvisioned"</span><span class="p">,</span><span class="w">
                          </span><span class="s2">"serviceID"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w">
                               </span><span class="s2">"data"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="err">nil</span><span class="p">,</span><span class="w">
                               </span><span class="s2">"date"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="s2">"2021-10-16T07:55:22.368962Z"</span><span class="p">,</span><span class="w">
                           </span><span class="s2">"resolved"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
                       </span><span class="s2">"resolvedDate"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
                           </span><span class="s2">"severity"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="s2">"warning"</span><span class="p">,</span><span class="w">
                               </span><span class="s2">"type"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="s2">"cluster"</span><span class="p">,</span><span class="w">
                      </span><span class="s2">"blocksUpgrade"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
                           </span><span class="s2">"driveIDs"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="p">[],</span><span class="w">
                     </span><span class="s2">"externalSource"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
                             </span><span class="s2">"nodeID"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
                </span><span class="s2">"nodeHardwareFaultID"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
                            </span><span class="s2">"details"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="s2">"One of the clusters in a pair may have become misconfigured or disconnected.  Remove the local pairing and retry pairing the clusters. Disconnected Cluster Pairs: [11]. Misconfigured Cluster Pairs: []"</span><span class="p">,</span><span class="w">
                            </span><span class="s2">"driveID"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
                   </span><span class="s2">"networkInterface"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
                     </span><span class="s2">"clusterFaultID"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="mi">67</span><span class="p">,</span><span class="w">
                               </span><span class="s2">"code"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="s2">"disconnectedClusterPair"</span><span class="p">,</span><span class="w">
                          </span><span class="s2">"serviceID"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">]</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"http_poller_metadata"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="s2">"name"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="s2">"getfaults"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"response_headers"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
                                        </span><span class="s2">"date"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="s2">"Mon, 18 Oct 2021 01:07:00 GMT"</span><span class="p">,</span><span class="w">
                                      </span><span class="s2">"server"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="s2">"nginx"</span><span class="p">,</span><span class="w">
                                </span><span class="s2">"content-type"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="s2">"application/json"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"access-control-allow-headers"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="s2">"DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization"</span><span class="p">,</span><span class="w">
                                        </span><span class="s2">"vary"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="s2">"Accept-Encoding"</span><span class="p">,</span><span class="w">
                                  </span><span class="s2">"connection"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="s2">"keep-alive"</span><span class="p">,</span><span class="w">
                           </span><span class="s2">"transfer-encoding"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="s2">"chunked"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"access-control-allow-methods"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="s2">"GET, POST, OPTIONS"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"access-control-allow-credentials"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="s2">"true"</span><span class="w">
        </span><span class="p">},</span><span class="w">
           </span><span class="s2">"times_retried"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
                 </span><span class="s2">"request"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
             </span><span class="s2">"method"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="s2">"post"</span><span class="p">,</span><span class="w">
              </span><span class="s2">"codec"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="s2">"json"</span><span class="p">,</span><span class="w">
               </span><span class="s2">"body"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="s2">"{</span><span class="se">\"</span><span class="s2">method</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">ListClusterFaults</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">params</span><span class="se">\"</span><span class="s2">:{</span><span class="se">\"</span><span class="s2">bestPractices</span><span class="se">\"</span><span class="s2">:false,</span><span class="se">\"</span><span class="s2">faultTypes</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">current</span><span class="se">\"</span><span class="s2">}}"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"url"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="s2">"https://192.168.1.34/json-rpc/11.7"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"headers"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
                      </span><span class="s2">"Accept"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="s2">"application/json"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"Content-Type"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="s2">"application/json"</span><span class="w">
            </span><span class="p">},</span><span class="w">
               </span><span class="s2">"auth"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
                 </span><span class="s2">"user"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="s2">"admin"</span><span class="p">,</span><span class="w">
                 </span><span class="s2">"pass"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="s2">"admin"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"eager"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="kc">true</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="s2">"response_message"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="s2">"OK"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"code"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"host"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="s2">"es1"</span><span class="p">,</span><span class="w">
         </span><span class="s2">"runtime_seconds"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="mf">0.423885</span><span class="w">
    </span><span class="p">},</span><span class="w">
                      </span><span class="s2">"id"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="err">nil</span><span class="p">,</span><span class="w">
              </span><span class="s2">"@timestamp"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="mi">2021-10-18</span><span class="err">T</span><span class="mi">01</span><span class="err">:</span><span class="mi">07</span><span class="err">:</span><span class="mi">0</span><span class="mf">0.764</span><span class="err">Z</span><span class="p">,</span><span class="w">
                </span><span class="s2">"@version"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="s2">"1"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>http_poller for volume capacity and performance statistics:</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">input</span> <span class="p">{</span>
  <span class="n">http_poller</span> <span class="p">{</span>
    <span class="n">urls</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="n">getfaults</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nb">method</span> <span class="o">=&gt;</span> <span class="no">POST</span>
        <span class="n">user</span> <span class="o">=&gt;</span> <span class="s2">"monitor"</span>
        <span class="n">password</span> <span class="o">=&gt;</span> <span class="s2">"p@ssw0rd"</span>
        <span class="n">body</span> <span class="o">=&gt;</span> <span class="s1">'{"method":"ListVolumeStats"}'</span>
        <span class="n">codec</span> <span class="o">=&gt;</span> <span class="s2">"json"</span>
        <span class="n">url</span> <span class="o">=&gt;</span> <span class="s2">"https://192.168.1.34/json-rpc/11.7"</span>
        <span class="n">headers</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="s2">"Accept"</span> <span class="o">=&gt;</span> <span class="s2">"application/json"</span>
          <span class="s2">"Content-Type"</span> <span class="o">=&gt;</span> <span class="s2">"application/json"</span> 
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">truststore</span> <span class="o">=&gt;</span> <span class="s2">"/etc/logstash/tls/downloaded_truststore.jks"</span>
    <span class="n">truststore_password</span> <span class="o">=&gt;</span> <span class="s2">"123456"</span>
    <span class="n">request_timeout</span> <span class="o">=&gt;</span> <span class="mi">30</span>
    <span class="n">schedule</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">cron</span> <span class="o">=&gt;</span> <span class="s2">"* * * * * UTC"</span><span class="p">}</span>
    <span class="n">metadata_target</span> <span class="o">=&gt;</span> <span class="s2">"http_poller_metadata"</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="n">filter</span> <span class="p">{</span>
  <span class="nb">split</span> <span class="p">{</span>
    <span class="n">field</span> <span class="o">=&gt;</span> <span class="s2">"[result][volumeStats]"</span>
  <span class="p">}</span>  
<span class="p">}</span> 
</code></pre></div></div>

      </article>
    </div>
    
      <div class="categories">
    <span><p>Categories:</p>
    
    
      <a href="
      /categories/#solidfire">solidfire</a>
      &nbsp; 
    
      <a href="
      /categories/#automation">automation</a>
       
    
  </span>
</div>
    

  
    <div>
      <h3>Related Posts</h3>
      <ul>
      
        <li><a href="/2022/03/06/elastic-elk-stack-on-netapp.html">Elasticsearch 8 with NetApp storage</a></li>
      
        <li><a href="/2021/10/20/sgac-storagegrid-audit-log-converter-v0.2.1.html">SGAC v0.2.1</a></li>
      
        <li><a href="/2023/08/01/fscrawler-filesystem-analytics-elasticsearch.html">FSCrawler for basic filesystem analytics in Elasticsearch</a></li>
      
        <li><a href="/2023/02/25/elasticsearch-eseries-performance.html">Elasticsearch performance with E-Series</a></li>
      
        <li><a href="/2021/01/04/elasticsearch-on-netapp-h615c-ef280.html">Elasticsearch on NetApp HCI H615C with EF-Series EF280</a></li>
      
      </ul>
    </div>
  

    
  </div><footer class= "footer">
    <p>2025-05-21 13:16 </p>
    <p>Copyright © 2025 scaleoutSean. Content is released under the CC BY license. Design: Alessio Franceschi</p>
</footer>

</body>
</html>
